define(["ekhil/view/AEldar","lib/HTMLHelper","lib/Utils","lib/TextHelper","lib/PositionHelper","ekhil/EkhilPlayer"],function(e,t,s,i,n,r){return e.extend({init:function(e,i,n){this._super.apply(this,arguments),this.params=this.getParamsFromXML(e),this.screenWidth=i,this.screenHeight=n,this.CHK_WIDTH=22,this.CHK_HEIGHT=15,this.eldar._showGood=!1,this.eldar._showBad=!1,this.eldar._showMissed=!1,this._aAnswer=[],this._frontChecks=$("<div />"),this.eldar.append(this._frontChecks),this._frontClick=$("<div />"),this.eldar.append(this._frontClick),this._backImage=new t("image",{src:this.params.content.image.src,w:this.params.width,h:this.params.height,proportional:!!+this.params.elfe.proportional,streched:!!+this.params.elfe.streched,screenWidth:i,screenHeight:n}).getElement(),$(this._backImage).bind("onLoadInit",s.relegate(this,this.onImageLoadEvent)),this.eldar.prepend(this._backImage),$(this._frontClick).bind("click",s.relegate(this,this.onMouseDownEvent)),$(this.eldar).data("refresh",this.refresh)},getParamsFromXML:function(e){var t=e.querySelector("content"),s=t.querySelector("zones"),i=[],n=0;if(s){var h=s.querySelectorAll("zone"),o=h.length;s.attributes.nb&&(n=+s.attributes.nb.value);for(var a=0;a<o;a++){var c=h[a];i.push(this.parseXMLAttributes(c))}}var l=t.querySelector("image"),p=!1;if(l){var d=l?l.getAttribute("id"):"",_=t.querySelector('link[id="'+d+'"]'),f=r.getInstance().getMediaPath(_.getAttribute("value")),g={width:void 0!=l.attributes.width?l.getAttribute("width"):0,height:void 0!=l.attributes.height?l.getAttribute("height"):0,src:f};l.hasAttribute("restrictZone")&&(p="1"==l.getAttribute("restrictZone"))}else var g={width:0,height:0,src:""};var u=e.querySelector("design"),m=this.parseXMLAttributes(u),w={};for(var v in m)/^file/.test(v)&&void 0!=m[v]&&""!=m[v]?w[v]=require("ekhil/EkhilPlayer").getInstance().getMediaPath(m[v]):w[v]=m[v];return{content:{image:{src:g.src,width:g.width,height:g.height},nbZones:n,zones:i,restrictZone:p},elfe:{streched:w.streched,proportional:w.proportional,file_check:w.file_check,color_check:w.color_check,file_good:w.file_good,goodcolor:w.goodcolor,file_bad:w.file_bad,badcolor:w.badcolor},width:w.width,height:w.height,top:w.top,left:w.left}},refresh:function(){this._frontChecks.html(""),$(this.eldar).show();for(var e=this.params.content.zones.length,t=0;t<e;t++)this.params.content.zones[t].checked=!1;if(this._aAnswer=[],""!=this.response)for(var s=this.response.split(";"),e=s.length,t=0;t<e;t++){var i=s[t].split(","),n={x:i[0],y:i[1]};this._aAnswer.push(n),this.addNewCheck(t)}},hitTest:function(e,t){for(var s=this.params.content.zones.length,i=0;i<s;i++){var n=this.params.content.zones[i],r=n.left*this._frontChecks.width()/100,h=n.top*this._frontChecks.height()/100,o=r+n.width*this._frontChecks.width()/100,a=h+n.height*this._frontChecks.height()/100;if(e>=r&&e<=o&&t>=h&&t<=a)return i}return null},isValidFileName:function(e){return null!=e&&""!=e},computeCheckVisualProperties:function(e,t,s,i,n,r,h,o,a,c,l){this.isValidFileName(h)?l.sFile=h:l.sColor=c,e&&1==s&&!i&&(this.isValidFileName(r)?l.sFile=r:l.sColor=a),e||1!=t||(this.isValidFileName(n)?l.sFile=n:l.sColor=o)},addNewCheck:function(e){var s,i,n=this.hitTest(this._aAnswer[e].x,this._aAnswer[e].y),r=this;null!=n&&(this.params.content.zones[n].checked=!0);var h=null==this.params.content.zones[n];h||(h=null==this.params.content.zones[n].score),h||(h=0==this.params.content.zones[n].score);var o={sFile:s,sColor:i};this.computeCheckVisualProperties(h,this.eldar._showGood,this.eldar._showBad,this.isCorrected,this.params.elfe.file_good,this.params.elfe.file_bad,this.params.elfe.file_check,this.params.elfe.goodcolor,this.params.elfe.badcolor,this.params.elfe.color_check,o),s=o.sFile,i=o.sColor;var a=$("<div />").css({position:"absolute",display:"none"});if(null==s){var c=$("<canvas />").attr({width:this.CHK_WIDTH,height:this.CHK_HEIGHT}),l=c[0].getContext("2d");l.moveTo(0,0),l.beginPath(),l.moveTo(this.CHK_WIDTH/10,7*this.CHK_HEIGHT/10),l.lineTo(4*this.CHK_WIDTH/10,this.CHK_HEIGHT),l.lineTo(this.CHK_WIDTH,0),l.strokeStyle=i,l.fillStyle=i,l.lineWidth=5,l.stroke(),this._aAnswer[e].type="tick",$(a).css({left:this._aAnswer[e].x-this.CHK_WIDTH/2,top:this._aAnswer[e].y-this.CHK_HEIGHT/2,width:this.CHK_WIDTH,height:this.CHK_HEIGHT}),a.append(c),a.show()}else{var p=new t("image",{src:s,proportional:!0,streched:!1}).getElement();$(p).bind("onLoadInit",function(){var t=$("img",this).get(0).width,s=$("img",this).get(0).height;$(a).css({left:r._aAnswer[e].x-+t/2,top:r._aAnswer[e].y-+s/2}),$(a).show()}),a.append(p),this._aAnswer[e].type="file"}this._aAnswer[e].zone=n,this._aAnswer[e].clip=a,this._frontChecks.append(a)},onMouseDownEvent:function(e){var t,s=this.player.container.getScale(),i=n.offset(e.target).left,r=n.offset(e.target).top,h=e.touches?e.touches.item(0):e,o=h.pageX/s-i,a=h.pageY/s-r,c=!0;if(1==this.params.content.nbZones&&this._aAnswer.length)t=0;else for(var l=0;l<this._aAnswer.length&&void 0===t;l++){var p=!0,d=$("img",this._aAnswer[l].clip).get(0);d||(d=$("canvas",this._aAnswer[l].clip).get(0)),p=p&&o>=+this._aAnswer[l].x-d.width/2,p=p&&o<=+this._aAnswer[l].x+d.width/2,p=p&&a>=+this._aAnswer[l].y-d.height/2,p=p&&a<=+this._aAnswer[l].y+d.height/2,p&&(c=!1,t=l)}if(void 0!=t){var _=this._aAnswer[t].zone;this._aAnswer[t].clip.remove(),this._aAnswer.splice(t,1),null!=_&&(this.params.content.zones[_].checked=!this.isZoneEmpty(_))}if(c&&(!this.params.content.restrictZone||null!=this.hitTest(o,a))&&(0==this.params.content.nbZones||this.params.content.nbZones>this._aAnswer.length)&&o>=0&&a>=0&&o<=$(this._backImage).width()&&a<=$(this._backImage).height()){var f={x:o,y:a};1==this.params.content.nbZones&&null!=this._aAnswer[0]&&(null!=this._aAnswer[0].zone&&(this.params.content.zones[this._aAnswer[0].zone].checked=!1),this._aAnswer[0].clip.remove(),this._aAnswer=new Array),this._aAnswer.push(f),this.addNewCheck(this._aAnswer.length-1)}},onImageLoadEvent:function(){var e={position:"absolute",left:$(this._backImage).children("img").css("left"),top:$(this._backImage).children("img").css("top"),width:$(this._backImage).children("img").get(0).width+"px",height:$(this._backImage).children("img").get(0).height+"px"};this._frontChecks.css(e),this._frontClick.css(e)},getAnswer:function(){for(var e={MCQPic:[]},t=0;t<this._aAnswer.length;t++)e.MCQPic.push({x:this._aAnswer[t].x,y:this._aAnswer[t].y});return JSON.stringify(e)},setAnswer:function(e){this.response=e,null==this.response&&(this.response="");try{var t=JSON.parse(this.response);this.response="";var s=[];for(var i in t.MCQPic)s.push(t.MCQPic[i].x+","+t.MCQPic[i].y);this.response=s.join(";")}catch(n){}},getScore:function(){var e=0;if(0==this.params.content.nbZones){for(var t=0,s=this.params.content.zones.length,i=0;i<s;i++)+this.params.content.zones[i].score>0?(t++,1==this.params.content.zones[i].checked&&e++):1==this.params.content.zones[i].checked&&e--;for(var s=this._aAnswer.length,i=0;i<s;i++)void 0!=this._aAnswer[i].zone&&null!=this._aAnswer[i].zone||e--;0==t&&(0==e&&(e=1),t=1),e=Math.max(0,+(100*e/t))}else{for(var s=this.params.content.zones.length,i=0;i<s;i++)1==this.params.content.zones[i].checked&&(e+=Number(this.params.content.zones[i].score));e=Math.min(100,e)}return e},getInteraction:function(){return this._super()},student_response_text:function(){for(var e="",t="[,]",s=this.params.content.zones.length,i=0;i<s;i++)this.params.content.zones[i].checked&&(e+=(""!=e?t:"")+i);return e},correct_response_text:function(){for(var e="",t="[,]",s=0,i=this.params.content.zones.slice(),n=i.length,r=0;r<n;r++)+i[r].score>0&&(s<+this.params.content.nbZones||0==+this.params.content.nbZones)&&(e+=(""!=e?t:"")+r,s++);return e},correct_response:function(){return this.correct_response_text()},student_response:function(){return this.student_response_text()},tellCorrectAnswer:function(){this._super();for(var e=this.params.content.nbZones,t=0==this.params.content.nbZones,s=0,i=[],n=this.params.content.zones.length,r=0;r<n;r++)i.push(this.params.content.zones[r]),1==t&&0!=Number(this.params.content.zones[r].score)&&e++,i[r].num=r;var h=function(e,t){return+e.score>+t.score?-1:+e.score<+t.score?1:0};i.sort(h);var o=[];do{var a=i[s],c=a.left*this._frontChecks.width()/100,l=a.top*this._frontChecks.height()/100;c+=a.width*this._frontChecks.width()/200,l+=a.height*this._frontChecks.height()/200,o.push(c+","+l),s++,e--}while(e>0);this.response=o.join(";")},tellEraseAnswer:function(){this.response=""},tellEraseBadAnswer:function(){null==this.response&&(this.response="");for(var e=this.response.split(";"),t=e.length,s=t-1;s>=0;s--){var i=e[s].split(","),n={x:i[0],y:i[1]},r=this.hitTest(n.x,n.y),h=null==r||void 0==r;h||(h=void 0==this.params.content.zones[r]||null==this.params.content.zones[r]),h||(h=0==Number(this.params.content.zones[r].score)),h&&e.splice(s,1)}this.response=e.join(";")},isZoneEmpty:function(e){var t=this._aAnswer.filter(function(t){return t.zone===e});return!(t.length>0)}})});