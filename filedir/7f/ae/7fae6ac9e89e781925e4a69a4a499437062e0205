define(["ekhil/view/AEldar","lib/Utils","lib/HTMLHelper","lib/CssHelper","ekhil/model/Course"],function(AEldar,Utils,HTMLHelper,CssHelper,Course){return AEldar.extend({params:{},init:function(e){this._super.apply(this,arguments),this.params=this.getParamsFromXML(e);var t=this.params.elfe.input,r=$("<div/>");return r._showGood=!1,r._showBad=!1,r._showMissed=!1,r._answer,r._score_nil=!1,r._answer_replace="",r.OR=" || ",r.AND=" && ",r.MULTICHAR="*",r.SINGLECHAR="?",r.FUNCTION_FIND="this.findWord(word)",r.FUNCTION_REPLACE="this.findReplace(word, color)",r.input=$('<div contenteditable="true" >').css({borderWidth:t.border?"1px":"0px",borderStyle:"solid",borderColor:t.bordercolor,backgroundColor:t.transparent?"transparent":t.bgcolor,display:"block",fontFamily:t.font,fontSize:CssHelper.checkUnity(t.fontsize,"px"),color:t.fontcolor,fontStyle:t.italic?"italic":"normal",fontWeight:t.bold?"bold":"normal",textDecoration:t.underline?"underline":"none",cursor:"text",width:"100%",height:"100%",position:"absolute",webkitUserSelect:"auto"}),t.scrollbar?r.input.addClass("scrollable"):r.input.css("overflow","hidden"),this.answer=r.input.html(),r.input.on("keyup",function(){r.input.html()!=this.answer&&(this.answer=r.input.html())}.bind(this)),this.player.container.addInputListeners(r.input),$(r).append(r.input),$(r).data("refresh",r.refresh),this.eldar=r,r},getParamsFromXML:function(e){for(var t=e.querySelector("content"),r=t.querySelector("words"),s=r.querySelectorAll("word"),n=s.length,i=[],o=0;o<n;o++){var a=s[o];i.push({score:void 0!==a.attributes.score?+a.attributes.score.value:0,content:a.textContent})}var l=e.querySelector("design"),c=this.parseXMLAttributes(l);return{content:{cursor:!!+r.attributes.cursor.value,nb:isNaN(+r.attributes.nb.value)?0:+r.attributes.nb.value,case_sensitive:void 0!==r.attributes.case_sensitive&&"1"==r.attributes.case_sensitive.value,words:i},elfe:{input:{font:c.font,fontsize:c.fontsize,bold:!!+c.bold,italic:!!+c.italic,underline:!!+c.underline,align:c.align,fontcolor:c.fontcolor,border:!!+c.border,bordercolor:c.bordercolor,transparent:!!+c.transparent,bgcolor:c.bgcolor,scrollbar:!!+c.scrollbar,goodcolor:c.goodcolor,badcolor:c.badcolor}}}},isCaseSensitive:function(){var e="";return this.params.content.case_sensitive||(e="i"),e},findWord:function(e){var t=new RegExp(this.getCleanWord(e),"g"+this.isCaseSensitive());return t.test(this.eldar._answer_replace)},getCleanWord:function(e){var t=e.replace(new RegExp("\\?","g"),"[^\\s]{1}");return t=t.replace(new RegExp("\\*","g"),"[^\\s]+"),t=$.trim(t),e.indexOf(this.eldar.MULTICHAR,e.length-1)!=-1&&(t=t.slice(0,-1),t+="*"),t},findReplace:function(e,t){if(this.findWord(e)){for(var r,s=new RegExp(this.getCleanWord(e),"g"+this.isCaseSensitive()),n={};null!=(r=s.exec(this.eldar._answer_replace))&&"*"!=e;)n[r[0]]="";for(var r in n){var s=new RegExp(r,"gi"),i='<span style="color:'+t+'">'+r+"</span><br/>";this.eldar._answer_replace=this.eldar._answer_replace.replace(s,i)}}},addFunction:function(e,t,r){if(e=e.replace(new RegExp("'","g"),"\\'"),t){var s=this.eldar.FUNCTION_REPLACE.replace("word","'"+e+"'");return s.replace("color","'"+r+"'")}return this.eldar.FUNCTION_FIND.replace("word","'"+e+"'")},transformExpression:function(e,t,r){for(var s="",n=0,i=e.length;n<i;)if(e.indexOf(this.eldar.OR,n)!=-1){var o=e.indexOf(this.eldar.OR,n),a=e.substr(n,o-n);s+=this.addFunction(a,t,r)+" || ",n=e.indexOf(this.eldar.OR,n)+this.eldar.OR.length}else if(e.indexOf(this.eldar.AND,n)!=-1){var o=e.indexOf(this.eldar.AND,n),a=e.substr(n,o-n);s+=this.addFunction(a,t,r)+" && ",n=e.indexOf(this.eldar.AND,n)+this.eldar.AND.length}else{var o=e.length,a=e.substr(n,o-n);s+=this.addFunction(a,t,r),n=i}return s},getAnswer:function(){var e={};return e[this.type]=this.answer,e.nil_score=this.eldar._score_nil?1:0,JSON.stringify(e)},setAnswer:function(e){if(this._super(),this.tellEraseAnswer(),e)try{this.answer=JSON.parse(e)[this.type]||JSON.parse(e)[this.type.toLowerCase()]}catch(t){this.answer=e}$(this.eldar.input).html(this.answer)},refresh:function(){this.showContent(),$(this.eldar).show()},showContent:function showContent(){this.eldar._answer_replace=$(this.eldar.input).html();var nTotal=0;if((this.eldar._showGood||this.eldar._showBad)&&(nTotal=Math.min(this.params.content.nb,this.params.content.words.length)),this.eldar._showGood&&!this.isCorrected)for(var expressions_count=this.params.content.words.length,i=0;i<expressions_count;i++){var expression=this.params.content.words[i];expression.score==-1&&nTotal==-1||eval(this.transformExpression(expression.content,!0,this.params.elfe.input.goodcolor))}if(this.eldar._showBad&&!this.isCorrected)for(var expressions_count=this.params.content.words.length,i=0;i<expressions_count;i++){var expression=this.params.content.words[i];expression.score==-1&&eval(this.transformExpression(expression.content,!0,this.params.elfe.input.badcolor))}$(this.eldar.input).html(this.eldar._answer_replace)},getScore:function getScore(){var buffer=0,result=0;this.eldar._answer_replace=$(this.eldar.input).text();var total=Math.min(this.params.content.nb,this.params.content.words.length),expressions=[],expressions_count=this.params.content.words.length;if(total==-1)for(var i=0;i<expressions_count;i++)this.params.content.words[i].score==-1?expressions.splice(0,0,this.params.content.words[i]):expressions.push(this.params.content.words[i]);else expressions=this.params.content.words;expressions_count=expressions.length;for(var i=0;i<expressions_count;i++){var expression_found=eval(this.transformExpression(expressions[i].content,!1,null));if(expression_found)if(total==-1){if(expressions[i].score==-1){this.eldar._score_nil=!0,result=0;break}result+=Number(expressions[i].score)}else result++}switch(total){case-1:buffer=Math.min(result,100);break;case 0:buffer=100;break;default:buffer=Math.min(result/total*100,100)}return buffer},getInteraction:function(){return this._super()},correct_response:function(){return this.correct_response_text().substring(0,4e3)},student_response:function(){return this.student_response_text().substring(0,4e3)},student_response_text:function(){return $(this.eldar.input).text()},correct_response_text:function(){for(var e="",t=this.params.content.words.length,r=0;r<t;r++)this.params.content.words[r].score!=-1&&(e+=(""!=e?" ":"")+this.params.content.words[r].content);return e},tellEraseBadAnswer:function(){for(var e=[],t=this.params.content.item.length,r=0;r<t;r++)this.checkboxes[r].data("checked")&&Number(this.params.content.item[r].score>0)&&e.push(this.params.content.item[r].id);this.responses=e.join("[,]")},tellCorrectAnswer:function(){this._super();for(var e="",t=this.params.content.words.length,r=0;r<t;r++)this.params.content.words[r].score!=-1&&(e+=this.params.content.words[r].content+"<br/>");$(this.eldar.input).html(e)},tellEraseAnswer:function(){$(this.eldar.input).html("")}})});