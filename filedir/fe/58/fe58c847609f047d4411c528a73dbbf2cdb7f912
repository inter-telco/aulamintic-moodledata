define(["ekhil/view/AEldar","lib/HTMLHelper","lib/Utils","ekhil/EkhilPlayer"],function(e,t,s,r){return e.extend({init:function(e,r,n){this._super.apply(this,arguments),this.params=this.getParamsFromXML(e),this.screenWidth=r,this.screenHeight=n,this.answer=null,this.eldar.css({position:"relative"}),this._backImage=new t("image",{src:this.params.content.image.src,w:this.params.width,h:this.params.height,proportional:!!+this.params.elfe.proportional,streched:!!+this.params.elfe.streched}).getElement(),$(this._backImage).bind("onLoadInit",s.relegate(this,this.onImageLoadEvent)),this.eldar.prepend(this._backImage),$(this.eldar).data("refresh",this.refresh)},onImageLoadEvent:function(){this._backImageCss={left:$(this._backImage).children("img").css("left"),top:$(this._backImage).children("img").css("top"),width:$(this._backImage).children("img").get(0).width+"px",height:$(this._backImage).children("img").get(0).height+"px"},this.createZoneHyperlinks()},getParamsFromXML:function(e){var t=e.querySelector("content"),s=t.querySelector("zones"),n=t.querySelector("links"),i=t.querySelector("image"),o=[],a=0,h=[];if(s){var l=s.querySelectorAll("zone"),c=l.length;a=c;for(var u=0;u<c;u++){var g=l[u];o.push(this.parseXMLAttributes(g))}}if(n)for(var d=n.querySelectorAll("link"),p=d.length,m=0;m<p;m++){var f=d[m];h.push(this.parseXMLAttributes(f))}var w;if(i){var v=i?i.attributes.id.value:"",b=t.querySelector('link[id="'+v+'"]'),k=r.getInstance().getMediaPath(b.attributes.value.value);w={width:void 0!=i.attributes.width?i.getAttribute("width"):0,height:void 0!=i.attributes.height?i.getAttribute("height"):0,src:k}}else w={width:0,height:0,src:""};var _=e.querySelector("design"),S=this.parseXMLAttributes(_);return{content:{image:{src:w.src,width:w.width,height:w.height},nbzones:a,zones:o,links:h},elfe:{proportional:S.proportional,streched:S.streched,goodcolor:S.goodcolor,badcolor:S.badcolor},width:S.width,height:S.height,top:S.top,left:S.left}},show:function(){$(this.eldar).show()},refresh:function(){this.show()},createZoneHyperlinks:function(){for(var e=this.params.content.zones.length,t=0;t<e;t++){var r=this.params.content.zones[t],n=r.left*+s.removeCSSUnit(this._backImageCss.width)/100,i=r.top*+s.removeCSSUnit(this._backImageCss.height)/100,o=r.width*+s.removeCSSUnit(this._backImageCss.width)/100,a=r.height*+s.removeCSSUnit(this._backImageCss.height)/100,h=+s.removeCSSUnit(this._backImageCss.left)+n,l=+s.removeCSSUnit(this._backImageCss.top)+i,c={position:"absolute",left:h+"px",top:l+"px",width:o+"px",height:a+"px",boxSizing:"border-box",padding:"1px"},u=document.createElement("div");$(u).css(c);var g=1==this.params.content.zones[t].cursor;switch(g&&$(u).css({cursor:"pointer"}),this.params.content.zones[t].click){case"double":$(u).on("dblclick",this.onZonePressEvent.bind(this));break;case"right":console.warn("Right Click is not supported in Html");break;default:$(u).on("click",this.onZonePressEvent.bind(this))}u.id="zone_"+t,this.eldar.append(u)}},getSelectedZone:function(e){for(var t=this.params.content.zones.length,s=0;s<t;s++)if(e=="zone_"+s)return s;return null},onZonePressEvent:function(e){var t=e.touches?e.touches.item(0):e;this.answer=this.getSelectedZone(t.target.id),null!=this.answer&&this.answer!=-1&&this.player.runCommand("GoNextPage")},getLinkFromZone:function(e){if(null==e)return null;if(this.params.content.links)for(var t=this.params.content.links.length,s=0;s<t;s++)if(this.params.content.links[s].id==this.params.content.zones[e].link)return s},getAnswer:function(){var e=null!=this.answer?this.answer:-1,t={ClicAndGo:e};return JSON.stringify(t)},setAnswer:function(e){if(e)try{this.answer=JSON.parse(e).ClicAndGo||JSON.parse(e).clicandgo}catch(t){console.warn("parseJson - error : ",t)}},getScore:function(){var e=0;return null!=this.answer&&this.answer!=-1&&(e=this.params.content.zones[this.answer].score),e=Math.min(100,e)},student_response_text:function(){var e="";if(null!=this.answer&&this.answer!=-1){var t=this.getLinkFromZone(this.answer);null!=t&&(e="zone "+this.answer+" / Page "+this.params.content.links[t].value)}return e},correct_response_text:function(){for(var e="",t=this.params.content.zones.length,s=0;s<t;s++)if(this.params.content.zones[s].score>0){var r=this.getLinkFromZone(s);null!=r&&(e+="zone "+s+" / Page "+this.params.content.links[r].value+"\n")}return e},correct_response:function(){return this.correct_response_text()},student_response:function(){return this.student_response_text()},tellCorrectAnswer:function(){this._super(),this.answer=this.getCorrectAnswerNum(),this.refresh()},tellEraseAnswer:function(){this.answer=null,this.refresh()},tellEraseBadAnswer:function(){if(null!=this.answer&&this.answer!=-1){var e=getCorrectAnswerNum();this.answer!=e&&(this.answer=null,this.refresh())}},tellShowBadAnswer:function(){if(null!=this.answer&&this.answer!=-1){var e=this.getCorrectAnswerNum();if(this.answer!=e){var t={background:this.params.elfe.badcolor,backgroundColor:this.params.elfe.badcolor,border:"solid 2px "};$("zone_"+this.answer).css(t)}}},tellShowGoodAnswer:function(){if(null!=this.answer&&this.answer!=-1){var e=this.getCorrectAnswerNum();if(this.answer==e){var t={background:this.params.elfe.goodcolor,backgroundColor:this.params.elfe.goodcolor,border:"solid 2px"};$("zone_"+this.answer).css(t)}}},getCorrectAnswerNum:function(){for(var e,t=0,s=this.params.content.zones.length,r=0;r<s;r++)t<this.params.content.zones[r].score&&(t=this.params.content.zones[r].score,e=r);return e}})});