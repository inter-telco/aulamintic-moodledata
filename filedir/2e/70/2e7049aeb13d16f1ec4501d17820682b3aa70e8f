define(["ekhil/view/AEldar","lib/Utils","lib/HTMLHelper","lib/ScormHelper","lib/TextHelper"],function(e,t,s,r,i){return e.extend({params:{},answer:null,displayOrder:[],init:function(e){this._super.apply(this,arguments),this.params=this.getParamsFromXML(e),this.bAllowAction=!0,this.eldar._showGood=!1,this.eldar._showBad=!1,this.eldar._showMissed=!1,this.initAnswer(1==this.params.content.mix);var t=$("<table/>").css({width:"100%",pointerEvents:"none",borderSpacing:0});this.eldar.append(t),this.createCheckboxes(),this.eldar.data("refresh",this.eldar.refresh)},getParamsFromXML:function(e){var t={elfe:{checkboxes:{},items:{}},content:{item:[]}},s=e.querySelector("content"),r=s.querySelector("items"),i=r.querySelectorAll("item"),n=e.querySelector("design"),a=n.querySelector("items"),o=n.querySelector("items_roll");t.content.mix=r.attributes.mix.value,t.content.nb=r.attributes.nb.value;for(var h=r.attributes.length,c=0;c<h;c++)t.elfe.items[r.attributes[c].name]=r.attributes[c].value;for(var l=i.length,c=0;c<l;c++)t.content.item.push({score:i[c].attributes.score.value,text:i[c].textContent});for(var p=n.querySelector("checkboxes"),m=p.attributes.length,c=0;c<m;c++)/^file/.test(p.attributes[c].name)?t.elfe.checkboxes[p.attributes[c].name]=this.player.getMediaPath(p.attributes[c].value):t.elfe.checkboxes[p.attributes[c].name]=p.attributes[c].value;return t.design={items:this.parseXMLAttributes(a),items_roll:this.parseXMLAttributes(o)},t},getItemByScoreDesc:function(){for(var e=[],t=this.params.content.item.length,s=0;s<t;s++)e.push({position:s,score:this.params.content.item[s].score,text:this.params.content.item[s].text});return e.sort(function(e,t){return Number(e.score)<Number(t.score)?1:Number(e.score)>Number(t.score)?-1:0}),e},initAnswer:function(e){this.displayOrder=[],this.answer=[];for(var s=this.params.content.item.length,r=0;r<s;r++)this.answer.push(0),this.displayOrder.push(r);e&&(this.displayOrder=t.object_shuffle(this.displayOrder))},createCheckboxes:function(){var e=this.getCheckboxesWrapper(),r={};for(var n in this.params.design.items)$.extend(r,i.getEquivalence(n,this.params.design.items[n]));"1"==this.params.design.items.transparent&&(r.backgroundColor="none");var a={};for(var n in this.params.design.items_roll)$.extend(a,i.getEquivalence(n,this.params.design.items_roll[n]));"1"==this.params.design.items_roll.transparent&&(a.backgroundColor="none");var o={backgroundColor:"1"==this.params.design.items.transparent?"none":this.params.design.items.alternatecolor},h={};$.extend(h,r,o);var c={};$.extend(c,a,o),this.checkboxes=[],this.texts=[];for(var l=this.params.content.item.length,n=0;n<l;n++){var p=this.displayOrder[n],m=new s("checkbox",{file_width:this.params.elfe.checkboxes.width,file_height:this.params.elfe.checkboxes.height,file_normal:this.params.elfe.checkboxes.file_uncheck_normal,file_checked:this.params.elfe.checkboxes.file_check_normal}).getElement();this.checkboxes.push(m),$(m).on("change",this.onCheckboxChangeEvent.bind(this,p));var d="MCQText_Cell";n%2!=0&&(d+="_alternate");var u=$('<td class="'+d+'"/>').css($.extend(r,{width:"100%",padding:"0px",paddingLeft:this.params.design.items.hspace+"px",wordBreak:"normal",cursor:"pointer"}));u.html(t.convertNodeHtml(this.params.content.item[p].text)),u.on("click",{checkbox:m},function(e){e.data.checkbox.trigger("click")}),u.on("mouseover",function(){"MCQText_Cell_alternate"==$(this).get(0).className?$(this).css(c):$(this).css(a)}),u.on("mouseleave",function(){"MCQText_Cell_alternate"==$(this).get(0).className?$(this).css(h):$(this).css(r)});var f=$("<td/>").css({textAlign:"center",padding:0}).append(this.checkboxes[n]),b=$("<tr/>").css({pointerEvents:this.bAllowAction?"auto":"none"});if(b.addClass("clickable-row"),b.append(f),b.append(u),e.append(b),+this.params.design.items.vspace>0){var g=$("<tr/>").css({height:this.params.design.items.vspace+"px",border:"0px,",padding:"0px",margin:"0px"});g.addClass("rowSeparator"),g.append('<td colspan="2" ></td>'),e.append(g)}this.texts.push(u)}$(e).find(".MCQText_Cell_alternate").css(h)},getCheckboxesWrapper:function(){return this.eldar.find("> table")},eraseCheckboxes:function(){this.getCheckboxesWrapper().html("")},onCheckboxChangeEvent:function(e){if(1==this.params.content.nb){for(var t=this.answer.length,s=0;s<t;s++)this.answer[s]=0;this.answer[e]=1}else if(0!=this.params.content.nb)if(1===this.answer[e])this.answer[e]=0;else{for(var r=0,t=this.answer.length,s=0;s<t;s++)r+=this.answer[s];r<this.params.content.nb&&(this.answer[e]=1)}else this.answer[e]=+!this.answer[e];this.refresh()},onEldarLoaded:function(){this.eldar.parent().css({pointerEvents:"auto",overflowY:"auto"}),this.eldar.css({pointerEvents:"none"}),this._super.apply(this,arguments)},allowAction:function n(n){this.eldar.parent().css({pointerEvents:"auto",overflowY:"auto"}),this.bAllowAction=n,this.eldar.css({pointerEvents:"none"}),$(".clickable-row",this.eldar).css({pointerEvents:n?"auto":"none"})},refresh:function(){for(var e=0;e<this.checkboxes.length;e++){var t=this.displayOrder[e],s=this.answer[t];if(1==s){var r=this.params.content.item[t].score>0;this.checkboxes[e].check(),r&&this.eldar._showGood&&!this.isCorrected?(this.checkboxes[e].changePicture(this.params.elfe.checkboxes.file_check_good),this.texts[e].css("color",this.params.design.items.goodcolor)):r||!this.eldar._showBad||this.isCorrected?(this.checkboxes[e].changePicture(this.params.elfe.checkboxes.file_check_normal),this.texts[e].css("color",this.params.design.items.fontcolor)):(this.checkboxes[e].changePicture(this.params.elfe.checkboxes.file_check_bad),this.texts[e].css("color",this.params.design.items.badcolor))}else{var i=this.params.content.item[t].score>0;this.checkboxes[e].uncheck(),i&&this.eldar._showMissed&&!this.isCorrected?(this.checkboxes[e].changePicture(this.params.elfe.checkboxes.file_check_missed),this.checkboxes[e].check(),this.texts[e].css("color",this.params.design.items.missedcolor)):(this.checkboxes[e].img_checked.src=this.params.elfe.checkboxes.file_check_normal,this.checkboxes[e].uncheck(),this.texts[e].css("color",this.params.design.items.fontcolor))}}},getAnswer:function(){var e={};return e[this.type]=this.answer,e.rnd=this.displayOrder,JSON.stringify(e)},setAnswer:function(e){if(e){try{var t=JSON.parse(e);$.extend(this,{answer:t[this.type]||t[this.type.toLowerCase()],displayOrder:t.rnd})}catch(s){}var r=this.answer.length,i=this.params.content.item.length;if(i>r)for(var n=r;n<i;n++)this.answer.push(0),this.displayOrder.push(n)}else this.initAnswer(1==this.params.content.mix);this.eraseCheckboxes(),this.createCheckboxes()},getScore:function(){var e=this.params.content.item.length,t=0;if(0==this.params.content.nb){for(var s=0,r=0,i=0;i<e;i++)Number(this.params.content.item[i].score)>0?(s++,1===this.answer[i]&&r++):1===this.answer[i]&&r--;s>0&&(t=Number(100*r/s))}else for(var i=0;i<e;i++)1===this.answer[i]&&(t+=Number(this.params.content.item[i].score));return t=Math.max(0,t),t=Math.min(100,t)},getInteraction:function(){return this._super(this.params.content.nb)},correct_response:function(){for(var e=[],t=this.params.content.item.length,s=0;s<t;s++)this.params.content.item[s].score>0&&e.push(r.getScormIdentifier(s));return e.join("[,]")},correct_response_text:function(){var e=[];if(0!==+this.params.content.nb)for(var s=this.getItemByScoreDesc(),r=0;r<this.params.content.nb;r++)s[r].score>0&&e.push(r+1+". "+t.stripHTML(s[r].text));else for(var r=0;r<this.params.content.item.length;r++)this.params.content.item[r].score>0&&e.push(r+1+". "+t.stripHTML(this.params.content.item[r].text));return e.join(String.fromCharCode(13))},student_response:function(){for(var e=[],t=this.answer.length,s=0;s<t;s++)1==this.answer[s]&&e.push(r.getScormIdentifier(s));return e.join("[,]")},student_response_text:function(){for(var e=[],s=this.answer.length,r=0;r<s;r++)1===this.answer[r]&&e.push(r+1+". "+t.stripHTML(this.params.content.item[r].text));return e.join(String.fromCharCode(13))},tellEraseAnswer:function(){this.answer=[];for(var e=this.params.content.item.length,t=0;t<e;t++)this.answer.push(0)},tellEraseBadAnswer:function(){for(var e=this.answer.length,t=0;t<e;t++)1==this.answer[t]&&0==Number(this.params.content.item[t].score)&&(this.answer[t]=0)},tellCorrectAnswer:function(){if(this._super(),this.tellEraseAnswer(),0!==+this.params.content.nb)for(var e=this.getItemByScoreDesc(),t=0;t<this.params.content.nb;t++)e[t].score>0&&(this.answer[e[t].position]=1);else for(var s=this.params.content.item.length,t=0;t<s;t++)+this.params.content.item[t].score>0&&(this.answer[t]=1)}})});