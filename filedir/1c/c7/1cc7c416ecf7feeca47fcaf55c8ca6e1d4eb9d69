define(["eldar/ADragEldar","ekhil/view/eldarcomponent/DragItem","ekhil/view/eldarcomponent/DragAnswerItem","ekhil/view/eldarcomponent/DropZone","lib/Config","lib/Utils","lib/ArrayHelper","lib/HTMLHelper","lib/Math2DHelper","lib/MathUtils","lib/ScormHelper","lib/TextHelper"],function(t,e,i,r,s,n,o,a,h,g,d,u){var c=30,l=100,f=0,m=t.extend({init:function(t,e,i){this._super.apply(this,arguments),this.resources=this.getResourceFromXML(t),this.infos=this.getEldarInfosFromXML(t),this.design=this.getDesignFromXML(t),this.params=this.getParamsFromXML(t),this.nextItem=void 0,this.progressiveItems=[];var r=t.querySelector("content");this.background=this.getBgFromXML(r);var s=r.querySelector("image");s.hasAttribute("width")&&s.hasAttribute("height")||$(this).one("BACKGROUND_LOADED",function(){this.initAfterBackgoundLoaded(r)}),this.background&&this.initAfterBackgoundLoaded(r)},initAfterBackgoundLoaded:function(t){this.items=this.getItemsFromXML(t),this.zones=this.getZonesFromXML(t),this.answer=this.getInitAnswer(),this.initView()},getResourceFromXML:function(t){for(var e={},i=t.querySelectorAll("links>link"),r=0;r<i.length;r++)e[i[r].getAttribute("id")]=this.player.getMediaPath(i[r].getAttribute("value"));var s=t.querySelector("design>zones");return s.hasAttribute("file_bad")&&(e.file_bad=s.getAttribute("file_bad")),s.hasAttribute("file_good")&&(e.file_good=s.getAttribute("file_good")),e},getEldarInfosFromXML:function(t){var e=t.querySelector("design"),i=e.getAttribute("width"),r=e.getAttribute("height"),s={left:e.getAttribute("left"),top:e.getAttribute("top"),width:i,height:r,hscale:.01*i,vscale:.01*r};return s},getDesignFromXML:function(t){var e=t.querySelector("design"),i={background:this.getBgDesignFromXML(e),item:this.getItemDesignFromXML(e),feedback:this.getFeedbackDesignFromXML(e)};return i},getBgDesignFromXML:function(t){var e=t.querySelector("image"),i={proportional:"1"===e.getAttribute("proportional"),stretched:"1"===e.getAttribute("streched"),x:parseFloat(e.getAttribute("left"))*this.infos.hscale,y:parseFloat(e.getAttribute("top"))*this.infos.vscale,width:parseFloat(e.getAttribute("width"))*this.infos.hscale,height:parseFloat(e.getAttribute("height"))*this.infos.vscale};return i},getItemDesignFromXML:function(t){var e=t.querySelector("zones"),i=u.parseDesignNode(e);return i.border="1"===e.getAttribute("border"),i},getFeedbackDesignFromXML:function(t){var e=t.querySelector("zones"),i=this.parseXMLAttributes(e),r={badColor:i.badcolor,goodColor:i.goodcolor,fileBad:i.file_bad,fileGood:i.file_good};return r},getParamsFromXML:function(t){var e=t.querySelector("content"),i=t.querySelector("design"),r=this.getOptionsFromXML(e,i);return r},_createBackgroundZone:function(t,e,i,s){var n=r.create(-1,e,i).setPosition(s.x+.5*(s.width-e),s.y+.5*(s.height-i)).setBackgroundImage(t,{proportional:s.proportional,stretched:s.stretched});return n},_getRatio:function(t,e,i){return Math.max(t/i.width,e/i.height)},getBgFromXML:function(t){var e=this.resources.src,i=this.design.background,r=i.width,s=i.height,n=t.querySelector("image");if(n.hasAttribute("width")&&n.hasAttribute("height")){var o=parseFloat(n.getAttribute("width")),a=parseFloat(n.getAttribute("height")),h=this._getRatio(o,a,i);return r=n.getAttribute("width")/h,s=n.getAttribute("height")/h,this._createBackgroundZone(e,r,s,i)}var g=this,d=new Image;d.onload=function(){var t=parseFloat(this.width),n=parseFloat(this.height),o=g._getRatio(t,n,i);r=this.width/o,s=this.height/o,g.background=g._createBackgroundZone(e,r,s,i),$(g).trigger("BACKGROUND_LOADED")},d.src=e},getZonesFromXML:function(t){var e=o.fromList(t.querySelectorAll("zones>zone>position")),i=.01*this.background.width,s=.01*this.background.height,n=e.map(function(t,e){var n=r.create(e,parseFloat(t.getAttribute("width"))*i,parseFloat(t.getAttribute("height"))*s);return n.setPosition(parseFloat(t.getAttribute("left"))*i+this.background.x,parseFloat(t.getAttribute("top"))*s+this.background.y),n}.bind(this));return n},getItemsFromXML:function(t){for(var i=o.fromList(t.querySelectorAll("zones>zone")),r=(t.querySelector("links"),0),s=i.length,a=s>0?l/s:l,h=[],g=0;g<s;g++){var d=i[g],u=d.querySelector("position"),m=d.querySelector("data"),p="",b="";m.hasAttribute("src")?(p="image",b=this.resources[m.getAttribute("src")]):(p="text",b=m.textContent);var v=e.create(g).setZone(null!==u?r++:-1).setSize(parseFloat(n.getAttribute(d,"width",c))*this.infos.hscale,parseFloat(n.getAttribute(d,"height",a-2))*this.infos.vscale).setOrigine(parseFloat(n.getAttribute(d,"left",f))*this.infos.hscale,parseFloat(n.getAttribute(d,"top",a*g))*this.infos.vscale).setProportional(1===parseInt(n.getAttribute(d,"proportional","1"))).setStretch(1===parseInt(n.getAttribute(d,"streched","0"))).setTextDesign(this.design.item).setContent(p,b).setDragEndCbk(this.onDragEndItem.bind(this)).setDragStartCbk(this.onStartDragItem.bind(this));h.push(v)}return h},getOptionsFromXML:function(t,e){var i=t.querySelector("zones"),r={magnet:"1"===i.getAttribute("magnet"),progressiveStack:"1"===e.getAttribute("progressivestack"),randomizeItems:"1"===e.getAttribute("randomize"),revertOnError:"1"===i.getAttribute("back"),arrangeOverlappingAnswers:"1"===e.getAttribute("arrangeanswers")};return r},initView:function(){return this.eldar.show(),this.eldar.append(this.background.render()),this.zones.forEach(function(t){this.eldar.append(t.render())}.bind(this)),this.items.forEach(function(t){this.eldar.append(t.render())}.bind(this)),this.params.progressiveStack&&(this.progressiveItems=this.items.concat(),this.params.randomizeItems&&(this.progressiveItems=o.shuffle(this.progressiveItems)),this.nextItem=this.selectNextItem()),this.eldar},onDragEndItem:function(t){this.params.progressiveStack&&(this.nextItem=this.selectNextItem()),this.updateAnswer(t)},onStartDragItem:function(t){if(this.params.progressiveStack&&this.isItemPlaced(t))if(void 0!==this.nextItem){var e=this.nextItem;this.nextItem=t,this.refreshItemVisibility(e)}else this.nextItem=t},updateAnswer:function(t){return this._assignTargetToAnswer(t),this.refresh(),this.answer},_getMovedItemPosition:function(t){var e=.01*this.background.width,i=.01*this.background.height,r=t.div.offset().top*i,s=t.div.offset().left*e,n=(h.tl2xy({left:s,top:r}),h.vector2dSubstract(h.tl2xy(r),h.tl2xy(s)));return n},_assignTargetToAnswer:function(t){var e=void 0,r=-1,s=t.dropZoneHovered;if(s.length>0){var n=this._getMovedItemPosition(t);if(s.length>1){var o=s.filter(function(t){return t.id!==-1}),r=this._getTarget(t,o);if(this.params.magnet){var a=h.getCenterPosition(n,h.wh2xy(t)),d=o.map(function(t,e,i,r){return{zoneId:r.id,sqDist:e(i(r.getCenter(),t))}}.bind(null,a,h.squareDistance,h.vector2dSubstract));r=d.reduce(function(t,e){var i=t.sqDist===-1||e.sqDist<t.sqDist?e:t;return i},{sqDist:-1}).zoneId}}e={x:g.limitDecimal(n.x,1),y:g.limitDecimal(n.y,1)}}this.answer[t.id]=i.create().setTarget(r),void 0!==e&&this.answer[t.id].setInfos(e)},_getTarget:function(t,e){var i=this._getMovedItemPosition(t),r=h.getCenterPosition(i,h.wh2xy(t)),s=e.map(function(t,e,i,r){return{zoneId:r.id,sqDist:e(i(r.getCenter(),t))}}.bind(null,r,h.squareDistance,h.vector2dSubstract));return s},selectNextItem:function(){var t=this.progressiveItems.concat();if(void 0!==this.nextItem){var e=this.progressiveItems.indexOf(this.nextItem),i=[],r=[];e===this.progressiveItems.length-1?i=this.progressiveItems.slice(0,e-1):0===e?r=this.progressiveItems.slice(1):(i=this.progressiveItems.slice(0,e-1),r=this.progressiveItems.slice(e+1)),t=r.concat(i)}var s=o.find(t,function(t){return!this.isItemPlaced(t)}.bind(this)),n=void 0===s?this.nextItem:s;return n},isItemPlaced:function(t){var e=this._super(t);return e=e||void 0!==this.answer[t.id].infos},adjustPlacedItem:function(t){var e=this.answer[t.id];if(e.target!==-1&&this.params.magnet){var e=this.answer[t.id],i=this.zones[e.target].getCenter();t.setCenter(i)}else t.setPosition(e.infos.x,e.infos.y)},refreshItemVisibility:function(t){this.isCorrected||!this.params.progressiveStack||this.params.progressiveStack&&(this.isItemPlaced(t)||t===this.nextItem)?t.setLoadedCbk(function(){this.div.show()}.bind(t)):t.div.hide()},refresh:function(){this._super(),this.items.forEach(function(t){this.refreshItemVisibility(t);var e=this.isCorrectAnswerItem(t.id),i=this.design.item.border?this.design.item.borderColor:"transparent";e&&this.eldar._showGood&&!this.isCorrected?i=this.design.feedback.goodColor:e||!this.eldar._showBad||this.isCorrected||(i=this.design.feedback.badColor),console.log("DragOnPlace.js::-L684 color:"+i),t.div.css({border:"1px solid "+i})}.bind(this))},refreshItem:function(t){this.isItemPlaced(t)?this.adjustPlacedItem(t):t.resetPosition(),this._super(t)},setAnswer:function(t){var e=this._super(t);if(null===e&&t){var r=t.replace(/px/g,"").split(";");this.answer=r.map(function(t){var e=t.split(","),r=i.create().setTarget(parseInt(e[2])).setInfos({x:parseFloat(e[0]),y:parseFloat(e[1])});return r}),e=this.answer}return null===e&&(this.tellEraseAnswer(),e=this.answer),e},getCorrectAnswerItem:function(t){var e=this._super(t);if(t.zone!==-1){var i=t.getCenteredPosition(this.zones[t.zone].getCenter());e.setInfos(i)}return e},isCorrectAnswerItem:function(t){var e=this._super(t),i=this.answer[t],r=o.find(this.items,function(t,e){return e.id===t}.bind(this,t));return e=e&&(r.zone!==-1||void 0===i.infos)},getLMSFormattedSource:function(t){return this.getLmsReadableIdentifier(t)},getLMSFormattedTarget:function(t){var e="";if(t.target===-1)e=void 0===t.infos?"no move":"out of area";else{var i=o.findIndex(this.items,function(t,e){return e.zone===t.target}.bind(null,t));e="area "+this.getLmsReadableIdentifier(i)}return e},getLmsReadableIdentifier:function(t){var e="";if("undefined"!=typeof t&&this.items[t]){var i=this.items[t];switch(i.type){case"image":var r=/.*\/([\w-]+)\.[\w]{1,6}/;e=r.exec(i.content)[1];break;case"text":e=i.content}}return e}});return m});