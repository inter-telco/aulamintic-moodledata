define(["ekhil/view/AEldar","lib/TextHelper","lib/Utils","lib/HTMLHelper"],function(e,t,r,o){return e.extend({answer:[],caretWidth:40,init:function(e,o,i,s){this._super.apply(this,arguments);var n=e.querySelector("content > text"),a=e.querySelector("design");this.parseXMLAttributes(a);if(this.textDesignNode=a.querySelector("text"),this.textDesignNode)var l=t.parseDesignNode(this.textDesignNode),h=this.parseXMLAttributes(this.textDesignNode);this.answer=[],this.xml=e,this.holes=e.querySelectorAll("holes>hole"),this.comboDesignNode=a.querySelector("combo"),this.contentText=n.textContent,this.eldar.css($.extend(l,{width:"100%",height:"100%",whiteSpace:"pre-wrap"})),"1"==h.scrollbar&&this.eldar.addClass("scrollable"),this.eldar.html(this.replaceLinkBySelect(n.textContent,this.holes)),r.hasTouchEvent()||$(this.player).on("resize",r.relegate(this,this.resizeWrapper))},resizeWrapper:function(){for(var e=this.eldar.find("select"),t=e.length,r=this.player.container.getScale(),i=0;i<t;i++){var s=e[i],n=$(s).parent(),a=this.getComboBoxSize(s);n.css({width:a.width+"px",height:a.height+"px"}),o.addCSSRule("."+n[0].classList[0]+":after",{width:this.caretWidth/r+"px"})}},isGoodAnswer:function(e){var t=!1;if(void 0!=this.answer[e]){for(var r=this.holes[e].querySelectorAll("prop"),o=r.length,i=r[this.answer[e]],s=-1,n=-1,a=-1,l=o-1;l>=0;l--)+r[l].attributes.score.value>s&&(s=+r[l].attributes.score.value,n=l),r[l].textContent==i.textContent&&(a=l);r[a]&&r[a].attributes.score.value==s&&(t=!0)}return t},getBackgroundArrow:function(e,t,r,o){var i=document.createElement("canvas"),s=e,n=t;i.width=s,i.height=n;var a=i.getContext("2d");return a.moveTo(s/3,n/3),a.beginPath(),a.lineTo(2*s/3,n/3),a.lineTo(s/2,2*n/3),a.lineTo(s/3,n/3),a.closePath(),a.fillStyle=r,a.fill(),o&&(a.beginPath(),a.moveTo(0,0),a.lineTo(0,n),a.strokeStyle=o,a.stroke()),'url("'+i.toDataURL()+'")'},isEqualWidth:function(){return void 0!==this.comboDesignNode.attributes.equalwidth&&!!+this.comboDesignNode.attributes.equalwidth.value},setComboBoxStyle:function(e){var t=this.parseXMLAttributes(this.comboDesignNode),o=+t.border?{combo:"solid 1px "+t.bordercolor,bgImage:t.bordercolor}:{combo:"none",bgImage:!1},i=$("<div/>").css({overflow:"hidden",border:"solid 1px "+t.bordercolor,padding:0,margin:"2px",position:"relative",display:"inline-block"}),s={content:'""',display:"inline-block",position:"absolute",right:0,top:0,"pointer-events":"none","vertical-align":"middle","background-position":"center center","background-color":"white","background-repeat":"no-repeat"};$("select",e).each(r.relegate(this,this.setWrapperStyle,i,t,s,o))},setWrapperStyle:function(e,t,r,i,s,n){var a=$(e).clone(),l=this.player.container.getScale(),h=this.getComboBoxSize(n);$(n).css({border:"none",padding:0,margin:0,position:"absolute",left:0,top:0,width:h.width+this.caretWidth/l+"px"});var c=this.getBackgroundArrow(this.caretWidth/l,h.height,t.arrowcolor,i.bgImage),d=this.getBackgroundArrow(this.caretWidth/l,h.height,t.arrowhighlightcolor,i.bgImage);$.extend(r,{width:this.caretWidth/l+"px",height:h.height+"px","background-image":c,"background-color":t.bgcolor});var u="select-wrapper"+o.getUID();o.addCSSRule("."+u+":after",r),a.addClass(u),a.css({width:h.width+this.caretWidth/l+"px",height:h.height,verticalAlign:"middle"}),$(a).bind({mouseover:function(){o.addCSSRule("."+u+":after",{"background-image":d})},mouseout:function(){o.addCSSRule("."+u+":after",{"background-image":c})}}),$(n).wrap(a)},getComboBoxSize:function(e){var t=$(e).clone();$("body").append(t);var r={width:$(t).width(),height:$(t).height()};return $(t).remove(),r},replaceLinkBySelect:function(e,t){var o=document.createElement("div");o.innerHTML=e;for(var i=o.querySelectorAll("a"),s=i.length,n=this.parseXMLAttributes(this.comboDesignNode),a=0;a<s;a++){var l=document.createElement("select");$(l).data("index",a).css({fontSize:n.fontsize+"px",color:n.fontcolor,"background-color":n.bgcolor});for(var h=(+i[a].attributes.href.value.replace("#",""),t[a].querySelectorAll("prop")),c=h.length,d=0;d<c;d++){var u=document.createElement("option"),g={color:n.fontcolor,"background-color":n.bgcolor,fontFamily:n.font};"1"===n.bold&&(g.fontWeight="bold"),"1"===n.italic&&(g.fontStyle="italic"),"1"===n.underline&&(g.fontDecoration="underline"),$(u).data("score",+h[d].attributes.score.value).css(g),u.innerHTML=h[d].textContent,l.appendChild(u)}l.addEventListener("change",r.relegate(this,this.onChangeEvent),!1),o.replaceChild(l,i[a]),l.selectedIndex=-1}return this.isEqualWidth()&&this.resizeComboBox(o),r.hasTouchEvent()||this.setComboBoxStyle(o),o},onChangeEvent:function(e){var t=e.target,r=this.parseXMLAttributes(this.comboDesignNode);$(t).css({color:r.fontcolor});var o=t.selectedIndex;this.answer[$(t).data("index")]=o},resizeComboBox:function(e){var t=document.createElement("div"),r=document.querySelector("body");r.appendChild(t);for(var o=0,i=e.querySelectorAll("select"),s=i.length,n=0;n<s;n++){var a=i[n],l=a.parentNode,h=document.createElement("span");l.replaceChild(h,a),t.appendChild(a),$(a).width()>o&&(o=$(a).width()),l.replaceChild(a,h)}for(var c=this.player.container.getScale(),n=0;n<s;n++){var a=i[n];$(a).width(o+this.caretWidth/c)}},getScore:function(){var e=0,t=this.holes;if(void 0!==t&&t.length>0&&this.answer.length>0){for(var r=0,o=this.answer.length,i=0;i<o;i++)if(void 0!==this.answer[i]&&null!==this.answer[i]&&void 0!==t[i]&&null!==t[i]){var s=t[i].querySelectorAll("prop");r+=+s[this.answer[i]].attributes.score.value}e=Math.round(r/t.length)}return e},setAnswer:function(e){if(this._super(e),null==r.parseJson(e)){var t=this.holes;this.answer=[];for(var o=$(e).find("hole"),i=0,s=o.length;i<s;i++)if(void 0!==t[i]){var n=t[i].querySelectorAll("prop");if(""==o[i].attributes.choice.value)this.answer.push(void 0);else for(var a in n)o[i].attributes.choice.value==n[a].textContent&&this.answer.push(+a)}}},refreshSelect:function(e,t){var r=$(t).data("index");this.answer.length&&void 0!==this.answer[r]&&null!==this.answer[r]?t.selectedIndex=+this.answer[r]:t.selectedIndex=-1,!this.isCorrected&&this.eldar._showGood&&this.isGoodAnswer(r)?$(t).css({color:this.textDesignNode.attributes.goodcolor.value}):this.isCorrected||!this.eldar._showBad||this.isGoodAnswer(r)?$(t).css({color:this.comboDesignNode.attributes.fontcolor.value}):$(t).css({color:this.textDesignNode.attributes.badcolor.value})},refresh:function(){$(this.eldar).find("select").each(r.relegate(this,this.refreshSelect))},getInteraction:function(){var e=this._super();return e},correct_response:function(){return this.correct_response_text},student_response:function(){return this.student_response_text()},correct_response_text:function(){for(var e="",t=[],r=this.holes,o=0;o<r.length;o++){for(var i=0,s=this.holes[o].querySelectorAll("prop"),n=s.length,a=+s[0].getAttribute("score"),l=0;l<n;l++)+s[l].getAttribute("score")>a&&(a=+s[l].getAttribute("score"),i=l);t.push(s[i].textContent)}return e=this.getFullText(t,!1),e=e.replace("<br/>",String.fromCharCode(13))},student_response_text:function(){for(var e=[],t=0;t<this.holes.length;t++){var r=this.answer[t];if(void 0!==r&&""!==r&&null!==r){var o=this.holes[t].querySelectorAll("prop");e.push(o[r].textContent)}else e.push(void 0)}var i=this.getFullText(e,!1);return i=i.replace("<br/>",String.fromCharCode(13))},getFullText:function(e,t){var r=this.contentText;void 0==r&&(r=""),r=o.getXHTMLLineBreak(r);var i=0,s=0,n=0,a="...?...",l='<a href="#',h="</a>",c=h.length;do if(s=r.indexOf(l,s),n=r.indexOf(h,s),s>-1&&n>-1){var d=(r.indexOf(">",s),a),u=e[i];void 0!=u&&""!=u&&(d=u),t&&(d='<a href="asfunction:_root.onExerciseRelease,'+i+'">'+d+"</a>"),r=r.substring(0,s)+d+r.substring(n+c),i++}while(s>-1);return r},tellEraseBadAnswer:function(){for(var e=this.holes.length,t=0;t<e;t++)this.isGoodAnswer(t)||(this.answer[t]=void 0)},tellCorrectAnswer:function(){this._super(),this.answer=[];for(var e=this.holes.length,t=0;t<e;t++){for(var r=-1,o=-1,i=this.holes[t].querySelectorAll("prop"),s=i.length,n=s-1;n>=0;n--)+i[n].attributes.score.value>r&&(r=+i[n].attributes.score.value,o=n);this.answer[t]=o}}})});