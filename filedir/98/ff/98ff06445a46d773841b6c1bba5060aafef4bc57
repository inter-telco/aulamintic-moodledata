define(["ekhil/view/AEldar","lib/HTMLHelper","lib/Utils","lib/TextHelper","lib/DragAndDrop"],function(e,t,a,r){return e.extend({init:function(e,t,r){this._super(e),this.screenWidth=t,this.screenHeight=r,this.player=require("ekhil/EkhilPlayer").getInstance(),this.params=this.getParamsFromXML(e);var i=this.params.content.cards;this.list_cards=[];for(var s=i.length,d=0;d<s;d++){var o=this._createCard(i[d]);o.data("viewed",!1),this.eldar.append(o),o.draggable(),o.bind("mousedown touchstart",a.relegate(this,this.onMouseDownEvent,i[d])),o.bind("mouseup touchend",a.relegate(this,this.onMouseUpEvent,i[d])),this.list_cards.push(o)}},onMouseDownEvent:function(e,t){var a=t.currentTarget,r=$(a);r.data("viewed",!0),r.data("recto").hide(),r.data("verso").show(),$(".scaled",a).css({transform:"scale(1.2)",transformOrigin:"0 0"})},onMouseUpEvent:function(e,t){var a=t.currentTarget;$(".scaled",a).css({transform:"scale(1)",transformOrigin:"0 0"})},getParamsFromXML:function(e){var t={content:{cards:[]},elfe:{card:{},face:{},title:{},back:{}}},a=e.querySelector("design"),i=e.querySelector("design > card > face"),s=e.querySelector("design > card > title"),d=e.querySelector("design > card > back"),o=e.querySelector("content > links");t.elfe.card=this.parseXMLAttributes(e.querySelector("design > card")),t.elfe.face=this.parseXMLAttributes(i),t.elfe.title=this.parseXMLAttributes(s),t.elfe.back=this.parseXMLAttributes(d),t.width=a.attributes.width.value,t.height=a.attributes.height.value;for(var h=e.querySelectorAll("cards > card"),n=h.length,c=0;c<n;c++){var l=this.parseXMLAttributes(h[c]);if(void 0!==l.back_bg_path){var p=o.querySelector('link[id="'+l.back_bg_path+'"]');l.back_bg_path=p.attributes.value.value}if(void 0!==l.face_bg_path){var p=o.querySelector('link[id="'+l.face_bg_path+'"]');l.face_bg_path=p.attributes.value.value}l.head={text:r.parseTextNode(h[c].querySelector("head"),s,this.player.getMediaPath.bind(this.player)),backgroundColor:"",height:this.getTitleHeight(h[c].querySelector("head"),s),width:this.getTitleWidth(h[c].querySelector("head"),s)},l.back={text:r.parseTextNode(h[c].querySelector("back"),d,this.player.getMediaPath.bind(this.player)),backgroundColor:""},l.face={text:r.parseTextNode(h[c].querySelector("face"),i,this.player.getMediaPath.bind(this.player)),backgroundColor:""},t.content.cards.push(l)}return t},getTitleHeight:function(e,t){var a=$("<div/>");a.html(r.parseTextNode(e,t,this.player.getMediaPath.bind(this.player),null,null,"auto")),a.hide(),$("body").append(a);var i=a.height();return a.remove(),i},getTitleWidth:function(e,t){var a=$("<div/>");a.html(r.parseTextNode(e,t,this.player.getMediaPath.bind(this.player),null,null,"auto")),a.hide(),$("body").append(a);var i=a.width();return a.remove(),i},_createBaseCard:function(e,a,r){e=this.player.getMediaPath(e);var i=$("<div/>").css({width:"100%",height:"100%"}),s=new t("image",{src:e,w:a,h:r,proportional:!1,streched:!0,position:"absolute"}).getElement();return s.hide(),s.css({top:"0%",left:"0%",position:"absolute"}),s.load(function(){$(this).css({width:"100%",height:"100%"}),s.show()}),i.append(s),i},_createCardRecto:function(e,t,a){var r=this.params.elfe.card.default_back_bg,i={};i="txt"===e.back.format||"xhtml"===e.back.format?{backgroundColor:this.params.elfe.back.transparent?"transparent":this.params.elfe.back.bgcolor}:{backgroundColor:this.params.elfe.back.transparent&&e.back.backgroundColor==this.params.elfe.back.bgcolor?"transparent":e.back.backgroundColor};var s=this._createBaseCard(e.back_bg_path||r,t,a),d=e.height/100*this.params.height,o=e.width/100*this.params.width,h=this.params.elfe.card.padding/d*100,n=this.params.elfe.card.padding/o*100,c=$("<div/>").css({position:"absolute",overflow:"hidden",width:100-2*n+"%",height:100-2*h+"%",padding:this.params.elfe.card.padding+"px"}),l=e.back.text.css({width:"100%",height:"100%",overflow:"hidden",borderWidth:+this.params.elfe.back.border?"1px":"0px",borderStyle:"solid",borderColor:this.params.elfe.back.bordercolor,"overflow-wrap":"break-word"});return l.css(i),c.append(l),s.append(c),s},_createCardVerso:function(e,t,a){var r=this.params.elfe.card.default_face_bg,i={};i="txt"===e.face.format||"xhtml"===e.face.format?{backgroundColor:this.params.elfe.face.transparent?"transparent":this.params.elfe.face.bgcolor}:{backgroundColor:e.face.backgroundColor};var s=this._createBaseCard(e.face_bg_path||r,t,a);s.hide();var d=(e.height/100*this.params.height,e.width/100*this.params.width),o=$('<div class="verso_text_content"/>').css({position:"absolute",overflow:"hidden",width:"calc(100% - "+2*this.params.elfe.card.padding+"px )",height:"calc(100% - "+2*this.params.elfe.card.padding+"px )",margin:this.params.elfe.card.padding+"px"}),h=e.head.width,n=3,c=+this.params.elfe.card.padding+n,l=Math.ceil(h/(d-2*c)),p=3,u=l*(e.head.height-2*n)+2*p,g=e.head.text.css({textAlign:this.params.elfe.title.align,height:u+"px","word-wrap":"break-word"}),f=e.face.text.css({height:"calc(100% - "+u+"px)",overflow:"hidden",borderWidth:+this.params.elfe.face.border?"1px":"0px",borderStyle:"solid",borderColor:this.params.elfe.face.bordercolor,"overflow-wrap":"break-word"});return f.children("div").css("height","100%"),f.css(i).find(":first-child").css({padding:""}).find(":first-child").not("ul").css({padding:"1px"}),o.append(g),o.append(f),s.append(o),s},_createCard:function(e){var t=$("<div />").css({width:e.width+"%",height:e.height+"%",top:e.top+"%",left:e.left+"%",position:"absolute",cursor:"pointer"}),r=e.width/100*this.params.width,i=e.height/100*this.params.height,s=this._createCardRecto(e,r,i),d=this._createCardVerso(e,r,i);t.data("recto",s),t.data("verso",d);var o=$("<div/>");return o.css({width:"100%",height:"100%"}),o.addClass("scaled"),t.append(o),o.append(s),o.append(d),a.rotate(t,e.rotation,"50% 50%"),t},correct_response:function(){return""},student_response:function(){return""},student_response_text:function(){return""},correct_response_text:function(){return""},getScore:function(){for(var e=0,t=0,a=this.list_cards.length,r=0;r<a;r++)this.list_cards[r].data("viewed")&&t++;return 0!==t&&(e=Math.round(t/a*100)),e},getAnswer:function(){for(var e={Cards:[]},t=this.list_cards.length,a=0;a<t;a++)e.Cards.push(this.list_cards[a].data("viewed")?1:0);return JSON.stringify(e)},refresh:function(){for(var e=this.list_cards.length,t=0;t<e;t++){var a=$(this.list_cards[t]);this.answer[t]&&1==this.answer[t]?(a.data("recto").hide(),a.data("verso").show()):(a.data("verso").hide(),a.data("recto").show())}}})});