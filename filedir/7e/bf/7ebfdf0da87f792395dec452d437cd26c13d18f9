define(["ekhil/view/AEldar","lib/Utils","lib/HTMLHelper","lib/ScormHelper","lib/TextHelper","lib/PositionHelper"],function(e,t,s,i,n,r){return e.extend({init:function(e,s,i,n){this._super.apply(this,arguments),this.bAllowAction=!0,this.params=this.getParamsFromXML(e),this.answer=[],this.eldar._showGood=!1,this.eldar._showBad=!1,this.eldar._showMissed=!1,this.screenWidth=s,this.screenHeight=i,this.width=this.params.design.design.width,this.height=this.params.design.design.height,t.removeUserSelect(this.eldar),this.isShown=!1},getParamsFromXML:function(e){var t=e.querySelector("design"),s=t.querySelector("items"),i=t.querySelector("items_roll"),n=t.querySelector("checkboxes"),r=this.parseXMLAttributes(n),h={};for(var a in r)h[a]=/^file/.test(a)?this.player.getMediaPath(r[a]):r[a];var c=t.querySelector("radio"),o=this.parseXMLAttributes(c),l={};for(var a in o)l[a]=/^file/.test(a)?this.player.getMediaPath(o[a]):o[a];for(var d=e.querySelector("content"),m=[],b=d.querySelectorAll("items"),u=b.length,p=0;p<u;p++){for(var x=[],f=b[p].querySelectorAll("item"),g=f.length,w=0;w<g;w++)x.push({score:f[w].getAttribute("score"),text:f[w].textContent,index:w,x_check:f[w].getAttribute("x_check"),y_check:f[w].getAttribute("y_check"),w_check:f[w].getAttribute("w_check"),h_check:f[w].getAttribute("h_check"),x_label:f[w].getAttribute("x_label"),y_label:f[w].getAttribute("y_label"),w_label:f[w].getAttribute("w_label"),h_label:f[w].getAttribute("h_label")});m.push({items:x,nb:b[p].attributes.nb.value,index:p})}var v=d.querySelector("label");return{design:{design:this.parseXMLAttributes(t),items:this.parseXMLAttributes(s),items_roll:this.parseXMLAttributes(i),radio:l,checkboxes:h},content:{label:this.parseXMLAttributes(v),series:m}}},show:function(){if(!this.isShown){this.isShown=!0;var e={};for(var i in this.params.design.items)$.extend(e,n.getEquivalence(i,this.params.design.items[i]));var r={};for(var i in this.params.design.items_roll)$.extend(r,n.getEquivalence(i,this.params.design.items_roll[i]));var h="1"==this.params.content.label.show_label,a="1"==this.params.content.label.roll_label,c=h&&!a?"block":"none",o=h?"block":"none";this.checkboxes=[],this.texts=[];var l=this.params.content.series;l.map(function(i){this.checkboxes[i.index]=[],this.texts[i.index]=[];var n=i.items;n.map(function(n){var h=new s("checkbox",{file_width:n.w_check,file_height:n.h_check,file_normal:this.params.design.checkboxes.file_uncheck_normal,file_checked:this.params.design.checkboxes.file_check_normal}).getElement(),l=$("<div/>").css({left:n.x_check*this.width/100,top:n.y_check*this.height/100,position:"absolute",pointerEvents:this.bAllowAction?"auto":"none"}).append(h);l.addClass("clickable-checkbox"),this.checkboxes[i.index][n.index]=h;var d=n.x_label*this.width/100,m=n.y_label*this.height/100;a&&(d=n.x_check*this.width/100+20,m=n.y_check*this.height/100);var b={position:"absolute",left:d,top:m,width:n.w_label,height:n.h_label,textAlign:"left",display:c},u=$("<div/>").css($.extend(e,b));u.html(t.convertNodeHtml(n.text)),$(h).bind({mouseover:function(){$(u).css($.extend(r,{display:o}))},mouseout:function(){$(u).css($.extend(e,b))}}),$(h).on("click",{checkbox:h},this.onCheckboxClickEvent.bind(this,i.index,n.index)),this.texts[i.index].push(u),this.eldar.append(l),this.eldar.append(u)}.bind(this))}.bind(this))}this.refresh()},onCheckboxClickEvent:function(e,t){if(1==this.params.content.series[e].nb){for(var s=this.answer[e],i=0;i<s.length;i++)this.answer[e][i]=0;this.answer[e][t]=1}else if(0!=this.params.content.series[e].nb)if(1===this.answer[e][t])this.answer[e][t]=0;else{for(var n=0,s=this.answer[e],i=0;i<s.length;i++)n+=this.answer[e][i];n<this.params.content.series[e].nb&&(this.answer[e][t]=1)}else this.answer[e][t]=+!this.answer[e][t];this.refresh()},allowAction:function h(h){this.bAllowAction=h,this.eldar.css({pointerEvents:"none"}),$(".clickable-checkbox",this.eldar).css({pointerEvents:h?"auto":"none"})},refresh:function(){if(!jQuery.isEmptyObject(this.answer)&&this.checkboxes){for(var e=0;e<this.checkboxes.length;e++)for(var t=0;t<this.checkboxes[e].length;t++)this.checkboxes[e][t].uncheck();for(var s=0;s<this.answer.length;s++)for(var i=this.answer[s],n=this.params.content.series[s],r=0;r<i.length;r++){var h=i[r],a=n.items[r],c=1==h&&a.score>0,o=0==h&&a.score>0;1==h?(this.checkboxes[s][r].check(),c&&this.eldar._showGood&&!this.isCorrected?(this.checkboxes[s][r].changePicture(this.params.design.checkboxes.file_good),this.texts[s][r].css("color",this.params.design.items.goodcolor)):c||!this.eldar._showBad||this.isCorrected?(this.checkboxes[s][r].changePicture(this.params.design.checkboxes.file_check_normal),this.texts[s][r].css("color",this.params.design.items.fontcolor)):(this.checkboxes[s][r].changePicture(this.params.design.checkboxes.file_bad),this.texts[s][r].css("color",this.params.design.items.badcolor))):o&&this.eldar._showMissed&&!this.isCorrected?(this.checkboxes[s][r].changePicture(this.params.design.checkboxes.file_missed),this.checkboxes[s][r].check(),this.texts[s][r].css("color",this.params.design.items.missedcolor)):(this.checkboxes[s][r].img_checked.src=this.params.design.checkboxes.file_check_normal,this.checkboxes[s][r].uncheck(),this.texts[s][r].css("color",this.params.design.items.fontcolor))}}},setAnswer:function(e){if(this._super(),e)try{var s=t.parseJson(e);s&&(this.answer=s[this.type]||s[this.type.toLowerCase()])}catch(i){console.warn("MCQMulti.setAnswer - error : ",i)}else this.initAnswer()},initAnswer:function(){this.answer=[];var e=this.params.content.series;e.map(function(e){this.answer[e.index]=[];var t=e.items;t.map(function(t){this.answer[e.index][t.index]=0}.bind(this))}.bind(this))},getScore:function(){var e=0;if(!jQuery.isEmptyObject(this.answer)){for(var t=[],s=this.params.content.series.length,i=0;i<s;i++){t[i]=0;var n=this.params.content.series[i].items,r=this.params.content.series[i].nb;if(n.length>0){var h;if(0==r){for(var a=0,c=!1,o=0;o<n.length;o++)h=n[o],h.score>0?(a++,this.answer[i][o]&&t[i]++):this.answer[i][o]&&(t[i]--,c=!0);a>0?t[i]=Math.max(0,100*t[i]/a):0!=a||c?t[i]=Math.max(0,Math.min(100,t[i])):t[i]=100}else{for(var l=0,c=!1,o=0;o<n.length;o++)h=n[o],l+=Number(h.score),this.answer[i][o]&&(t[i]=t[i]+Number(h.score),0==h.score&&(c=!0));0!=l||c?t[i]=Math.max(0,Math.min(100,t[i])):t[i]=100}t[i]=Math.max(t[i],0),t[i]=Math.min(t[i],100)}}for(var d=t.length,i=0;i<d;i++)e+=t[i];e/=d,e=Math.max(e,0),e=Math.min(e,100)}return e},student_response_text:function(){var e=[],t=this.params.content.series;return t.map(function(t){var s=t.items;s.map(function(s){this.answer[t.index][s.index]>0&&e.push(t.index+1+"."+(s.index+1)+". "+s.text)}.bind(this))}.bind(this)),e.join("\n")},student_response:function(){var e=[],t=this.params.content.series;return t.map(function(t){var s="",n=t.items;n.map(function(e){this.answer[t.index][e.index]>0&&(s+=i.getScormIdentifier(e.index)+",")}.bind(this)),s=s.substring(0,s.length-1),e.push(s)}.bind(this)),e.join(";")},correct_response:function(){var e=[],t=this.params.content.series;return t.map(function(t){var s="",n=t.items;n.map(function(e){e.score>0&&(s+=i.getScormIdentifier(t.index)+",")}.bind(this)),s=s.substring(0,s.length-1),e.push(s)}.bind(this)),e.join(";")},correct_response_text:function(){var e=[],t=this.params.content.series;return t.map(function(t){var s=t.items;s.map(function(s){s.score>0&&e.push(t.index+1+"."+(s.index+1)+". "+s.text)}.bind(this))}.bind(this)),e.join("\n")},tellEraseBadAnswer:function(){if(this.answer){var e=this.params.content.series;e.map(function(e){var t=e.items;t.map(function(t){0==t.score&&1==this.answer[e.index][t.index]&&(this.answer[e.index][t.index]=0)}.bind(this))}.bind(this))}},getItemsOrderByScore:function(e){var t=[],s=this.params.content.series[e].items;return s.map(function(e){var s={score:e.score,index:e.index};t.push(s)}.bind(this)),t.sort(function(e,t){return Number(e.score)<Number(t.score)?1:Number(e.score)>Number(t.score)?-1:0}),t},tellStudentAnswer:function(e){this._super(e)},tellCorrectAnswer:function(){this._super(),this.answer=[];var e=this.params.content.series;e.map(function(e){this.answer[e.index]=[];var t=e.items;t.map(function(t){this.answer[e.index][t.index]=0}.bind(this));for(var s=this.getItemsOrderByScore(e.index),i=0!=e.nb?e.nb:e.items.length,n=0;n<i;n++)if(s[n].score>0){var r=s[n].index;this.answer[e.index][r]=1}}.bind(this))},tellEraseAnswer:function(){this.answer=[];var e=this.params.content.series;e.map(function(e){this.answer[e.index]=[];var t=e.items;t.map(function(t){this.answer[e.index][t.index]=0}.bind(this))}.bind(this))}})});