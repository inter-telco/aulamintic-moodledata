define(["ekhil/view/AEldar","lib/Utils","lib/TextHelper","lib/HTMLHelper","ekhil/controller/helper/NavigationHelper"],function(t,e,i,n,s){var r="button",a="visited",d="validated";return t.extend({answer:null,items:null,itemsData:null,nCurrentItemIndex:0,urlButton:null,urlButtonRoll:null,navigationHelper:new s,init:function(t){this._super(t),this.eldar.css({zIndex:-10}),this.answer=[],this.items=[],this.itemsData=[],this.setXML(t),this.drawItems()},drawItems:function(){Console.warn("This function should be overridden in actual implementation")},setXML:function(t){var e=t.querySelector("design");this.designAttributes=this.parseXMLAttributes(e);var i=e.querySelector("params");this.designParamsAttributes=this.parseXMLAttributes(i),this.designTitle=e.querySelector("title"),this.designContent=e.querySelector("content");var n=e.querySelector("link");this.designLinkAttributes=this.parseXMLAttributes(n),this.linksNode=t.querySelector("content>links");var s=t.querySelectorAll("content>items>item");this.createItems(s),this.clickItem(0)},getLinkedNodeIndex:function(t){var e;if(t.hasAttribute("link")){var i=t.getAttribute("link"),n=this.linksNode.querySelector('link[id="'+i+'"]'),s=n.getAttribute("value");e=s.replace(/page:\/\//,"")}return e},createItems:function(t){for(var e,i=t.length,n=0;n<i;n++)e=this.createItem("item_"+n,n,t[n]),this.items.push(e)},createItem:function(t,e,i){var n=this.createItemData(i);this.itemsData[e]=n;var s=$("<div/>");s.css({position:"absolute",width:this.designAttributes.width+"px",height:this.designAttributes.height+"px",boxSizing:"border-box",left:0,top:0,padding:this.designAttributes.padding+"px",overflow:"hidden",cursor:"pointer"}),s.append(this.createItemBackground(i)),s.append(this.createItemTitle(i)),s.append(this.createItemContent(i)),s.append(this.createItemButton(i,n));var r=this.createItemVisited(i,n);s.append(r);var a=this.createItemValidated(i,n);return s.append(a),s.on("click",this.clickCardEvent.bind(this)),this.eldar.append(s),s.get(0)},createItemData:function(t){var e={linkedNodeIndex:"",linkButton:!1,visited:!1,validated:!1};return t&&t.hasAttribute("link")&&(e.linkedNodeIndex=this.getLinkedNodeIndex(t),e.linkButton=t.hasAttribute(r)&&"1"===t.getAttribute(r),e.visited=t.hasAttribute(a)&&"1"===t.getAttribute(a),e.validated=t.hasAttribute(d)&&"1"===t.getAttribute(d)),e},createItemTitle:function(t){var e=t.querySelector("head"),n=i.parseTextNode(e,this.designTitle,this.player.getMediaPath.bind(this.player),null,null,"auto");return $(n).css({pointerEvents:"none","word-wrap":"break-word"}),n},createItemContent:function(t){var e=t.querySelector("content"),n=i.parseTextNode(e,this.designContent,this.player.getMediaPath.bind(this.player),this.textLinkGotoPageFunction.bind(this),null,"calc(100% - "+this.designAttributes.padding+"px)");return n.css({pointerEvents:"none","word-wrap":"break-word"}),n.children("div").css("height","100%"),n},createItemBackground:function(t){var e;if(t.hasAttribute("bg_path")){var i=this.linksNode.querySelector('link[id="'+t.getAttribute("bg_path")+'"]');e=i.getAttribute("value")}e||!this.designAttributes.bg_path&&!this.designAttributes.default_bg||(e=this.designAttributes.bg_path||this.designAttributes.default_bg),e||(e="../medias/carousel_vista_default_bg.png");var s;if(e){var r=this.player.getMediaPath(e);s=new n("image",{src:r,w:this.designAttributes.width,h:this.designAttributes.height,streched:!0,proportional:!1,position:"absolute"}).getElement(),s.css({left:0,top:0})}else s=$("<div/>");return s.css("z-index",-1),s},createItemButton:function(t,e){var i;if(""!==e.linkedNodeIndex&&e.linkButton){i=new Image,this.urlButton=this.player.getMediaPath(this.designLinkAttributes.button_img),this.urlButtonRoll=this.player.getMediaPath(this.designLinkAttributes.button_img_roll);var n=$(i);n.addClass(r),n.css("cursor","pointer"),n.on("load",this.onIconLoaded.bind(this,i,this.designLinkAttributes.button_left,this.designLinkAttributes.button_top,this.designLinkAttributes.button_scale)),i.src=this.urlButton,n.on("click",this.onClickButtonEvent.bind(this)),n.hover(this.switchStateImg.bind(this,n,""!==this.urlButtonRoll?this.urlButtonRoll:this.urlButton),this.switchStateImg.bind(this,n,this.urlButton))}return i},createItemVisited:function(t,e){var i;if(""!==e.linkedNodeIndex&&e.visited){itemNodeIndex=e.link,i=new Image;var n=$(i);n.addClass(a),n.on("load",this.onIconLoaded.bind(this,i,this.designLinkAttributes.visited_left,this.designLinkAttributes.visited_top,this.designLinkAttributes.visited_scale)),i.src=this.player.getMediaPath(this.designLinkAttributes.visited_img),n.hide()}return i},createItemValidated:function(t,e){var i;if(""!==e.linkedNodeIndex&&e.validated){itemNodeIndex=e.link,i=new Image;var n=$(i);n.addClass(d),n.on("load",this.onIconLoaded.bind(this,i,this.designLinkAttributes.validated_left,this.designLinkAttributes.validated_top,this.designLinkAttributes.validated_scale)),i.src=this.player.getMediaPath(this.designLinkAttributes.validated_img),n.hide()}return i},drawButton:function(t,e,i,n,s,a){var d=$(t);d.hasClass(r)?d.css({position:"absolute",left:e+"px",top:i+"px",height:n,width:s}):d.css({position:"absolute",transform:"scale("+a+")",transformOrigin:"0 0",left:e+"px",top:i+"px"})},getIconType:function(t){var e="";return $(t).hasClass(r)?e=r:$(t).hasClass(a)?e=a:$(t).hasClass(d)&&(e=d),e},resizeIcon:function(t,e,i,n,s,r){var a=.01*r,d=a*n,o=a*s,h=.01*e*(this.designAttributes.width-d),u=.01*i*(this.designAttributes.height-o);this.drawButton(t,h,u,o,d,a)},onIconLoaded:function(t,e,i,n){var s=this.getIconType(t);switch(s){case r:var o=new Image;$(o).on("load",function(){var s=this.getBiggerDimensionImage(t,o);this.resizeIcon(t,e,i,s.width,s.height,n)}.bind(this,t,e,i,n,o)),o.src=""!==this.urlButtonRoll?this.urlButtonRoll:this.urlButton;break;case a:case d:this.resizeIcon(t,e,i,t.width,t.height,n)}},getBiggerDimensionImage:function(t,e){var i={};return i.width=t.width>=e.width?t.width:e.width,i.height=t.height>=e.height?t.height:e.height,i},switchStateImg:function(t,e){t.attr("src",e)},refresh:function(){this.refreshAnswer(),this.eldar.parent().css({zIndex:0}),this.refreshItems()},refreshItems:function(){for(var t,e,i=this.items.length,n=0;n<i;n++)t=this.items[n],e=this.itemsData[n],""!==e.linkedNodeIndex&&(e.validated&&this.showHideImage(t.querySelector("img.validated"),this.answer[n]),e.visited&&this.showHideImage(t.querySelector("img.visited"),this.navigationHelper.isSeenNode(e.linkedNodeIndex))),nCurrentItemIndex===n?$(t).css("cursor","default"):$(t).css("cursor","pointer")},showHideImage:function(t,e){e?$(t).show():$(t).hide()},refreshAnswer:function(){var t=this.itemsData.length;this.answer||(this.answer=[]);for(var e=0;e<t;e++)this.answer[e]=this.isItemViewed(e)},isItemViewed:function(t){var e=!1,i=this.itemsData[t];return""!==i.linkedNodeIndex&&(i.validated||i.visited)?i.validated?e=this.navigationHelper.isValidated(i.linkedNodeIndex):i.visited&&(e=this.navigationHelper.isSeenNode(i.linkedNodeIndex)):this.answer[t]&&(e=!0),e},getItemIndex:function(t){for(var e,i,n=this.items.length,s=0;s<n;s++)if(i=$(this.items[s]),t.is(i)){e=s;break}return e},clickItem:function(t){itemData=this.itemsData[t],!itemData||itemData.visited||itemData.validated||(this.answer[t]=!0),nCurrentItemIndex=t},clickCardEvent:function(t){var e=this.getItemIndex($(t.currentTarget));this.clickItem(e),this.refresh()},onClickButtonEvent:function(t){t.stopPropagation();var e=this.getItemIndex($(t.currentTarget).parent());this.player.runCommand("Execute","gotopage",this.itemsData[e].linkedNodeIndex)},textLinkGotoPageFunction:function(t){this.player.runCommand("Execute","gotopage",t)},getAnswer:function(){var t={};t[this.type]=[];for(var e in this.items)t[this.type].push(this.answer[e]?1:0);return JSON.stringify(t)},setAnswer:function(t){if(t)try{for(var e=JSON.parse(t)[this.type],i=this.items.length,n=0;n<i;n++)this.answer[n]=!1;for(var s=e.length,n=0;n<s;n++)this.answer[n]=Boolean(e[n])}catch(r){console.warn("Unable to load student answer.",t)}},getScore:function(){for(var t=0,e=this.answer.length,i=0;i<e;i++)this.answer[i]&&t++;var n=e>0?Math.round(t/e*100):100;return n},correct_response:function(){return""},student_response:function(){return""},correct_response_text:function(){return""},student_response_text:function(){return""}})});