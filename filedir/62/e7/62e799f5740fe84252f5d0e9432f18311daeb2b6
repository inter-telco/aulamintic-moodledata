define(["ekhil/view/AEldar","lib/HTMLHelper","lib/Utils","lib/TextHelper"],function(t,e,s,i){return t.extend({isShown:!1,init:function(t,e,s){this._super.apply(this,arguments),this.params=this.getParamsFromXML(t),this.width=e,this.height=s,this.trueTitleChoice=void 0!=this.params.content.choice[0]?this.params.content.choice[0]:"",this.falseTitleChoice=void 0!=this.params.content.choice[1]?this.params.content.choice[1]:"",this.bAllowAction=!0,this.isShown=!1,this.lines=[],this.texts=[],this.eldar._showGood=!1,this.eldar._showBad=!1,this.eldar._showMissed=!1},getParamsFromXML:function(t){for(var e=t.querySelector("content"),s=e.querySelectorAll("choices>choice"),i=s.length,r=[],a=0;a<i;a++){var n=s[a];r.push(n.textContent)}for(var h=e.querySelectorAll("items>item"),o=h.length,l=[],a=0;a<o;a++){var c=h[a];l.push({answer:c.attributes.answer.value,content:c.textContent})}var d=t.querySelector("design"),m=d.querySelector("items"),p=d.querySelector("items_header"),u=d.querySelector("items_roll"),g=d.querySelector("radiobutton"),f=this.parseXMLAttributes(g),v={};for(var w in f)v[w]=/^file/.test(w)?require("ekhil/EkhilPlayer").getInstance().getMediaPath(f[w]):f[w];return{design:{items:this.parseXMLAttributes(m),items_header:this.parseXMLAttributes(p),items_roll:this.parseXMLAttributes(u),radiobutton:v},content:{choice:r,item:l},left:+d.attributes.left.value,top:+d.attributes.top.value,width:+d.attributes.width.value,height:+d.attributes.height.value}},getMaxHeightTextItems:function(t){var e=0;for(var s in this.params.content.item)e=Math.max(e,i.calculateTextSize(this.params.content.item[s].content,t).height);return e},getStyleHeader:function(){return{fontFamily:this.params.design.items_header.font,color:this.params.design.items_header.fontcolor,fontSize:this.params.design.items_header.fontsize+"px",fontWeight:+this.params.design.items_header.bold?"bold":"normal",fontStyle:+this.params.design.items_header.italic?"italic":"normal",textDecoration:+this.params.design.items_header.underline?"underline":"none",whiteSpace:"nowrap",display:"table-cell",textAlign:"center"}},getStyleItems:function(t){return{fontFamily:this.params.design.items.font,color:this.params.design.items.fontcolor,fontSize:this.params.design.items.fontsize+"px",fontWeight:+this.params.design.items.bold?"bold":"normal",fontStyle:+this.params.design.items.italic?"italic":"normal",textDecoration:+this.params.design.items.underline?"underline":"none"}},getStyleRollItems:function(t){return{color:this.params.design.items_roll.fontcolor,textDecoration:+this.params.design.items_roll.underline?"underline":"none"}},show:function(){if(!this.isShown){for(var t in this.params.content.item)this.params.content.item[t].id=t;var r=Number(this.params.design.radiobutton.width)>0?+this.params.design.radiobutton.width:0,a=Number(this.params.design.radiobutton.height)>0?+this.params.design.radiobutton.height:0,n=Number(this.params.design.items.hspace),h=Number(this.params.design.items.vspace)+5,o=this.getStyleHeader(),l=i.calculateTextSize(this.trueTitleChoice,o),c=i.calculateTextSize(this.falseTitleChoice,o),d=Math.max(r,l.width+4,c.width+4),m=Math.max(l.height,c.height)+10,p=Number(this.params.width)-20,u=p-2*(n+d),g=this.getStyleItems(u),f=this.getMaxHeightTextItems(g),v=Math.max(f,a),w=this.getStyleRollItems(u),_={},b={};_.borderWidth=+this.params.design.items.border?"1px":"0px",_.borderColor=this.params.design.items.bordercolor,_.borderStyle="solid","1"!==this.params.design.items.transparent&&(_.backgroundColor=this.params.design.items.bgcolor,b.backgroundColor=this.params.design.items.alternatecolor);var x={height:h+"px"};0==this.params.design.items.vspace&&(x.display="none");var y=$("<div/>").css($.extend(this.params.listDesign,{position:"absolute",display:"table",width:p+"px",borderCollapse:"collapse"})).appendTo(this.eldar);y.append($("<div/>").css({display:"table-row",height:m+"px",width:"100%"}).append($("<div/>").css({display:"table-cell",width:u+"px",height:m+"px"})).append($("<div/>").css($.extend(o,{width:n+d})).html(this.trueTitleChoice)).append($("<div/>").css($.extend(o,{width:n+d})).html(this.falseTitleChoice)));for(var t=0;t<this.params.content.item.length;t++){var S=[],C="multiTrueFalse_row";t%2!=0&&(C+=" multiTrueFalse_row_alternate");var T=$('<div class="'+C+'"/>').css({display:"table-row",width:"100%",height:v+"px"}),k=$("<div/>").append(this.params.content.item[t].content).css(g).addClass("multiTrueFalse_items_text"),A=$("<div/>").append(k).css({width:u+"px",display:"table-cell","vertical-align":"middle"});$(T).prepend(A);for(var M=0;M<this.params.content.choice.length;M++){var F=new e("checkbox",{text:"",file_width:r,file_height:a,file_normal:this.params.design.radiobutton.file_uncheck_normal,file_checked:this.params.design.radiobutton.file_check_normal,score:M==this.params.content.item[t].answer?1:0}).getElement().css({margin:"0px auto",textAlign:"center"});S.push(F),$(F).data("lineIndex",this.lines.length),$(F).bind("change",s.relegate(this,this.onChkChangedEvent)),$(T).append($("<div/>").css({verticalAlign:"middle",display:"table-cell"}).append(F))}this.texts.push(k),this.lines.push(S),$(y).append(T),t!=this.params.content.item.length-1&&$(y).append('<div class="multiTrueFalse_row_vspace"><div colspan="4"></div></div>')}$(y).find(".multiTrueFalse_row").css(_),$(y).find(".multiTrueFalse_row_alternate").css(b),$(y).find(".multiTrueFalse_row_vspace").css(x),$(y).find(".multiTrueFalse_items_text").hover(function(){$(this).css(w)},function(){$(this).css(g)}),this.isShown=!0,this.eldar.parent().addClass("scrollable"),this.refresh()}},onChkChangedEvent:function(t){for(var e=parseInt($(t.target).data("lineIndex")),s=this.lines[e],i=0;i<s.length;i++)$(s[i]).data("uid")!=$(t.target).data("uid")?s[i].uncheck():s[i].check(),$(s[i]).show()},getAnswer:function(){for(var t={MultiTrueFalse:[]},e=0;e<this.lines.length;e++){for(var s=0,i=0;i<this.lines[e].length;i++)$(this.lines[e][i]).data("checked")&&(s=i+1);t.MultiTrueFalse.push(s)}return JSON.stringify(t)},setAnswer:function(t){try{var e=JSON.parse(t);this.answer="";for(var s in e.MultiTrueFalse)this.answer+=""+e.MultiTrueFalse[s]}catch(i){this.answer=t}},refresh:function(){if(this.answer&&this.answer.length<this.lines.length)for(var t=this.answer.length,e=t;e<this.lines.length;e++)this.answer+="0";for(var e=0;e<this.lines.length;e++)this.texts[e].css("color",this.params.design.items.fontcolor);for(var e=0;e<this.lines.length;e++){var s=this.answer?this.answer.charAt(e):"";s=null==s||""==s?0:parseInt(s);for(var i=1==s&&"1"==this.params.content.item[e].answer||2==s&&"0"==this.params.content.item[e].answer,r=0==s,a=0;a<this.lines[e].length;a++)if(s==a+1)i&&this.eldar._showGood&&!this.isCorrected?(this.lines[e][a].changePicture(this.params.design.radiobutton.file_good),this.texts[e].css("color",this.params.design.items.goodcolor)):i||!this.eldar._showBad||this.isCorrected?(this.lines[e][a].changePicture(this.params.design.radiobutton.file_check_normal),this.texts[e].css("color",this.params.design.items.fontcolor)):(this.lines[e][a].changePicture(this.params.design.radiobutton.file_bad),this.texts[e].css("color",this.params.design.items.badcolor)),this.lines[e][a].check();else{var n=0==a?"1":"0";this.eldar._showMissed&&r&&this.params.content.item[e].answer==n&&!this.isCorrected?(this.lines[e][a].changePicture(this.params.design.radiobutton.file_missed),this.lines[e][a].check(),$(this.texts[e]).css("color",this.params.design.items.missedcolor)):(this.lines[e][a].img_checked.src=this.params.design.radiobutton.file_check_normal,this.lines[e][a].uncheck())}}},getScore:function(){var t=!0,e=0,s=this.params.content.item.length;for(var i in this.lines){for(var r in this.lines[i]){if(t)var a=$(this.lines[i][r]);else var n=$(this.lines[i][r]);t=!t}(a.data("checked")&&"1"==this.params.content.item[i].answer||n.data("checked")&&"0"==this.params.content.item[i].answer)&&e++}return e=0==s?100:Math.round(e/s*100)},getInteraction:function(){var t=this._super();return this.params.content.nb<=36?t.type="matching":(t.type="other",t.correct_responses=[{pattern:this.correct_response().substring(0,4e3)}],t.student_response=this.student_response().substring(0,4e3)),t},correct_response:function(){for(var t=new Array,e=this.params.content.item.length,s=0;s<e;s++)t.push("item_"+s+"[.]"+("1"==this.params.content.item[s].answer?this.trueTitleChoice:this.falseTitleChoice));return t.join("[,]")},student_response:function(){var t=!0,e=new Array;for(var s in this.lines)for(var i in this.lines[s]){if($(this.lines[s][i]).data("checked")){var r=t?0:1;e.push("item_"+this.params.content.item[s].id+"[.]"+this.params.content.choice[r])}t=!t}return e.join("[,]")},student_response_text:function(){var t=new Array,e=!0;for(var s in this.lines){for(var i in this.lines[s]){if(e)var r=this.lines[s][i];else var a=this.lines[s][i];e=!e}var n="";n=r.data("checked")?this.trueTitleChoice:a.data("checked")?this.falseTitleChoice:"-",t.push((Number(s)+1).toString()+". "+this.params.content.item[Number(s)].content+" = "+n)}return t.join(String.fromCharCode(13))},correct_response_text:function(){for(var t=this.params.content.item.length,e=new Array,s=0;s<t;s++)e.push(""+(s+1)+". "+this.params.content.item[s].content+" = "+("1"==this.params.content.item[s].answer?this.trueTitleChoice:this.falseTitleChoice));return e.join(String.fromCharCode(13))},tellEraseAnswer:function(){this.answer="";for(var t=this.params.content.item.length,e=0;e<t;e++)this.answer+="0"},tellEraseBadAnswer:function(){this.answer="";var t=!0;for(var e in this.lines){for(var s in this.lines[e]){if(t)var i=$(this.lines[e][s]);else var r=$(this.lines[e][s]);t=!t}"1"==this.params.content.item[e].answer&&i.data("checked")||"0"==this.params.content.item[e].answer&&r.data("checked")?this.answer+="1"==this.params.content.item[e].answer?"1":"2":this.answer+="0"}},tellCorrectAnswer:function(){this._super(),this.answer="";for(var t=this.params.content.item,e=t.length,s=0;s<e;s++)"1"==t[s].answer?this.answer+="1":this.answer+="2"}})});