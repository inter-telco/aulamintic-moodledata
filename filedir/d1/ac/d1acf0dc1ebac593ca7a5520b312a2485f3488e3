define(["ekhil/view/AEldar","lib/TextHelper","lib/Utils","lib/HTMLHelper"],function(t,e,i,s){return t.extend({init:function(t,r,n,h){this._super.apply(this,arguments),this.answer=-1,this.currentItemRank=0,this.isPropHidden=!0,this.content=void 0;var o=t.querySelector("content > items"),a=this.parseXMLAttributes(o);this.content={shuffleItems:"1"===a.mix,hideQuestion:"1"===a.hide,showPropDelay:1e3*Number(a.time),maxAnswerTime:1e3*Number(a.thought)},this.content.items=[],this.displayOrder=[];for(var u=o.querySelectorAll("item"),l=0,c=u.length;l<c;l++){var d={score:Number(u[l].getAttribute("score")),text:u[l].textContent};this.content.items.push(d),this.displayOrder.push(l)}this.content.shuffleItems&&(this.displayOrder=i.object_shuffle(this.displayOrder)),this.eldar.css({position:"relative"}),this.eldar.get(0).id="eldar",this.eldar.hide(),this.screenWidth=r,this.screenHeight=n;var p=t.querySelector("design"),m=this.parseXMLAttributes(p),f=this.parseXMLAttributes(p.querySelector("proposition")),w=this.parseXMLAttributes(p.querySelector("accept")),g=this.parseXMLAttributes(p.querySelector("refuse"));f=e.parseDesignNode(this.updateCoordinate(f,m.width,m.height)),w=this.updateCoordinate(w,m.width,m.height),g=this.updateCoordinate(g,m.width,m.height),this.propText=document.createElement("div"),$(this.propText).css($.extend(f,{position:"absolute"})),this.propText.id="propText",this.btAccept=s.button(i.relegate(this,this.onAccept),w,this.player.getMediaPath(w.image_normal),this.player.getMediaPath(w.image_over),this.player.getMediaPath(w.image_down),this.player.getMediaPath(w.image_off)),this.btAccept.id="btAccept",this.btRefuse=s.button(i.relegate(this,this.onRefuse),g,this.player.getMediaPath(g.image_normal),this.player.getMediaPath(g.image_over),this.player.getMediaPath(g.image_down),this.player.getMediaPath(g.image_off)),this.btRefuse.id="btRefuse",this.eldar.append(this.propText),this.eldar.append(this.btAccept),this.eldar.append(this.btRefuse)},show:function(){$(this.eldar).show()},refresh:function(){this.hasNextItem()?this.btRefuse.enable():this.btRefuse.disable(),this.setProp(this.getCurrentItem()),this.showFeedback||(this.isPropHidden?this.startShowPropTimer():this.onShowProp())},startShowPropTimer:function(){this.setPropVisible(!1),this.setBtEnabled(!1),this.content.showPropDelay>0?(this.showPropId&&clearTimeout(this.showPropId),this.showPropId=setTimeout(this.onShowPropTimeout.bind(this),this.content.showPropDelay)):this.onShowPropTimeout()},onShowPropTimeout:function(){this.showPropId&&clearTimeout(this.showPropId),this.setPropVisible(!0),this.setBtEnabled(!0),this.onShowProp()},onShowProp:function(){this.content.hideQuestion&&this.setQuestionVisible(this.isPropHidden),this.content.maxAnswerTime>0&&(this.clearAnswerTimeout(),this.answerTimeoutId=setTimeout(this.onAnswerTimeout.bind(this),this.content.maxAnswerTime))},clearAnswerTimeout:function(){this.answerTimeoutId&&clearTimeout(this.answerTimeoutId)},onAnswerTimeout:function(){this.tellValidatePage(),this.clearAnswerTimeout()},updateCoordinate:function(t,e,i){var s=$.extend({},t,{width:t.width*e/100,height:t.height*i/100,top:t.top*i/100,left:t.left*e/100});return s},setQuestionVisible:function(t){t===!1&&this.player.runCommand("Execute","hide_question")},setPropVisible:function(t){t=t!==!1,this.propText.style.display=t?"block":"none",this.isPropHidden=!t},setBtEnabled:function(t){t=t!==!1,t?(this.btAccept.enable(),this.btRefuse.enable()):(this.btAccept.disable(),this.btRefuse.disable())},setProp:function(t){this.propText.innerHTML=t?t.text:""},onRefuse:function(){this.hasNextItem()&&(this.getNextItem(),this.refresh())},onAccept:function(){this.answer=this.currentItemRank,this.tellValidatePage()},getItemByIndex:function(t){return this.content.items[t]},getItemIndex:function(t){return this.displayOrder[t]},getItemByRank:function(t){return this.getItemByIndex(this.getItemIndex(t))},getItemRank:function(t){return this.displayOrder.indexOf(t)},getCurrentItem:function(){return this.getItemByRank(this.currentItemRank)},hasNextItem:function(){return this.currentItemRank<this.content.items.length-1},getNextItem:function(){var t=null;return this.hasNextItem()&&(this.currentItemRank++,t=this.getCurrentItem()),t},tellAnswer:function(t){this.answer=t,this.currentItemRank=t===-1?0:t},tellValidatePage:function(){this.clearAnswerTimeout(),this.showFeedback=!0,this.player.runCommand("GoNextPage")},tellEraseAnswer:function(){this.tellAnswer(-1)},tellEraseBadAnswer:function(){console.warn("AEldar.tellEraseBadAnswer() NA to this AEldar.")},tellCorrectAnswer:function(){this._super(),this.tellAnswer(this.getItemRank(Number(this.getCorrectAnswer())))},tellStudentAnswer:function(t){this._super(t)},tellShowBadAnswer:function(){this._super()},tellShowGoodAnswer:function(){this._super()},tellShowMissedAnswer:function(){this._super()},tellClearFeedbackActions:function(){this._super(),this.showFeedback=!1,this.hidden=!0},allowAction:function r(r){this._super(),this.setBtEnabled(r)},getScore:function(){return this.answer!==-1?this.getItemByRank(this.answer).score:0},getAnswer:function(){var t={};return t[this.type]=this.answer,t.rnd=this.displayOrder,JSON.stringify(t)},setAnswer:function(t){if(this._super(),t){var e=i.parseJson(t);if(e){var s=i.isEmpty(e[this.type])?e[this.type.toLowerCase()]:e[this.type];this.tellAnswer(s),this.displayOrder=e.rnd}var r=this.displayOrder.length,n=this.content.items.length;if(n>r)for(var h=r;h<n;h++)this.displayOrder.push(h)}},getCorrectAnswer:function(){var t,e,i=0;for(var s in this.content.items)if(e=this.content.items[s],e.score>i&&(i=Number(e.score),t=s,100==i))break;return t},getCorrectAnswerItem:function(){return this.getItemByIndex(this.getCorrectAnswer())},correct_response_text:function(){return this.getCorrectAnswerItem().text},correct_response:function(){var t=this.correct_response_text();return t.substring(0,4e3)},student_response_text:function(){return this.answer!==-1?this.getItemByRank(this.answer).text:""},student_response:function(){var t=this.student_response_text();return t.substring(0,4e3)},hide:function(){this.clearAnswerTimeout(),clearTimeout(this.showPropId)}})});