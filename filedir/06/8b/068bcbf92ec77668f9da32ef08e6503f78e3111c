define(["ekhil/view/AEldar","lib/Config","lib/constants/TrackingAPIVersion","lib/HTMLHelper","lib/ScormHelper","lib/Utils","lib/TextHelper"],function(t,e,s,r,n,i,a){return t.extend({init:function(t,e,s){this._super.apply(this,arguments),this.params=this.getParamsFromXML(t),this.eldar._showGood=!1,this.eldar._showBad=!1,this.eldar._showMissed=!1,this.answer=[],this.regExpression='<a href="#([0-9]+)"[^>]*>(.+?)</a>',this._getHoles(),this._generateId(),this.drawElfe()},getParamsFromXML:function(t){for(var e=t.querySelector("content"),s=e.querySelectorAll("hole"),r=s.length,n=[],i=0;i<r;i++){for(var o=s[i],h=o.querySelectorAll("prop"),l=h.length,c=[],p=0;p<l;p++){var d=h[p];c.push({text:d.textContent})}n.push(c)}var u=t.querySelector("design"),f=u.querySelector("text"),g=a.parseDesignNode(f);g.goodcolor=f.attributes.goodcolor.value,g.badcolor=f.attributes.badcolor.value;var v=u.querySelector("hole"),m=v.querySelector("hole_text");return{content:{text:e.querySelector("text").textContent,holes:n},elfe:{hole:a.parseDesignNode(v),text:g,hole_text:m.textContent}}},show:function(){this._super(),$(this.eldar).find("input").each(i.relegate(this,this.initFields))},initFields:function(t,e){this.setField($(e).data("id"),$(e).val())},drawElfe:function(){this.eldar.css($.extend(this.params.elfe.text,{width:"100%",height:"100%",whiteSpace:"pre-wrap"})),this.eldar.addClass("scrollable");var t=this,e=this.params.content.text,s=new RegExp(this.regExpression,"g");e=e.replace(s,'<input type="text" value="'+this.params.elfe.hole_text+'"/>'),this.eldar.append(e);var r=$('<span style="display:none" />');r.css(this.params.elfe.hole),this.eldar.append(r),$(this.eldar).find("input").each(function(e){$(this).data("id",n.getScormIdentifier(e)),$(this).data("value",t.params.elfe.hole_text)}),$(this.eldar).find("input").focusin(function(){$(this).val()==t.params.elfe.hole_text&&$(this).val("")}),$(this.eldar).find("input").focusout(function(){""==$(this).val()&&$(this).val(t.params.elfe.hole_text)}),$(this.eldar).find("input").change(function(){t.setField($(this).data("id"),$(this).val())}),$(this.eldar).find("input").keyup(function(){t.setField($(this).data("id"),$(this).val(),!0)}),$(this.eldar).find("input").css($.extend(this.params.elfe.hole,{margin:0,padding:0,borderStyle:"none",background:"none"}))},setField:function(t,e,s){this.answer[t]=e;var r=this;$(this.eldar).find("input").each(function(n){var i=$(this).data("id");if(t===i){$(this).val(e),s||""!=$(this).val()||$(this).val(r.params.elfe.hole_text);var a=$(r.eldar).find("span").last();a.text($(this).val());var o=a.width()+2;$(this).css("width",o),r.player.container.addInputListeners($(this))}})},getAnswer:function(){for(var t={},e=this.params.content.holes.length,s=0;s<e;s++){var r=this.params.content.holes[s].id;void 0!==this.answer[r]?t[r]=this.answer[r]:t[r]=""}return JSON.stringify(t)},setAnswer:function(t){this.tellEraseAnswer();try{for(var t=JSON.parse(t),e=this.params.content.holes.length,s=0;s<e;s++){var r=this.params.content.holes[s].id;this.setField(r,t[r])}}catch(n){}},_isCorrect:function(t,e){e=e||"";var s=!1,r=!1,n=0;if(t)for(var i=t.length;n<i&&!r;){var a="^"+t[n].text.toLowerCase().trim().replace(/\*/g,".*").replace(/\?/g,".")+"$",o=new RegExp(a,"i");o.test(e.toLowerCase().trim())&&(r=!0,s=!0),n++}return s},getScore:function(){for(var t=0,e=0,s=0,r=this.params.content.holes.length,n=0;n<r;n++){var i=this.params.content.holes[n].id;this._isCorrect(this.params.content.holes[n],this.answer[i])&&s++,e++}return e>0&&(t=Math.round(s/e*100)),t},getInteraction:function(){var t=this._super(),r=this._getGoodResponsesCombinaisons(!0);if(e.trackingAPIVersion==s.SCORM_2004)if(r.length>=5){t.type="other";var n="{case_matters=false}{lang=en}"+this.correct_response_text;t.correct_responses=[{pattern:n.substring(0,4e3)}];var n="{case_matters=false}{lang=en}"+this.student_response_text;t.student_response=[{pattern:n.substring(0,4e3)}]}else t.type="long-fill-in";else r.length>=5?(t.type="performance",t.correct_responses=[{pattern:this.correct_response_text().substring(0,250)}],t.student_response=[{pattern:this.student_response_text().substring(0,250)}]):t.type="fill-in";return t},_getFullText:function(t,e){for(var s=t,r=new RegExp(this.regExpression,"i"),n=e.length,i=0;null!==s.match(r)&&i<n;)s=s.replace(r,e[i]),i++;return s},student_response:function(){for(var t=new Array,e=($(this.eldar).text(),this.params.content.holes.length),s=0,r=0;r<e;r++)s=this.params.content.holes[r].id,void 0!==this.answer[s]?t.push(this.answer[s]):t.push(this.params.elfe.hole_text);var n=this._getFullText(this.params.content.text,t);return n.substring(0,4e3)},_getGoodResponsesCombinaisons:function(t){for(var e=new Array,s=this.params.content.holes.length,r=0;r<s;r++){var n=this.params.content.holes[r].length;e[r]=new Array,t||(n=1);for(var i=0;i<n;i++)e[r][i]=this.params.content.holes[r][i].text}var a=this.getAllCombinaisons(e,0);return a},correct_response:function(){for(var t=[],e=this._getGoodResponsesCombinaisons(!0),s=e.length,r=0;r<s;r++){var n=this._getFullText(this.params.content.text,e[r]);t[r]={},t[r].pattern="{case_matters=false}{lang=en}"+n}return t},student_response_text:function(){var t=this.student_response();return t},correct_response_text:function(){var t=this._getGoodResponsesCombinaisons(!1);return this._getFullText(this.params.content.text,t[0])},refresh:function(){$(this.eldar).show(),this.showContent()},showContent:function(){$(this.eldar).find("input").css({color:this.params.elfe.hole.color}),$(this.eldar).find("input").each(i.relegate(this,this.showColoredResponses)),this._refreshAnswer()},showColoredResponses:function(t,e){var s=($(this).data("id"),this._isCorrect(this.params.content.holes[t],$(e).val()));!this.eldar._showBad||s||this.isCorrected||$(e).css("color",this.params.elfe.text.badcolor),this.eldar._showGood&&s&&!this.isCorrected&&$(e).css("color",this.params.elfe.text.goodcolor)},_refreshAnswer:function(){var t=this;$(this.eldar).find("input").each(function(){var e=$(this).data("id");void 0!=t.answer[e]&&t.setField(e,t.answer[e])})},_generateId:function(){for(var t=this.params.content.holes.length,e=0,s=0;s<t;s++){this.params.content.holes[s].id=n.getScormIdentifier(s);for(var r=this.params.content.holes[s].length,i=0;i<r;i++)this.params.content.holes[s][i].id=e,e++}},_getHoles:function(){for(var t=this.params.content.text,e=new RegExp(this.regExpression,"g"),s=0;null!==(aHoles=e.exec(t));){var r=aHoles[2];this.params.content.holes[s][this.params.content.holes[s].length]={text:r},s++}},getAllCombinaisons:function(t,e){var s=[];if(t.length>e+1)var r=this.getAllCombinaisons(t,e+1);for(var n=t[e].length,i=0;i<n;i++){var a=[t[e][i]];if(r)for(var o=r.length,h=0;h<o;h++)s.push(a.concat(r[h]));else s.push(a)}return s},tellEraseAnswer:function(){for(var t=this.params.content.holes.length,e=0;e<t;e++){var s=this.params.content.holes[e].id;this.answer[s]=""}},tellEraseBadAnswer:function(){for(var t=this.params.content.holes.length,e=0;e<t;e++){var s=this.params.content.holes[e].id;this._isCorrect(this.params.content.holes[e],this.answer[s])||(this.answer[s]="")}},tellCorrectAnswer:function(){this._super();for(var t=this.params.content.holes.length,e=0;e<t;e++){var s=this.params.content.holes[e].id;if(!this._isCorrect(this.params.content.holes[e],this.answer[s])){var r=this.params.content.holes[e].length-1;this.answer[s]=this.params.content.holes[e][r].text}}}})});