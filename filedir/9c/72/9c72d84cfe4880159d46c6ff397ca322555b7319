define(["ekhil/view/AEldar","lib/Config","lib/ArrayHelper","lib/ScormHelper","lib/constants/TrackingAPIVersion","ekhil/view/eldarcomponent/DragItem","ekhil/view/eldarcomponent/DragAnswerItem","ekhil/view/eldarcomponent/DropZone","lib/Utils"],function(t,e,r,n,s,i,o,a,c){var u=t.extend({init:function(t){this._super.apply(this,arguments),this.correctAnswer=null,this.items=[],this.zones=[],this.answer=[],this.params={magnet:!0}},refresh:function(){this.zones.forEach(function(t){t.attachedItems=[]}),this.items.forEach(function(t){this.refreshItem(t)}.bind(this))},refreshItem:function(t){t.refresh()},isItemPlaced:function(t){return this.answer[t.id].target!==-1},adjustPlacedItem:function(t){if(this.params.magnet){var e=this.answer[t.id],r=this.zones[e.target].getCenter();t.setCenter(r)}},getScore:function(){for(var t=0,e=this.answer.length,r=0;r<e;r++)this.isCorrectAnswerItem(r)&&t++;var n=0!==e?100*t/e:0;return n},getAnswer:function(){var t=this._super();return t},setAnswer:function(t){var e=this._super(t);return c.isEmpty(e)||(e=this.answer.map(function(t){return o.create().setTarget(t.target).setInfos(t.infos)}),this.answer=e),e},getInitAnswer:function(){var t=this.items.map(function(t){return o.create()}.bind(this));return t},getCorrectAnswer:function(){if(null===this.correctAnswer){var t=this.items.slice();t.sort(function(t,e){return t.id-e.id}),this.correctAnswer=t.map(function(t){var e=this.getCorrectAnswerItem(t);return e}.bind(this))}return this.correctAnswer},getCorrectAnswerItem:function(t){var e=o.create().setTarget(t.zone);return e},getItemById:function(t){return r.find(this.items,function(t,e){return e.id===t}.bind(null,t))},isCorrectAnswerItem:function(t){var e,r=this.answer[t],n=this.getItemById(t);if(Array.isArray(r.target))for(var s=0;s<r.target.length;s++)e=n.zone===r.target[s].zoneId;else e=n.zone===r.target;return e},tellCorrectAnswer:function(){this._super(),this.answer=this.getCorrectAnswer()},tellEraseAnswer:function(){this._super(),this.answer=this.getInitAnswer()},tellEraseBadAnswer:function(){this._super();for(var t=[],e=this.items.length,r=0;r<e;r++){var n=this.isCorrectAnswerItem(r);t.push(n?this.answer[r]:o.create())}this.answer=t},LMS_FORMAT_SEPARATOR:"\n",LMS_FORMAT_SUBSEPARATOR:" : ",getLMSFormattedSource:function(t){return t},getLMSFormattedTarget:function(t){return t.target},getLMSFormattedPrefix:function(t){return""},formatLmsResponseText:function(t){var e=this.getLMSFormattedSource.bind(this),r=this.getLMSFormattedTarget.bind(this),n=this.getLMSFormattedPrefix.bind(this);return this.formatAnswer(t,this.formatAnswerItem.bind(this,e,r,this.LMS_FORMAT_SUBSEPARATOR,n),this.LMS_FORMAT_SEPARATOR)},formatAnswer:function(t,e,r){var n=t.map(function(t,e,r){return t(e,r)}.bind(this,e)),s=n.join(r);return s},formatAnswerItem:function(t,e,r,n,s,i){return n(i)+t(i)+r+e(s)},formatScormResponse:function(t){var r,i,o,a;switch(e.trackingAPIVersion){default:case s.SCORM_2004:r=function(t){return n.getScormIdentifier(t,n.SOURCE)}.bind(this),i=function(t){return n.getScormIdentifier(t.target,n.TARGET)}.bind(this),o="[,]",a="[.]";break;case s.SCORM_12:r=function(t){return n.getScormIdentifier(t,n.SOURCE)}.bind(this),i=function(t){return n.getScormIdentifier(t.target,n.TARGET)}.bind(this),o=",",a="."}var c=function(){return""},u=this.formatAnswer(t,this.formatAnswerItem.bind(this,r,i,a,c),o);return u},correct_response:function(){return this.formatScormResponse(this.getCorrectAnswer())},student_response:function(){return this.formatScormResponse(this.answer)},correct_response_text:function(){return this.formatLmsResponseText(this.getCorrectAnswer())},student_response_text:function(){return this.formatLmsResponseText(this.answer)}});return u});