define(["ekhil/view/AEldar","lib/HTMLHelper","lib/Utils","lib/ScormHelper","lib/TextHelper","lib/DragAndDrop"],function(t,e,i,s,r){var o="fb_none",n="fb_good",a="fb_bad",h="fb_missed";return t.extend({titlePadding:4,isShown:!1,init:function(t,e,s,r){this._super.apply(this,arguments),this.params=this.getParamsFromXML(t),this.pickerOrder=this.params.propositions.map(function(t){return t.index}),this.params.random&&(this.pickerOrder=i.object_shuffle(this.pickerOrder)),this.isShown=!1,this.width=e,this.height=s,i.removeUserSelect(this.eldar)},getParamsFromXML:function(t){for(var e=t.querySelector("design"),i=t.querySelector("picker"),s=r.parseDesignNode(i),o=i.querySelector("picker_title").textContent,n=this.parseXMLAttributes(i),a=t.querySelector("list"),h=r.parseDesignNode(a),p=this.parseXMLAttributes(a),l=[],d=[],c=0,g=t.querySelector("themes"),m=g.querySelectorAll("theme"),f=m.length,u=0;u<f;u++){var b=m[u].querySelector("title"),v=b?b.textContent:m[u].firstChild.textContent;l.push({title:v});for(var w=m[u].querySelectorAll("prop"),x=w.length,k=0;k<x;k++)w[k].textContent&&(d.push({index:c,column:u,text:w[k].textContent}),c++)}return{random:g.hasAttribute("random")&&"1"===g.getAttribute("random"),design:this.parseXMLAttributes(e),listDesign:$.extend(h,{width:p.width+"%",height:p.height+"%",left:p.left+"%",top:p.top+"%",missedcolor:p.missedcolor,badcolor:p.badcolor,goodcolor:p.goodcolor,transparent:p.transparent,titleColor:p.title_fontcolor,titleBackground:p.title_bgcolor,bordercolor:p.bordercolor,hspace:p.hspace,vspace:p.vspace}),pickerDesign:$.extend(s,{width:n.width+"%",left:n.left+"%",top:n.top+"%",transparent:n.transparent,fontcolor:n.fontcolor,underline:"1"===n.underline,italic:"1"===n.italic,bold:"1"===n.bold,fontsize:n.fontsize,font:n.font,align:n.align}),pickerTitle:{color:n.title_fontcolor,backgroundColor:n.title_bgcolor,transparent:n.transparent,title:o},columns:l,propositions:d}},show:function(){if(this.eldar.css({cursor:"pointer"}),!this.isShown){var t=$("<div/>").css($.extend(this.params.listDesign,{position:"absolute",display:"table"})).appendTo(this.eldar),e=+i.removeCSSUnit(this.params.listDesign.height)/100*this.params.design.height;this.tableColumns=[];var s=this.params.columns.length;if(s>0){var r=""!==this.params.listDesign.border?this.params.listDesign.borderWidth+" "+this.params.listDesign.borderStyle+" "+this.params.listDesign.borderColor:"none",o=$("<div>").css({width:"100%",display:"table"}).appendTo($("<div/>").css({display:"table-row"}).appendTo(t)),n=$("<div>").css({display:"table"}).appendTo($("<div/>").css({display:"table-row"}).appendTo(t)),a=[];$.fn.resetDropZone();for(var h=Math.floor(100/s),p=0;p<s;p++){var l=$("<div/>").css({display:"table-cell",top:0,left:p*h+"%",width:h+"%",padding:this.titlePadding+"px",color:this.params.listDesign.titleColor,backgroundColor:"1"==this.params.listDesign.transparent?"none":this.params.listDesign.titleBackground}).text(this.params.columns[p].title).appendTo(o);l.css({height:"100%"});var d=$("<div/>").css({borderTop:r,display:"table-cell",width:h+"%",verticalAlign:"top",height:"100%"}).appendTo(n);p>0&&(l.css("borderLeft",r),d.css("borderLeft",r));var c=$("<div/>").appendTo(d);a.push(c);var g=$("<div/>").css({display:"table",width:"100%"}).appendTo(c);d.data("index",p).droppable(),g.data("index",p).droppable(),this.tableColumns.push(g)}var m=o.height(),f=e-m;this.tableColumns.map(function(t){t.css({height:f+"px"})}),a.map(function(t){t.css({height:f+"px",overflow:"hidden"})}),n.css({top:m+"px",width:"100%",height:f+"px",overflow:"hidden"})}var u=""!==this.params.pickerDesign.border?this.params.pickerDesign.borderWidth+" "+this.params.pickerDesign.borderStyle+" "+this.params.pickerDesign.borderColor:"none",b=$("<div/>").css($.extend(this.params.pickerDesign,{position:"absolute",display:"table",borderCollapse:"seperate"})).appendTo(this.eldar),v=0;if(""!==this.params.pickerDesign.title&&"undefined"!=this.params.pickerTitle.title){var w=$("<div/>").css({display:"table-row"}).appendTo(b).addClass("scrollable"),x=$("<div/>").css($.extend(this.params.pickerTitle,{border:u,background:"1"==this.params.pickerTitle.transparent?"none":this.params.pickerTitle.backgroundColor})).text(this.params.pickerTitle.title).appendTo(w);v=x.height(),w.css({height:v+"px"})}var k=i.removeCSSUnit(this.params.pickerDesign.height)/100*this.params.design.height-v,D=$("<div/>").css({display:"table-row",border:u,background:"1"==this.params.pickerDesign.transparent?"none":this.params.pickerDesign.backgroundColor}).appendTo(b),S=$("<div/>").css({height:k,overflowY:"auto"}).appendTo(D);this.picker=$("<div/>").css({top:0,left:0,width:"100%",display:"table",borderCollapse:"seperate",borderSpacing:"10px"}).appendTo(S),this.isShown=!0}this.refresh()},refresh:function(){if(this.isShown&&this.params.columns.length){var t=[],e=this.params.columns.length;if(this.tableColumns)for(var s=0;s<e;s++){for(var r=this.tableColumns[s];r.get(0).firstChild;)r.get(0).removeChild(r.get(0).firstChild);if(this.answer[s]&&this.answer[s].length>0)for(var h,p=this.answer[s].length,l=0;l<p;l++){var d=this.getProposition(this.answer[s][l]);t.push(d.index),h=o,this.isCorrected||(this.isCorrectAnswerItem(d,s)?this.eldar._showGood&&(h=n):this.eldar._showBad&&(h=a));this.drawItem(d.index,d.text,h).appendTo(r)}else this.drawItem(-1,"",o).appendTo(r);for(var c=20;r.height()>r.parent().height()&&c-- >0;)r.children().each(function(t,e){i.decreaseTextSize($(e))})}for(var g=this.params.propositions.length;this.picker.get(0).firstChild;)this.picker.get(0).removeChild(this.picker.get(0).firstChild);if(g>t.length)for(var m=this.pickerOrder.length,s=0;s<m;s++){var d=this.getProposition(this.pickerOrder[s]);t.indexOf(d.index)===-1&&this.drawItem(d.index,d.text,o).appendTo(this.picker)}}},drawItem:function(t,e,i){var s=""!==this.params.pickerDesign.border?this.params.pickerDesign.borderWidth+" "+this.params.pickerDesign.borderStyle+" "+this.params.pickerDesign.borderColor:"none",p=$("<div/>").css({display:"table-row",minWidth:"2px",minHeight:"2px",borderBottom:t!==this.pickerOrder.length-1?s:null}),l=r.calculateTextSize(e,{fontFamily:this.params.pickerDesign.font,fontSize:this.params.pickerDesign.fontsize,fontStyle:this.params.pickerDesign.italic?"italic":"normal",fontWeight:this.params.pickerDesign.bold?"bold":"normal"}),d=$("<div/>").css({cursor:"pointer",display:"inline",width:l.width+"px"}).text(e).data("index",t);if(d.draggable(),d.on({dragstart:this.onDragStart.bind(this),dragend:this.onDragEnd.bind(this)}),i)switch(i){case n:d.css({color:this.params.listDesign.goodcolor});break;case a:d.css({color:this.params.listDesign.badcolor});break;case h:d.css({color:this.params.listDesign.missedcolor});break;case o:default:d.css({})}return p.append(d),p},getProposition:function(t){return this.params.propositions[t]},isCorrectAnswerItem:function(t,e){return t.column===e},onDragStart:function(t){var e=$(t.target),i=($("#container"),{fontSize:e.css("fontSize"),fontFamily:e.css("fontFamily"),color:e.css("color"),maxWidth:e.css("width"),width:"auto"}),s=e.clone();e.data("clone",s),e.parent().append(s),e.appendTo("#container"),e.css(i)},onDragEnd:function(t){var e=$(t.target),i=e.data("index");if(this.answer.map(function(t){if(t){var e=t.indexOf(i);e>-1&&t.splice(e,1)}}),e.data("attached")){var s=e.data("attached")[0],r=$(s).data("index");isNaN(r)||(null!==this.answer[r]&&void 0!==this.answer[r]||(this.answer[r]=[]),this.answer[r].push(i))}e.remove(),this.refresh()},getScore:function(){var t=0,e=0;if(this.answer){for(var i=this.params.propositions.length,s=0;s<i;s++)this.answer[this.getProposition(s).column]&&this.answer[this.getProposition(s).column].indexOf(this.getProposition(s).index)>-1&&e++;i>0&&(t=Math.round(100*e/i))}return t},tellEraseBadAnswer:function(){if(this.answer)for(var t=this.answer.length,e=t-1;e>=0;e--)for(var i=this.answer[e].length,s=i-1;s>=0;s--)this.getProposition(this.answer[e][s]).column!=e&&this.answer[e].splice(s,1)},tellCorrectAnswer:function(){this._super(),this.tellEraseAnswer();for(var t=this.params.propositions.length,e=0;e<t;e++)this.answer[this.getProposition(e).column]||(this.answer[this.getProposition(e).column]=[]),this.answer[this.getProposition(e).column].push(this.getProposition(e).index)},student_response:function(){for(var t=[],e=this.answer.length,i=0;i<e;i++)if(this.answer[i])for(var r=this.answer[i].length,o=0;o<r;o++)t.push("column_"+s.getScormIdentifier(i)+"[.]response_"+s.getScormIdentifier(this.getProposition(this.answer[i][o]).index));return t.join("[,]")},student_response_text:function(){for(var t=[],e=this.answer.length,i=0;i<e;i++)if(this.answer[i])for(var s=this.answer[i].length,r=0;r<s;r++)t.push(i+"; "+r+" : "+this.getProposition(this.answer[i][r]).text);return t.join("\n")},correct_response:function(){for(var t=this.params.propositions.length,e=[],i=0;i<t;i++)e.push("column_"+s.getScormIdentifier(this.getProposition(i).column)+"[.]response_"+s.getScormIdentifier(this.getProposition(i).index));return e.join("[,]")},correct_response_text:function(){for(var t=[],e=this.params.propositions.length,i=0;i<e;i++)t.push(this.getProposition(i).column+"; "+this.getProposition(i).index+" : "+this.getProposition(i).text);return t.join("\n")}})});