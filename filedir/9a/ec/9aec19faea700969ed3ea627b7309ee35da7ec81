define(["eldar/ADragEldar","ekhil/view/eldarcomponent/DragItem","ekhil/view/eldarcomponent/DropZone","ekhil/view/eldarcomponent/DragAnswerItem","lib/ArrayHelper","lib/Utils","lib/TextHelper"],function(t,e,i,s,r,n,o){var a=t.extend({LMS_FORMAT_SUBSEPARATOR:" --> ",init:function(t,e,i){this._super.apply(this,arguments),this.headersNode=[],this.propsInfo=[],this.props=[],this.itemsInfo=[];var s=this.getItemsFromXML(t);this.infos=this.getEldarInfosFromXML(t),this.designPicker=this.getPickInfosFromXML(t),this.designList=this.getListInfosFromXML(t),this.setPropsAndItemsInfos(s),this.setItems(),this.drawPick(),this.drawList()},getItemsFromXML:function(t){var e=[];this.headersNode=t.querySelectorAll("headers>header");for(var i=t.querySelectorAll("lines>line"),s=0;s<i.length;s++){var n=i[s],o=r.fromList(n.querySelectorAll("prop"));e.push(o)}return e},getEldarInfosFromXML:function(t){var e=t.querySelector("design"),i=e.getAttribute("width"),s=e.getAttribute("height");return{left:e.getAttribute("left"),top:e.getAttribute("top"),width:i,height:s,hscale:.01*i,vscale:.01*s}},getPickInfosFromXML:function(t){var e=t.querySelector("design>picker"),i=o.parseDesignNode(e);return i.width=n.getAttribute(e,"width","72")*this.infos.hscale,i.height=n.getAttribute(e,"height","35")*this.infos.vscale,i.top=n.getAttribute(e,"top","16.726")+"%",i.left=n.getAttribute(e,"left","0")+"%",i.position="absolute",i.userSelect="none",i.fontcolor=n.getAttribute(e,"fontcolor","#000"),i},getListInfosFromXML:function(t){var e=t.querySelector("design>list");return{title_bgcolor:n.getAttribute(e,"title_bgcolor","#FFF"),title_fontcolor:n.getAttribute(e,"title_fontcolor","#000"),fontcolor:n.getAttribute(e,"fontcolor","#000"),hspace:n.getAttribute(e,"hspace","20"),vspace:n.getAttribute(e,"vspace","20"),missedcolor:n.getAttribute(e,"missedcolor","#FF9900"),badcolor:n.getAttribute(e,"badcolor","#FF9900"),goodcolor:n.getAttribute(e,"goodcolor","#29B796"),border:parseInt(n.getAttribute(e,"border",0)),borderColor:n.getAttribute(e,"bordercolor","#000"),textAlign:n.getAttribute(e,"align","center"),transparent:parseInt(n.getAttribute(e,"transparent",0)),underline:o.getEquivalence("underline",parseInt(n.getAttribute(e,"underline",0))).underline,bold:o.getEquivalence("bold",parseInt(n.getAttribute(e,"bold",0))).bold,italic:parseInt(n.getAttribute(e,"italic",0)),fontSize:parseInt(n.getAttribute(e,"fontsize","17")),fontFamily:o.getEquivalence("font",n.getAttribute(e,"font","17")).fontFamily,height:n.getAttribute(e,"height","35")*this.infos.vscale+2,width:n.getAttribute(e,"width","72")*this.infos.hscale,top:n.getAttribute(e,"top","16.726")+"%",left:n.getAttribute(e,"left","0")+"%",overflowY:"auto",overflowX:"hidden",position:"absolute",display:"inline-block",userSelect:"none"}},setPropsAndItemsInfos:function(t){t.forEach(function(t){2===t.length&&(this.propsInfo.push(t[0]),this.itemsInfo.push(t[1]))}.bind(this))},setItems:function(){this.items=this.itemsInfo.map(function(t,i){return e.create(i).setContent("text",t.textContent).setSize(this.designPicker.width,"auto").setTextDesign({position:"relative",color:this.designPicker.fontcolor}).setZone(i).setDragStartCbk(this.startDrag.bind(this)).setDragEndCbk(this.updateAnswer.bind(this))}.bind(this))},drawList:function(){this.list=$("<div/>").css(this.designList);var t=this.createRaw("header","header"),e=this.propsInfo.map(function(t,e){return this.createRaw(e,"props",t)}.bind(this));this.list.append(t,e),this.eldar.append(this.list)},createRaw:function(t,e,s){var r=$("<div/>").addClass("raw_"+t),n="calc(50% - ("+(Number(this.designList.hspace)+(this.designList.border?1:0))+"px))",o={backgroundColor:"header"===e?this.designList.title_bgcolor:"none",width:n,padding:"2px",color:"header"===e?this.designList.title_fontcolor:this.designList.fontcolor,fontSize:this.designList.fontSize,margin:this.designList.vspace/2+"px 0",border:1===this.designList.border?"1px solid "+this.designList.borderColor:"none",display:"inline-block"};if("header"===e){if(this.hasHeader(0)){var a=$("<div/>").css(o).css({marginRight:this.designList.hspace/2+"px",marginTop:0}).text(this.headersNode[0].textContent);r.append(a)}if(this.hasHeader(1)){var d=$("<div/>").css(o).css({marginLeft:this.designList.hspace/2+"px",marginRight:0,marginTop:0}).text(this.headersNode[1].textContent);r.append(d)}}else{var h=$("<div/>").addClass("prop_"+t).css(o).text(this.propsInfo[t].textContent),l=$("<div/>").addClass("separator_"+t).css({width:this.designList.hspace,display:"inline-block",overflow:"hidden",lineHeight:this.designList.fontSize+"px",whiteSpace:"nowrap",height:"1px",borderTop:"1px dashed",verticalAlign:"middle"}),c=new i(t,"100%","auto").setPosition(0,0).setDesign({position:"relative",width:n,display:"inline-block",padding:"2px",height:this.designList.fontSize+2,border:1===this.designList.border?"1px dashed "+this.designList.borderColor:"none"}),g=$("<div/>").addClass("bullet_"+t).css({width:"6px",height:"6px",borderRadius:"50%",position:"absolute",top:"40%",left:"-4px",background:"#000",display:"none"});this.zones.push(c),r.append(h,l,c.render()),c.div.append(g)}return r},drawPick:function(){this.eldar.css({width:"100%",height:"100%"}),this.picker=$("<div/>").css(this.designPicker),r.shuffle(this.items).forEach(function(t){this.picker.append(t.render())}.bind(this)),this.eldar.append(this.picker)},refreshItem:function(t){var e=this.answer[t.id],i=this.zones[e.target];this.isItemPlaced(t)?i.div.append(t.render()):this.picker.append(t.render())},refresh:function(){this._super(),this.refreshZones(),this.items.forEach(function(t){var e=this.answer[t.id].target,i=t.id===e,s=this.zones[e];if(i&&this.eldar._showGood&&!this.isCorrected)var r=this.designList.goodcolor;else if(i||!this.eldar._showBad||this.isCorrected){var r=this.designList.fontcolor;this.zones.forEach(function(t,i){i.id===e&&i.div.css({border:"1px dashed "+t,color:t})}.bind(this,r))}else var r=this.designList.badcolor;var n={border:"1px solid "+r,color:r};$(".prop_"+t.zone).css(n),s&&(s.div.css(n),t.div.css("color",r))}.bind(this))},adjustHeightColumn:function(){if(this.hasHeader(0)&&this.hasHeader(1)){var t=$(".raw_header").find("div"),e=0;t.each(function(t,i){var s=$(i).height();s>e&&(e=s)}.bind(this)),t.css({height:e,verticalAlign:"bottom"})}var t=$('div[class^="raw_"]').not(".raw_header");t.each(function(t,e){var i=$(e).find("div").not('div[class^="separator"]').not('div[class^="bullet"]'),s=0;i.each(function(t,e){var i=$(e).height();i>s&&(s=i)}),i.css({height:s,verticalAlign:"middle"})}.bind(this))},show:function(){this._super(),this.adjustHeightColumn()},hasHeader:function(t){return this.headersNode.length>t&&this.headersNode[t]&&this.headersNode[t].textContent},updateAnswer:function(t){this.list.css({overflowY:"auto"}),this.isItemPlaced(t)&&this.zones[this.answer[t.id].target].detachItem(t);var e=t.dropZoneHovered;if(this.answer[t.id].setTarget(-1),e.length>0){if(0===e[0].attachedItems.length){var i=e[0].id;this.answer[t.id]=s.create().setTarget(i)}}else this.answer[t.id]=s.create().setTarget(-1);this.refresh()},startDrag:function(t){this.list.css({overflowY:"none"})},refreshZones:function(){var t=[];this.answer.map(function(e,i){if(e.target!=-1){var s=this.zones[e.target],r=this.getItemById(i);if(t.push(s),s.attachItem(r),s.attachedItems.length>1){var n=s.attachedItems.shift();this.answer[n.id].setTarget(-1),this.refreshItem(n)}}}.bind(this)),this.zones.forEach(function(e){if($.inArray(e,t)!=-1)var i="solid",s="block";else var i="dashed",s="none";e.div.css({border:"1px "+i}),$(".separator_"+e.id).css({borderTop:"1px "+i}),$(".bullet_"+e.id).css({display:s})})},getLMSFormattedSource:function(t){return this.propsInfo[t].textContent},getLMSFormattedTarget:function(t){var e="";return e=t.target===-1?"no move":this.items[t.target].content},getLMSFormattedPrefix:function(t){return t+" : "}});return a});