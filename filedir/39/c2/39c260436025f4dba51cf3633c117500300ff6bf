define(["ekhil/view/AEldar","lib/Utils","lib/HTMLHelper","ekhil/model/Course","lib/TextHelper","lib/ScormHelper"],function(t,e,r,s,a,i){return t.extend({init:function(t,r,s){this._super.apply(this,arguments),this.params=this.getParamsFromXML(t),this.screenWidth=r,this.screenHeight=s,this.eldar._showGood=!1,this.eldar._showBad=!1,this.eldar._showMissed=!1,this.eldar._answer=new Array,this.eldar._up_cards=new Array,this.eldar._rows_count,this.eldar._cols_count,this._generateId(),this.eldar._cards=e.object_shuffle(this.getCards(this.params.content.couples)),this.setAnswer();var a=this.eldar._cards.length;this.eldar._couplesCount=this.eldar._cards.length/2,this.eldar._rows_count=Math.floor(Math.sqrt(a)),this.eldar._cols_count=Math.ceil(a/this.eldar._rows_count),this.eldar.card_width=(this.params.width-(this.eldar._cols_count-1)*this.params.elfe.card.h_margin)/this.eldar._cols_count,this.eldar.card_height=(this.params.height-(this.eldar._rows_count-1)*this.params.elfe.card.v_margin)/this.eldar._rows_count;for(var i=0;i<a;i++){var h=Math.floor(i/this.eldar._cols_count),d=i%this.eldar._cols_count,n=d*+this.params.elfe.card.h_margin+d*this.eldar.card_width,o=h*+this.params.elfe.card.v_margin+h*this.eldar.card_height;this._createCardRecto(this.eldar._cards[i],n,o),this._createCardVerso(this.eldar._cards[i],n,o)}$(this.eldar).data("refresh",this.refresh),this.refresh()},getParamsFromXML:function(t){for(var e=t.querySelector("content"),r=t.querySelector("design"),s=this.parseXMLAttributes(r),i=r.querySelector("text"),h=r.querySelector("card"),d=a.parseDesignNode(i),e=t.querySelector("content"),n=e.querySelector("couples"),o=e.querySelector("links"),l=n.querySelectorAll("couple"),c=l.length,u=[],p=0;p<c;p++){for(var _=[],f=l[p],g=f.querySelectorAll("item"),w=g.length,m=0;m<w;m++){var b=g[m],v=b.attributes.type.value,y="image"===v?"image":"text";if("image"===v){var x=b.attributes.src.value,C=o.querySelector('link[id="'+x+'"]');_.push({type:y,src:this.player.getMediaPath(C.attributes.value.value)})}else if("xhtml"===v){var A=document.createElement("div");A.innerHTML=b.textContent;var k=a.parseXHTMLNode(A,r,this.player.getMediaPath.bind(this.player));_.push({type:y,text:{text:k.outerHTML.toString(),backgroundColor:""}})}else{var k=$("<div/>").css(d).html(b.textContent);_.push({type:y,text:{text:k.get(0).outerHTML.toString(),backgroundColor:""}})}}u.push(_)}return{content:{show:+n.attributes.show.value,couples:u},elfe:{text:this.parseXMLAttributes(i),card:this.parseXMLAttributes(h)},width:s.width,height:s.height,freeze_time:s.freeze_time}},getAnswer:function(){for(var t="",e=this.eldar._answer.length,r=0;r<e;r++)t+=(""!=t?";":"")+this.eldar._answer[r];return t},setAnswer:function(t){switch(null!=t&&""!=t||(t="none"),t){case"correct":this.eldar._answer=new Array;for(var e=this.params.content.couples.length,r=0;r<e;r++)this.eldar._answer.push(i.getScormIdentifier(r));break;case"erase_answer":break;case"erase_bad":break;default:if("undefined"!=typeof responses&&"undefined"!=typeof responses[this.params.responseID]){this.eldar._answer=new Array;for(var s=responses[this.params.responseID],a=s.split(";"),h=a.length,r=0;r<h;r++)this._hasCard(a[r])&&this.eldar._answer.push(a[r])}}},_hasCard:function(t){for(var e=!1,r=this.eldar._cards.length,s=0;s<r;s++)if(this.eldar._cards[s].id==t)return!0;return e},tellEraseAnswer:function(){this.eldar._answer=new Array},tellEraseBadAnswer:function(){console.warn("This action is not applicable to this eldar.")},tellCorrectAnswer:function(){this._super();for(var t=this.eldar._cards.length,e=0;e<t;e++)this._isAnswered(this.eldar._cards[e].id)||this.eldar._answer.push(this.eldar._cards[e].id);this._returnCards()},tellShowMissedAnswer:function(){console.warn("This action is not applicable to this eldar.")},showContent:function(){},getScore:function(){for(var t=this.eldar._cards.length,e=0,r=0,s=0,a=0;a<t;a++)this._isAnswered(this.eldar._cards[a].id)&&r++,e++;return e>0&&(s=r/e*100),s},getInteraction:function(){return this._super()},correct_response:function(){return this.correct_response_text().substring(0,4e3)},student_response:function(){return this.student_response_text().substring(0,4e3)},refresh:function(){this.disableAction(),this._returnCards(),$(this.eldar).show()},student_response_text:function(){return""},correct_response_text:function(){return""},_setCard:function(t,r){this.showCardVerso(t,r),this.eldar._up_cards.push({id:t,sub_id:r}),2==this.eldar._up_cards.length&&(this.disableAction(),this.eldar._up_cards[0].id==t&&this.eldar._up_cards[0].sub_id!=r&&this.eldar._answer.push(t),this.eldar._up_cards=new Array,setTimeout(e.relegate(this,this._returnCards),1e3*this.params.freeze_time))},showCardVerso:function(t,e){var r,s;$(this.eldar).children().each(function(){$(this).data("recto")&&$(this).data("id")==t&&$(this).data("sub_id")==e&&(r=$(this)),$(this).data("verso")&&$(this).data("id")==t&&$(this).data("sub_id")==e&&(s=$(this))}),$(r).hide(),$(s).show(),$(s).css({cursor:"pointer"}),$(s).bind("click",function(){this._setCard(t,e)})},_returnCards:function(){var t=this;$(this.eldar).children().each(function(){var e=$(this).data("id"),r=$(this).data("sub_id");$(this).data("verso")&&(t._isAnswered(e)?($(this).css({opacity:.6}),$(this).show()):($(this).css({opacity:1}),$(this).hide())),$(this).data("recto")&&(t._isAnswered(e)?$(this).hide():($(this).bind("click",function(){t._setCard(e,r)}),$(this).css({cursor:"pointer"}),$(this).show()))})},disableAction:function(){$(this.eldar).children().each(function(){$(this).data("recto")?($(this).unbind("click"),$(this).css({cursor:"default"})):($(this).unbind("click"),$(this).css({cursor:"default"}))})},_isAnswered:function(t){for(var e=!1,r=this.eldar._answer.length,s=0;s<r;s++)this.eldar._answer[s]==t&&(e=!0);return e},touchStartEvent:function(t,e){e.preventDefault(),this.actualRollCard&&this.actualRollCard==t?(this.rollOutEvent(e),this.actualRollCard=!1):(this.rollInEvent(t,e),this.actualRollCard=t)},rollInEvent:function(t,e){e.preventDefault(),this.eldar._answer.length==this.eldar._couplesCount&&$(this.eldar).children().each(function(e,r){$(r).data("id")!=t.id?$(r).css("opacity","0.6"):$(r).css("opacity","1")}.bind(this))},rollOutEvent:function(t){t.preventDefault(),this.eldar._answer.length==this.eldar._couplesCount&&$(this.eldar).children().each(function(){$(this).css("opacity","0.6")})},_generateId:function(){for(var t=this.params.content.couples.length,e=0;e<t;e++)for(var r=0;r<2;r++)this.params.content.couples[e][r].id=i.getScormIdentifier(e),this.params.content.couples[e][r].sub_id=r},getCards:function(t){var e=new Array,r=t.length;""!=this.params.content.show&&this.params.content.show<r&&(r=this.params.content.show);for(var s=0;s<r;s++)for(var a=0;a<2;a++)e.push(t[s][a]);return e},_createCardRecto:function(t,e,s){var a=$("<div/>").css({width:this.eldar.card_width+"px",height:this.eldar.card_height+"px",top:s+"px",left:e+"px",position:"absolute"}),i=require("ekhil/EkhilPlayer").getInstance().getMediaPath(this.params.elfe.card.card_back);if(""!=i){var h=new r("image",{src:i,w:this.eldar.card_width,h:this.eldar.card_height,proportional:!1,streched:!0}).getElement();$(h).hide(),$(h).css({top:"0%",left:"0%"}),$(h).load(function(){$(this).css({width:"100%",height:"100%"}),$(h).show()}),$(a).append(h)}else{var d=$("<div/>").css({borderRadius:"5px",height:"100%",width:"100%",top:"0%",left:"0%",display:"block",position:"absolute",borderWidth:""!==i?"0px":this.params.elfe.card.bordersize,borderStyle:"solid",borderColor:this.params.elfe.card.bordercolor,backgroundColor:""!==i?"transparent":this.params.elfe.card.bgcolor,overflow:"hidden"}).html("");$(a).append(d)}$(a).data("id",t.id),$(a).data("sub_id",t.sub_id),$(a).data("recto",!0),$(this.eldar).append(a)},_createCardVerso:function(t,e,s){var a=$("<div/>").css({width:this.eldar.card_width+"px",height:this.eldar.card_height+"px",top:s+"px",left:e+"px",position:"absolute"}).on("touchstart",this.touchStartEvent.bind(this,t)).on("mouseenter",this.rollInEvent.bind(this,t)).on("mouseleave ",this.rollOutEvent.bind(this)),i=this.params.width/(this.params.width*(this.params.width/100)*(this.eldar.card_width/100)),h=this.params.height/(this.params.height*(this.params.height/100)*(this.eldar.card_height/100)),d=h*this.params.elfe.text.v_padding,n=i*this.params.elfe.text.h_padding,o="";if(""!=this.params.elfe.card.card_face&&(o=require("ekhil/EkhilPlayer").getInstance().getMediaPath(this.params.elfe.card.card_face)),void 0!=t.src&&""!=t.src&&(o=t.src),""!=o){var l=new r("image",{src:o,w:this.eldar.card_width,h:this.eldar.card_height,proportional:!1,streched:!0}).getElement();$(l).css({top:"0%",left:"0%"}),$(l).load(function(){$(this).css({width:"100%",height:"100%"})}),$(a).append(l)}if("text"==t.type){var c=2*this.params.elfe.text.h_padding,u=2*this.params.elfe.text.v_padding,p=$("<div/>").addClass("div1").css({borderRadius:"5px",height:"calc(100% - "+u+"px)",width:"calc(100% - "+c+"px)",top:"0%",left:"0%",display:"block",position:"absolute",borderWidth:""!==o?"0px":this.params.elfe.card.bordersize,borderStyle:"solid",borderColor:this.params.elfe.card.bordercolor,backgroundColor:""!==o?"transparent":this.params.elfe.card.bgcolor,overflow:"hidden",margin:this.params.elfe.card.h_margin+"px"}),_=$("<div/>").css({borderRadius:"5px",height:"100%",width:"100%",paddingTop:d+"%",paddingBottom:d+"%",display:"block",position:"absolute",wordWrap:"break-word",backgroundColor:"transparent",overflow:"hidden",whiteSpace:"pre-wrap"});$(_).html(t.text.text),$(_).find(">div>p").css({paddingLeft:n+"%",paddingRight:n+"%"}),$(p).append(_),$(a).append(p)}$(a).hide(),$(a).data("id",t.id),$(a).data("sub_id",t.sub_id),$(a).data("verso",!0),$(this.eldar).append(a)}})});