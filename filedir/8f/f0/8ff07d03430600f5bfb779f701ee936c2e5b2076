define(["ekhil/view/AEldar","lib/HTMLHelper","lib/Utils","lib/ScormHelper","lib/TextHelper","lib/DragAndDrop"],function(e,t,i,r,s){return e.extend({isShown:!1,init:function(e,t,r){this._super.apply(this,arguments),this.regStr='<a href="#"[^>]*>(.+?)</a>',this.regOnce=new RegExp(this.regStr),this.regGlobal=new RegExp(this.regStr,"g"),this.params=this.getParamsFromXML(e),this.listAllPickers=this.params.content.holes.concat(this.params.content.traps),this.pickerOrder=this.listAllPickers.map(function(e){return e.index}),this.pickerOrder=i.object_shuffle(this.pickerOrder),this.picker="",this.holesElements=[],this.answer=[],this.isShown=!1,this.width=t,this.height=r,i.removeUserSelect(this.eldar)},getParamsFromXML:function(e){for(var t,i=e.querySelector("content"),r=[],n=-1,a=i.querySelector("text").textContent;null!==(t=this.regGlobal.exec(a));)t.index===this.regGlobal.lastIndex&&this.regGlobal.lastIndex++,n++,r.push({index:n,text:t[1]});var o=i.querySelector("traps"),h=[],l={deleteprop:0,hidedouble:0};if(null!=o){l=this.parseXMLAttributes(o);for(var d=o.querySelectorAll("trap"),p=0;p<d.length;p++)n++,h.push({index:n,text:d[p].textContent})}var c=e.querySelector("design"),g=c.querySelector("picker"),u=s.parseDesignNode(g),x=g.querySelector("picker_title").textContent,f=this.parseXMLAttributes(g),m=c.querySelector("text"),v=s.parseDesignNode(m);v.goodcolor=m.attributes.goodcolor.value,v.badcolor=m.attributes.badcolor.value;var w=c.querySelector("hole"),b=s.parseDesignNode(w),k=w.querySelector("hole_text");return{content:{text:i.querySelector("text").textContent,holes:r,traps:h,deleteprop:l.deleteprop,hidedouble:l.hidedouble},design:{design:this.parseXMLAttributes(c),hole:b,text:v,hole_text:k.textContent?k.textContent:"...?...",picker:$.extend(u,{width:f.width+"%",height:f.height+"%",left:f.left+"%",top:f.top+"%",transparent:f.transparent,fontcolor:f.fontcolor,underline:"1"===f.underline,italic:"1"===f.italic,bold:"1"===f.bold,fontsize:f.fontsize,font:f.font,align:f.align}),pickerTitle:{color:f.title_fontcolor,backgroundColor:f.title_bgcolor,transparent:f.transparent,title:x}}}},show:function(){if(!this.isShown){var e=""!==this.params.design.picker.border?this.params.design.picker.border+" "+this.params.design.picker.borderColor:"none",t=$("<div/>").css($.extend(this.params.design.picker,{position:"absolute",border:e,display:"table"})).appendTo(this.eldar),r=0;if(""!==this.params.design.pickerTitle.title&&"undefined"!=this.params.design.pickerTitle.title){var s=$("<div/>").css({display:"table-row"}).appendTo(t),n=$("<div/>").css($.extend(this.params.design.pickerTitle,{background:"1"==this.params.design.pickerTitle.transparent?"none":this.params.design.pickerTitle.backgroundColor})).text(this.params.design.pickerTitle.title).appendTo(s);r=n.height(),s.css({height:r+"px"})}var a=i.removeCSSUnit(this.params.design.picker.height)/100*this.params.design.design.height-r,o=$("<div/>").css({display:"table-row",background:"1"==this.params.design.picker.transparent?"none":this.params.design.picker.backgroundColor}).appendTo(t).addClass("scrollable"),h=$("<div/>").css({height:a+"px",overflowY:"auto"}).appendTo(o),l=i.removeCSSUnit(this.params.design.picker.width)/100*this.params.design.design.width;this.picker=$("<div/>").css({top:0,left:0,width:l+"px"}).appendTo(h);var d=i.removeCSSUnit(this.params.design.text.height)/100*this.params.design.design.height,p=i.removeCSSUnit(this.params.design.text.width)/100*this.params.design.design.width,c=this.params.content.text,g=$("<div/>").css($.extend(this.params.design.text,{position:"absolute",height:d+"px",width:p+"px",left:i.removeCSSUnit(this.params.design.text.left)+"%",top:i.removeCSSUnit(this.params.design.text.top)+"%"}));c=c.replace(this.regGlobal,'<div style="display: inline" class="holeDiv"></div>'),g.append(c).css($.extend(this.params.design.text,{whiteSpace:"pre-wrap"})).appendTo(this.eldar),$(this.eldar).find(".holeDiv").each(function(e,t){$(t).data("indexHole",e),this.holesElements.push(t)}.bind(this)),this.isShown=!0}this.refresh()},deleteDroppedProposition:function(e){for(var t=e.length,i=0;i<t;)this.params.content.hidedouble&&this.getOccurenceTextInAnswer(e[i].text)==this.getOccurenceTextInPickers(e[i].text)||!this.params.content.hidedouble&&1==this.getOccurenceTextInAnswer(null,e[i].index)?(e.splice(i,1),t--):i++;return e},hideDuplicatedProposition:function(e){for(var t=e.length,i=[],r=0;r<t;)void 0==i[e[r].text]?(i[e[r].text]=!0,r++):(e.splice(r,1),t--);return e},refresh:function(){var e=$.extend(this.params.design.hole,{cursor:"Pointer",minWidth:"2px",minHeight:"2px",display:"inline-block"}),t=""!==this.params.design.picker.border?this.params.design.picker.border:"none",i={cursor:"Pointer",minWidth:"2px",border:t,minHeight:"2px",wordWrap:"break-word",paddingBottom:"10px"};try{if(this.picker)for(;this.picker.get(0).firstChild;)this.picker.get(0).removeChild(this.picker.get(0).firstChild)}catch(r){console.info(r)}var s=[],n=this.listAllPickers.concat();"1"===this.params.content.deleteprop&&(n=this.deleteDroppedProposition(n)),"1"===this.params.content.hidedouble&&(n=this.hideDuplicatedProposition(n)),this.holesElements.map(function(t){for(var i=$(t).data("indexHole");t.firstChild;)t.removeChild(t.firstChild);var r=this.answer.filter(function(e){return e.hole==i});if(0==r.length){var n=this.drawTextElement(this.params.design.hole_text,-1,i,!1,e,"holeText");!this.isCorrected&&this.eldar._showBad&&$(n).css({color:this.params.design.text.badcolor}),$(t).append(n)}else{var a=this.drawTextElement(r[0].text,r[0].prop,i,!0,e),o=this.listAllPickers[r[0].hole].text==r[0].text;!this.isCorrected&&this.eldar._showGood&&o?$(a).css({color:this.params.design.text.goodcolor}):this.isCorrected||!this.eldar._showBad||o?$(a).css({color:e.color}):$(a).css({color:this.params.design.text.badcolor}),$(t).append(a),s.push(r[0]).css}}.bind(this)),this.pickerOrder.map(function(e){n[e]&&this.drawTextElement(n[e].text,n[e].index,-1,!0,i).appendTo(this.picker)}.bind(this))},drawTextElement:function(e,t,i,r,n,a){var o=$("<div/>").css(n),h=s.calculateTextSize(e,{fontFamily:this.params.design.picker.font,fontSize:this.params.design.picker.fontsize,fontStyle:this.params.design.picker.italic?"italic":"normal",fontWeight:this.params.design.picker.bold?"bold":"normal"}),l=$("<div/>").css({display:"inline",width:h.width+"px"}).data("prop",t).data("hole",i).text(e);return l.droppable(),r&&(l.draggable(),l.on({dragstart:this.onDragStart.bind(this),dragend:this.onDragEnd.bind(this)})),l.addClass(a),o.append(l),o},onDragStart:function(e){var t=$(e.target),i={fontSize:$(t).css("fontSize"),fontFamily:$(t).css("fontFamily"),color:$(t).css("color"),width:$(t).width(),textAlign:"center",cursor:"none"};"holeDiv"==t.parent().parent().get(0).className&&($(t).data("indexHole",t.parent().parent().data("indexHole")),$(t).data("hole","1"));var r=$(t).clone();$(t).data("clone",r),$(t).parent().append(r),$(t).appendTo("#container"),$(t).css(i)},onDragEnd:function(e){var t=$(e.target),i=t.data("prop"),r=t.text();if(t.data("attached")){for(var s,n=0;n<t.data("attached").length&&(s=t.data("attached")[n],"holeDiv"!=s.parent().parent().get(0).className);n++);if("holeDiv"==s.parent().parent().get(0).className){var a=s.parent().parent().data("indexHole");isNaN(a)||(this.deleteHoleAnswer(a),"1"==t.data("hole")&&this.deleteHoleAnswer(t.data("indexHole")),this.answer.push({prop:i,hole:a,text:r}))}else this.deleteTextAnswer(r)}$(t).remove(),this.refresh()},getOccurenceTextInAnswer:function(e,t){for(var i=0,r=0;r<this.answer.length;r++)null!=t?this.answer[r].prop==t&&i++:this.answer[r].text==e&&i++;return i},getOccurenceTextInPickers:function(e){for(var t=0,i=0;i<this.listAllPickers.length;i++)this.listAllPickers[i].text==e&&t++;return t},deleteHoleAnswer:function(e){for(var t=0;t<this.answer.length;t++)if(this.answer[t].hole==e){this.answer.splice(t,1);break}},deleteTextAnswer:function(e){for(var t=0;t<this.answer.length;t++)if(this.answer[t].text==e){this.answer.splice(t,1);break}},getScore:function(){var e=0;this.answer.map(function(t){this.listAllPickers[t.hole].text==t.text&&e++}.bind(this));var t=this.params.content.holes.length;return t>0&&(e=Math.round(100*e/t)),e=Math.max(e,0),e=Math.min(e,100)},correct_response:function(){var e=this.params.content.holes.map(function(e){return"item_"+r.getScormIdentifier(e.index)+"[.]response_"+r.getScormIdentifier(e.index+1)}),t=e.join("[,]");return t},student_response:function(){var e=this.answer.map(function(e){return"item_"+r.getScormIdentifier(e.prop)+"[.]response_"+r.getScormIdentifier(e.hole+1)}),t=e.join("[,]");return t},getAnswerTexts:function(e){var t=this.params.content.holes.map(function(t){return e?e:""});return this.answer.forEach(function(e){this[e.hole]=e.text},t),t},replaceHoles:function(e,t,i){var r,s=new Array;holesValuesCount=t.length;for(var n=0;n<holesValuesCount;n++)r=t[n]?t[n]:"",s.push(r);var a=s.reduce(function(e,t){return e.replace(i,t)},e);return a},correct_response_text:function(){var e=this.params.content.holes.map(function(e){return e.text}),t=this.replaceHoles(this.params.content.text,e,this.regOnce);return t},student_response_text:function(){var e=this.getAnswerTexts(this.params.design.hole_text);return buffer=this.replaceHoles(this.params.content.text,e,this.regOnce),buffer},tellEraseBadAnswer:function(){if(this.answer)for(var e=this.answer.length,t=e-1;t>=0;t--){var i=!1;this.listAllPickers[this.answer[t].hole].text==this.answer[t].text&&(i=!0),i||this.answer.splice(t,1)}},tellCorrectAnswer:function(){this._super(),this.tellEraseAnswer();for(var e=this.params.content.holes.length,t=e-1;t>=0;t--){var i=this.params.content.holes[t];this.answer.push({prop:i.index,hole:i.index,text:i.text})}}})});