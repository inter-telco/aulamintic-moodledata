define(["ekhil/view/AEldar","lib/HTMLHelper","lib/Utils","lib/ScormHelper","lib/TextHelper","lib/PositionHelper","lib/DragAndDrop"],function(t,e,s,i,r,a){return t.extend({cellPadding:"5px",isDraggable:!1,lineIsCleanable:!0,init:function(t,e,i,r){this._super.apply(this,arguments),this.params=this.getParamsFromXML(t),this.answer=[],this.eldar._showGood=!1,this.eldar._showBad=!1,this.eldar._showMissed=!1,this.sourceBullets=[],this.targetBullets=[],this.bullets=[],this.lineList=[],this.currentDraggedBullet=null,this.zoom=this.player.container.getScale(),this.screenWidth=e,this.screenHeight=i,this.width=this.params.design.design.width,this.height=this.params.design.design.height,this.file_matchedroll=this.params.design.bullet.file_matchedroll?this.params.design.bullet.file_matchedroll:"../_shared/medias/default_bullet.png",this.file_matched=this.params.design.bullet.file_matched?this.params.design.bullet.file_matched:"../_shared/medias/default_bullet.png",this.file_init=this.params.design.bullet.file_init?this.params.design.bullet.file_init:"../_shared/medias/default_bullet.png",this.file_initroll=this.params.design.bullet.file_initroll?this.params.design.bullet.file_initroll:"../_shared/medias/default_bullet.png",this.file_drag=this.params.design.bullet.file_drag?this.params.design.bullet.file_drag:"../_shared/medias/default_bullet.png",s.removeUserSelect(this.eldar),this.load()},getParamsFromXML:function(t){var e=t.querySelector("design"),s=this.parseXMLAttributes(e);this.isDraggable=1==s.drag;var i=e.querySelector("text"),r=this.parseXMLAttributes(i),a=e.querySelector("picture"),n=this.parseXMLAttributes(a),l=e.querySelector("bullet"),h=this.parseXMLAttributes(l),o={};for(var d in h){var c=this.player.getMediaPath(h[d]);o[d]=/^file/.test(d)?c:h[d]}for(var u=e.querySelector("line_match"),g=this.parseXMLAttributes(u),p=t.querySelector("content"),f=p.querySelector("links"),m=p.querySelectorAll("sources>item"),v=[],b=0;b<m.length;b++){var w=m[b];v.push(this.parseNodeItem(w,f,i))}for(var _=p.querySelectorAll("targets>item"),$=[],b=0;b<_.length;b++){var B=_[b];$.push(this.parseNodeItem(B,f,i))}for(var D=p.querySelector("responses"),x=D.getAttribute("max_responses"),A=D.querySelectorAll("response"),L=[],b=0;b<A.length;b++)L.push({source:A[b].getAttribute("source"),target:A[b].getAttribute("target")});return{content:{sources:v,targets:$,responses:L,max_responses:x},design:{design:s,text:r,picture:n,bullet:o,line:g}}},parseNodeItem:function(t,e,s){var i={},r=t.getAttribute("id");if("text"===t.getAttribute("type"))i={id:r,content:{text:t.textContent,backgroundColor:""}};else{var a=t.getAttribute("src"),n=e.querySelector('link[id="'+a+'"]');try{var l=this.player.getMediaPath(n.getAttribute("value"))}catch(h){console.log(h.message)}i={id:r,content:{src:l}}}return i},load:function(){this.eldar.css({width:this.width+"px",height:this.height+"px"});var t=+this.params.design.design.coef_left+ +this.params.design.design.coef_right+ +this.params.design.design.coef_center,e=this.width*(this.params.design.design.coef_left/t),s=this.width*(this.params.design.design.coef_right/t),i=this.width*(this.params.design.design.coef_center/t),r=this.createListItems(this.params.content.sources,"left",0,e+i/2,e,i/2),a=this.createListItems(this.params.content.targets,"right",e+i/2,s+i/2,s,i/2);this.eldar.append(r),this.eldar.append(a)},show:function(){this._super(),this.refresh()},createListItems:function(t,i,a,n,l,h){for(var o=$("<div/>").css({position:"absolute",textAlign:"left",height:"100%",display:"table",left:a+"px",width:n+"px",verticalAlign:"top",borderSpacing:this.cellPadding,borderCollapse:"collapse"}),d=t.length,c=this.params.design.design.height,u=d>0?c/d:c,g=0;g<d;g++){var p=$("<div/>").css({width:"100%",display:"table-row"}).appendTo(o).addClass(i+"_Item_"+g),f=$("<div/>").css({width:l+"px",display:"table-cell",verticalAlign:"middle"}),m=$("<div/>").css({width:h-Number(this.params.design.bullet.hspace)+"px",display:"table-cell","vertical-align":"middle"}),v=t[g];if(v){if(v.content.src){var b=new e("image",{src:v.content.src,proportional:!!+this.params.design.picture.proportional,streched:!!+this.params.design.picture.streched,w:l,h:u,align:"left"===i?"right":"left"}).getElement();$("<div/>").css({textAlign:"left"===i?"right":"left"}).append(b).appendTo(f).addClass("itemPicture")}else{var w=r.parseDesignNode(this.params.design.text);$("<div/>").css($.extend(w,{top:0,left:0,textAlign:"left"===i?"right":"left"})).append(v.content.text).appendTo(f)}m.append(this.getBulletElement(i,v.id)).addClass("bulletItem"),"left"==i?(f.appendTo(p),m.appendTo(p)):(m.appendTo(p),f.appendTo(p))}}if("left"==i)o.find(".bulletItem").css({textAlign:"left",paddingLeft:this.params.design.bullet.space+"px"});else{var _=this.params;o.find(".bulletItem").each(function(){$(this).css({textAlign:"right",paddingRight:_.design.bullet.space+"px"}),$(this).find("div").css({"float":"right"})})}return $(o).find(".itemPicture").each(function(){$(this).bind("onLoadInit",function(){$(this).find("img").each(function(){+s.removeCSSUnit($(this).css("height"))>=u&&$(this).parent().css({height:+s.removeCSSUnit($(this).css("height"))+this.cellPadding})})})}),o},getBulletElement:function(t,i){var r=new e("image",{src:this.file_init,w:this.params.design.bullet.width,h:this.params.design.bullet.height,streched:!0,proportional:!1}).getElement();s.removeUserSelect($(r));var a=this;return r.bind({mouseover:function(){$(this).css({cursor:"pointer"}),$(this).data("matched")?$(this).get(0).firstChild.src=a.file_matchedroll:$(this).get(0).firstChild.src=a.file_initroll},mouseout:function(){$(this).data("matched")?$(this).get(0).firstChild.src=a.file_matched:$(this).get(0).firstChild.src=a.file_init}}),r.data("list",t),r.data("id",i),r.data("matched",null),"left"==t?this.sourceBullets.push(r):this.targetBullets.push(r),this.bullets.push(r),this.isDraggable?r.on("touchstart mousedown",this.onDragStartEvent.bind(this,r)):r.on("click",this.onDragStartEvent.bind(this,r)),r},canAddResponse:function(t,e){var s=!1;return e&&0!=e?t<e&&(s=!0):s=!0,s},onDragStartEvent:function(t,e){e.preventDefault(),e.stopPropagation(),this.isDraggable?(this.eldar.off(),this.eldar.on("touchmove mousemove",this.onDragEvent.bind(this)),this.eldar.on("touchend mouseup",this.onDragStopEvent.bind(this))):($(".bulletItem").find("div").off(),this.lineIsCleanable=!1,this.eldar.off(),this.eldar.on("touchmove mousemove",this.onDragEvent.bind(this)),this.eldar.on("click",this.onDragStopEvent.bind(this))),this.canAddResponse(this.lineList.length,+this.params.content.max_responses)&&(e=e.originalEvent,e.preventDefault(),e=e.touches?e.touches.item(0):e,this.currentDraggedBullet=t)},onDragEvent:function(t){if(t.preventDefault(),t.stopPropagation(),this.currentDragLine&&(this.currentDragLine.remove(),delete this.currentDragLine),this.currentDraggedBullet){this.zoom=this.player.container.getScale();var t=t.originalEvent;t=s.hasTouchEvent?t.changedTouches?t.changedTouches.item(0):t:t.touches?t.touches.item(0):t;for(var e,i=t.pageX/this.zoom,r=t.pageY/this.zoom,n=0;n<this.bullets.length;n++){var l=$(this.bullets[n]),h=a.offset(l);i>h.left&&i<h.left+l.width()&&r>h.top&&r<h.top+l.height()&&(e=this.bullets[n])}var o=a.offset(this.currentDraggedBullet),d=a.offset(this.eldar),c=t.pageX/this.zoom-(o.left+this.currentDraggedBullet.width()/2),u=t.pageY/this.zoom-(o.top+this.currentDraggedBullet.height()/2),g=Math.sqrt(c*c+u*u),p=180*Math.atan(u/c)/Math.PI,f=o.left-d.left+this.currentDraggedBullet.width()/2,m=o.top-d.top+this.currentDraggedBullet.width()/2;t.pageX/this.zoom<o.left+this.currentDraggedBullet.width()/2&&(f=t.pageX/this.zoom-d.left,m=t.pageY/this.zoom-d.top),this.currentDragLine=this.setlineAnswer(f,m,g,p)}},onDragStopEvent:function(t){if(t.preventDefault(),t.stopPropagation(),this.lineIsCleanable=!0,this.currentDragLine&&(this.currentDragLine.remove(),delete this.currentDragLine),!this.isDraggable){var e=this;$(".bulletItem").find("div").each(function(){$(this).on("click",e.onDragStartEvent.bind(e,$(this)))})}if(void 0!==this.currentDraggedBullet&&null!==this.currentDraggedBullet){t=t.originalEvent,t=s.hasTouchEvent?t.changedTouches?t.changedTouches.item(0):t:t.touches?t.touches.item(0):t;for(var i,r=t.pageX/this.zoom,n=t.pageY/this.zoom,l=0;l<this.bullets.length;l++){var h=$(this.bullets[l]),o=a.offset(h);r>o.left&&r<o.left+h.width()&&n>o.top&&n<o.top+h.height()&&(i=this.bullets[l])}if(void 0!==i&&$(this.currentDraggedBullet).data("list")!=$(i).data("list")){var d=[];d="left"==$(this.currentDraggedBullet).data("list")?{source:$(this.currentDraggedBullet).data("id"),target:$(i).data("id")}:{source:$(i).data("id"),target:$(this.currentDraggedBullet).data("id")};var c=this.answer.filter(function(t){return t.source==d.source&&t.target==d.target}).length>0;c||this.answer.push(d)}this.currentDraggedBullet=null,this.refresh()}},onRemoveLineEvent:function(t){this.lineIsCleanable&&(delete this.lineList[t.data("lineIndex")],this.answer.splice(this.answer.indexOf(t.data("lineIndex")),1),t.remove(),this.refresh())},getLineProperties:function(t,e){var s=a.offset(t),i=a.offset(e),r=a.offset(this.eldar),n=s.left+$(t).width()/2-(i.left+$(e).width()/2),l=s.top+$(t).height()/2-(i.top+$(e).height()/2),h=Math.sqrt(n*n+l*l),o=180*Math.atan(l/n)/Math.PI,d=i.left-r.left+$(e).width()/2,c=i.top-r.top+$(e).width()/2;return i.left>s.left&&(d=s.left-r.left+$(t).width()/2,c=s.top-r.top+$(t).height()/2),{AC:h,angle:o,left:d,top:c}},setlineAnswer:function(t,e,s,i){for(var r=$("<div/>").css({position:"absolute",left:t,height:Math.max(this.params.design.line.sizefinal,2)+"px",top:e+"px",width:s+"px",backgroundColor:this.params.design.line.colormove,cursor:"pointer"}),a=["-moz-","-o-","-webkit-","-ms-"],n=0;n<a.length;n++)r.css(a[n]+"transform","rotate("+i+"deg)"),r.css(a[n]+"transform-origin","0 50%");return this.eldar.append(r),r.on("click",this.onRemoveLineEvent.bind(this,r)),r},getBulletById:function(t,e){for(var s=0,i=t.length;s<i;s++){var r=$(t[s]).data("id");if(r===e)return t[s]}},initializeBullets:function(){var t;t=this.sourceBullets.length>0?this.sourceBullets.concat(this.targetBullets):this.sourceBullets.concat(this.targetBullets);for(var e=0;e<t.length;e++)$(t[e]).data("matched",null),$(t[e]).get(0).firstChild&&($(t[e]).get(0).firstChild.src=this.file_init)},refresh:function(){for(var t in this.lineList)$(this.lineList[t]).remove();this.lineList=[],this.initializeBullets();var e;if(""!=this.answer&&void 0!==this.answer&&this.answer.map(function(t){var s=this.getBulletById(this.sourceBullets,t.source),i=this.getBulletById(this.targetBullets,t.target);if(void 0!==s&&void 0!==i){e=this.eldar._showMissed?this.params.design.line.missedcolor:!this.isMatchGood(t)&&this.eldar._showBad?this.params.design.line.badcolor:this.isMatchGood(t)&&this.eldar._showGood?this.params.design.line.goodcolor:this.params.design.line.colorfinal;var r=this.getLineProperties(s,i),a=this.setlineAnswer(r.left,r.top,r.AC,r.angle);$(a).css({backgroundColor:e}),this.lineList.push(a),a.data("lineIndex",t),$(s).data("matched",!0),$(i).data("matched",!0),$(s).get(0).firstChild.src=this.file_matched,$(i).get(0).firstChild.src=this.file_matched}}.bind(this)),this.eldar._showMissed){var s=this.params.content.responses;s.map(function(t){var e=this.getBulletById(this.sourceBullets,t.source),s=this.getBulletById(this.targetBullets,t.target),i=this.getLineProperties(e,s),r=this.setlineAnswer(i.left,i.top,i.AC,i.angle);$(r).css({backgroundColor:this.params.design.line.missedcolor})}.bind(this))}},setAnswer:function(t){if(this.answer=[],t)try{var e=s.parseJson(t);e&&(this.answer=e[this.type]||e[this.type.toLowerCase()])}catch(i){console.warn("DragAndMatch.setAnswer - error : ",i)}},getScore:function(){var t=0,e=this.params.content.responses.length;if(e>0){var s=0;this.answer.map(function(t){this.isMatchGood(t)?s++:0==this.params.content.max_responses&&s--}.bind(this)),t=Math.round(s/e*100),t=Math.max(t,0),t=Math.min(t,100)}return t},student_response:function(){var t=[];return this.answer.map(function(e){t.push("item_"+i.getScormIdentifier(parseInt(e.source)-1)+"[.]response_"+ +e.target)}.bind(this)),t.join("[,]")},student_response_text:function(){var t=[],e=0;return this.answer.map(function(s){t.push(e+" : "+s.source+" --> "+s.target),e++}.bind(this)),t.join("\n")},correct_response:function(){var t=[],e=0;return this.params.content.responses.map(function(s){s.source&&(t.push("item_"+i.getScormIdentifier(parseInt(s.source)-1)+"[.]response_"+s.target),e++)}.bind(this)),t.join("[,]")},correct_response_text:function(){var t=[],e=0;return this.params.content.responses.map(function(s){s.source&&(t.push(e+" : "+s.source+" --> "+s.target),e++)}.bind(this)),t.join("\n")},tellEraseBadAnswer:function(){for(var t=[],e=this.answer.length,s=e-1;s>=0;s--)this.isMatchGood(this.answer[s])&&t.push(this.answer[s]);this.answer=t},tellCorrectAnswer:function(){this._super(),this.tellEraseAnswer();var t=[];this.params.content.responses.map(function(e){t.push({source:e.source,target:e.target})}.bind(this)),this.answer=t},isMatchGood:function(t){var e=!1;return this.params.content.responses.map(function(s){t.source==s.source&&t.target==s.target&&(e=!0)}),e}})});