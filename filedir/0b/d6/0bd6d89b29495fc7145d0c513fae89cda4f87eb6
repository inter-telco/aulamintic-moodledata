define(["ekhil/view/AEldar","lib/HTMLHelper","lib/Utils","lib/TextHelper"],function(e,t,n,s){return e.extend({isShown:!1,init:function(e,t,s){this._super.apply(this,arguments),this.regStr='<a href="1"[^>]*>([^>]*)*</a>',this.regGlobal=new RegExp(this.regStr,"g"),this.eldar._showGood=!1,this.eldar._showBad=!1,this.params=this.getParamsFromXML(e),this.answer=[],n.removeUserSelect($("body")),this.eldar.css($.extend(this.params.design.text,{display:"inline",whiteSpace:"pre-wrap"}))},getParamsFromXML:function(e){return{content:this.getParamsContentFromXML(e),design:this.getParamsDesignFromXML(e)}},getParamsContentFromXML:function(e){var t=e.querySelector("content"),n=0;t.querySelector("tolerance")&&(n=t.querySelector("tolerance").getAttribute("id"));for(var s,i=t.querySelector("text").textContent,r=t.querySelector("text").textContent.replace(/<a\b[^>]*>/gi,"").replace(/<\/a>/gi,""),o=[],a=i.replace(/<\/a>/gi,""),l=this.getBeginPositionHoles(a,'<a href="1">'),h=-1;null!==(s=this.regGlobal.exec(i));)s.index===this.regGlobal.lastIndex&&this.regGlobal.lastIndex++,h++,o.push({begin:l[h],end:l[h]+s[1].length,text:s[1]});return{text:t.querySelector("text").textContent,cleanedText:r,holes:o,tolerance:Number(n)}},getParamsDesignFromXML:function(e){var t=e.querySelector("design"),n=t.querySelector("text"),i=s.parseDesignNode(n);return i.goodcolor=n.attributes.goodcolor.value,i.badcolor=n.attributes.badcolor.value,i.highlightcolor=n.attributes.highlightcolor.value,i.hascustomcursor=n.attributes.hascustomcursor.value,i.customcursor=n.attributes.customcursor.value,i.scrollbar=n.attributes.scrollbar.value,{eldar:this.parseXMLAttributes(t),text:i}},getBeginPositionHoles:function(e,t){var n=new RegExp(t.toLowerCase(),"g"),s=[];e=e.toLowerCase();for(var i=0;null!=(match=n.exec(e));)s.push(match.index-i*t.length),i++;return s},show:function(){if(this.eldar.css({position:"absolute",left:n.removeCSSUnit(this.params.design.text.left)+"%",top:n.removeCSSUnit(this.params.design.text.top)+"%"}),!this.isShown){var e=n.removeCSSUnit(this.params.design.text.width)/100*this.params.design.eldar.width,t=n.removeCSSUnit(this.params.design.text.height)/100*this.params.design.eldar.height,s=$("<div/>").css({width:e+"px",height:t+"px"}).addClass("containerTextDiv").appendTo(this.eldar);"1"==this.params.design.text.scrollbar&&s.addClass("scrollable"),n.EnableUserSelectText(s),s.on("touchend mouseup",this.onMouseUpEvent.bind(this,s)),this.isShown=!0}this.refresh()},refresh:function(){var e=this.params.content.cleanedText,t=$(".containerTextDiv");if(this.answer&&this.answer.length>0){$(t).empty();var n=0,s=0,i="",r=e.substring(0,this.answer[0].begin);t.append(this.insertTextElement(r,!1));for(var o=0;o<this.answer.length;o++){var a=this.answer[o];if(0!=o){var l=this.answer[o-1];n=l.end,s=a.begin;var h=e.substring(n,s);t.append(this.insertTextElement(h,!1))}this.isCorrected||!this.eldar._showBad&&!this.eldar._showBad?(i=e.substring(a.begin,a.end),t.append(this.insertTextElement(i,!0,this.params.design.text.highlightcolor,a.begin,a.end))):this.insertBadAndGoodTextElement(a,t)}var d=e.substring(this.answer[o-1].end,e.length);t.append(this.insertTextElement(d,!1))}else $(t).html(e)},insertBadAndGoodTextElement:function(e,t){var n=this.params.content.cleanedText,s=this.getGoodAnswerPosition(e),i=0!=s.length?s[0].begin:e.end,r=n.substring(e.begin,i);if(t.append(this.insertTextElement(r,!1,this.params.design.text.badcolor)),s.length>0){for(var o=0;o<s.length;o++){if(0!=o){var a=s[o-1];beginPos=a.end,endPos=s[o].begin;var l=n.substring(beginPos,endPos);t.append(this.insertTextElement(l,!1,this.params.design.text.badcolor))}var h=n.substring(s[o].begin,s[o].end);t.append(this.insertTextElement(h,!1,this.params.design.text.goodcolor))}r=n.substring(s[o-1].end,e.end),t.append(this.insertTextElement(r,!1,this.params.design.text.badcolor))}},insertTextElement:function(e,t,n,s,i){var r=document.createElement("div");return $(r).html(e),$(r).css({display:"inline",whiteSpace:"pre-wrap",color:n}),t&&($(r).css({color:this.params.design.text.highlightcolor}),$(r).addClass("selectedText"),$(r).data("begin",s),$(r).data("end",i)),r},getPropertyOfTextSelection:function(e){var t,n,s,i={};if("undefined"!=typeof window.getSelection)return t=window.getSelection(),n=t.getRangeAt(0),s=n.cloneRange(),s.selectNodeContents(e[0]),s.setEnd(n.startContainer,n.startOffset),i.beginPos=s.toString().length,i.endPos=i.beginPos+n.toString().length,i.selectedText=t.toString(),i},onMouseUpEvent:function(e){if("undefined"!=typeof window.getSelection&&!window.getSelection().isCollapsed){var t=this.getPropertyOfTextSelection(e),n=this.getSelectedNodeList();this.oldSelectedNodes=[];for(var s=0;s<n.length;s++)n[s]&&n[s].parentNode&&"selectedText"==n[s].parentNode.className&&this.oldSelectedNodes.push(n[s].parentNode);var i=this.oldSelectedNodes.length;if(1==i)var r=this.oldSelectedNodes[0],o=this.oldSelectedNodes[0].textContent,a=$(r).data("begin"),l=$(r).data("end");if(1==i&&t.beginPos>=a&&t.endPos<=l){var h=this.params.content.cleanedText,d=o.substr(0,t.beginPos-a),c=o.substr(t.endPos-a,l-t.endPos);0==t.beginPos&&t.endPos==h.length&&this.answer.splice(0,1),this.removeOldAnswerOfSelection(a,l),""!=c&&this.answer.push({begin:t.beginPos+t.selectedText.length,end:l}),""!=d&&this.answer.push({begin:a,end:t.beginPos})}else i>0&&(t.beginPos=Math.min(t.beginPos,$(this.oldSelectedNodes[0]).data("begin")),t.endPos=Math.max(t.endPos,$(this.oldSelectedNodes[this.oldSelectedNodes.length-1]).data("end"))),this.removeIncludedAnswerInSelection(t),this.answer.push({begin:t.beginPos,end:t.endPos})}this.answer.sort(function(e,t){return+e.begin<+t.begin?-1:+e.begin>+t.begin?1:0}),this.refresh()},removeIncludedAnswerInSelection:function(e){this.answer=this.answer.filter(function(t){return t.begin<e.beginPos||t.end>e.endPos})},removeOldAnswerOfSelection:function(e,t){this.answer=this.answer.filter(function(n){return n.begin!=e||n.end!=t})},getNextNode:function(e){var t=null;if(e.hasChildNodes())t=e.firstChild;else{for(;e&&!e.nextSibling;)e=e.parentNode;e||(t=null),t=e.nextSibling}return t},getRangeSelectedNodes:function(e){var t=[],n=e.startContainer,s=e.endContainer;if(n==s)t=[n];else{for(;n&&n!=s;)t.push(n=this.getNextNode(n));for(n=e.startContainer;n&&n!=e.commonAncestorContainer;)t.unshift(n),n=n.parentNode}return t},getSelectedNodeList:function(){var e=[];if(window.getSelection){var t=window.getSelection();t.isCollapsed||(e=this.getRangeSelectedNodes(t.getRangeAt(0)))}return e},getScore:function(){var e=0,t=0,n=0,s=this.params.content.holes.length;void 0!=this.params.content.tolerance&&(n=this.params.content.tolerance);for(var i=[],r=[],o=0;o<s;o++)r.push(0);var a=this.params.content.cleanedText;this.answer.map(function(e){for(var o=a.substring(e.begin,e.end),l=!1,h=0;h<o.length;h++){for(var d=h+e.begin,c=0;c<s;c++)if(l=d>=this.params.content.holes[c].begin,l=l&&d<this.params.content.holes[c].end){r[c]++;break}if(l)t++;else{var g=32==a.charCodeAt(d);g=g||160==a.charCodeAt(d);for(var c=0;c<s;c++)g=d>=this.params.content.holes[c].begin-n,g=g||d<this.params.content.holes[c].end+n;g?i.push(d):t--}}}.bind(this));for(var l=i.length,h=n,o=0;o<l;o++){var d=!1;if(h>0){for(var c=0;c<s;c++)if(d=i[o]>=this.params.content.holes[c].begin-n,d=d&&i[o]<this.params.content.holes[c].end+n,d=d&&r[c]>0){h--;break}}else d=32==a.charCodeAt(i[o]),d=d||160==a.charCodeAt(i[o]);d||t--}if(h>0)for(var o=0;o<s;o++){var g=this.params.content.holes[o].end-this.params.content.holes[o].begin;if(r[o]<=g&&r[o]>0){var u=Math.min(g-r[o],n);if(t+=u,h-=u,0==h)break}}t<0&&(t=0);var p=this.getLengthTextHolesSelection();return 0==p||isNaN(p)||(e=Math.round(100*t/p)),e=Math.max(e,0),e=Math.min(e,100)},getLengthTextHolesSelection:function(){for(var e=0,t=this.params.content.holes,n=0;n<t.length;n++){var s=t[n].end-t[n].begin;e+=s}return e},correct_response:function(){return this.correct_response_text()},correct_response_text:function(){var e=this.params.content.holes.map(function(e){return e.text}.bind(this));return e.join(" - ")},student_response:function(){return this.student_response_text()},student_response_text:function(){var e=this.params.content.cleanedText,t=this.answer.map(function(t){return e.substring(t.begin,t.end)}.bind(this));return t.join(" - ")},getGoodAnswerPosition:function(e){var t=[];if(e){var n=this.params.content.cleanedText,s=n.substring(e.begin,e.end);return this.params.content.holes.map(function(n){for(var i=!1,r=-1,o=-1,a=0;a<s.length;a++){var l=a+e.begin;if(i=l>=n.begin&&l<n.end)r==-1&&(r=l);else if(r!=-1&&o==-1){o=l,t.push({begin:r,end:o}),r=-1;break}}r!=-1&&(o=o==-1?e.end:o,t.push({begin:r,end:o}))}.bind(this)),t}},tellEraseBadAnswer:function(){var e=[];this.answer&&this.answer.map(function(t){var n=this.getGoodAnswerPosition(t);n.map(function(t){e.push({begin:t.begin,end:t.end})}.bind(this))}.bind(this)),this.answer=e},tellCorrectAnswer:function(){var e=[];this._super(),this.tellEraseAnswer(),e=this.params.content.holes.map(function(e){return{begin:e.begin,end:e.end}}.bind(this)),this.answer=e},tellEraseAnswer:function(){this.answer=[]},tellShowBadAnswer:function(){this._super()},tellShowGoodAnswer:function(){this._super()},getListeBeginHoles:function(e,t){var n=[],s=new RegExp(t.toLowerCase(),"g");e=e.toLowerCase();for(var i=0;null!=(t=s.exec(e));)n.push(t.index-i*t.length),i++;return n}})});