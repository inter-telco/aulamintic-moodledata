var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};define(["ekhil/view/AEldar","lib/HTMLHelper","lib/Utils"],function(e,t,s){return e.extend({init:function(e,t,s){this._super.apply(this,arguments),this.params=this.getParamsFromXML(e),this.eldar._showGood=!1,this.eldar._showBad=!1,this.eldar._showMissed=!1,this.eldar._answer=[],this._generateId();for(var r=0,n=this.params.content.zones.length,o=0;o<n;o++){var a=this.params.content.zones[o],i={x:0,y:r,width:100,height:100};void 0!=a.left&&(i.x=a.left),void 0!=a.top&&(i.y=a.top),void 0!=a.width&&(i.width=a.width),void 0!=a.height&&(i.height=a.height),this.eldar.append(this._create_field(a.id,i)),void 0!=a.top&&void 0!=a.height||(r+=i.height)}this._getAnswer(),this.eldar.data("refresh",this.refresh)},getParamsFromXML:function(e){for(var t=e.querySelector("content"),s=t.querySelector("zones"),r=s.querySelectorAll("zone"),n=r.length,o=[],a=void 0!==s.attributes.cursor&&!!+s.attributes.cursor.value,i=void 0!==s.attributes.enterkey&&!!+s.attributes.enterkey.value,h=void 0!==s.attributes.case_sensible&&!!+s.attributes.case_sensible.value,l=0;l<n;l++){for(var d=r[l],c=[],f=d.querySelectorAll("keyword"),p=f.length,u=0;u<p;u++){var m=f[u];c.push({score:m.attributes.score.value,text:m.textContent.replace("&#93;","]")})}o.push($.extend(this.parseXMLAttributes(d),{keywords:c}))}var w=e.querySelector("design"),g=this.parseXMLAttributes(w);return{content:{cursor:a,enterkey:i,case_sensible:h,zones:o},elfe:g,left:+g.left,top:+g.top,width:+g.width,height:+g.height}},showContent:function(){this._refreshAnswer(),this.eldar.find("input").css({color:this.params.elfe.fontcolor});for(var e=this.params.content.zones.length,t=0;t<e;t++){for(var s=this.params.content.zones[t].id,r=0,n=this.params.content.zones[t].keywords,o=this.params.content.zones[t].keywords.length,a=0;a<o;a++)this.isCorrectAnswer(this.eldar._answer[s],n[a].text)&&(r=Math.max(r,n[a].score));if(this.eldar._showBad&&r<100&&!this.isCorrected){this.eldar.find("input").eq(t);this.eldar.find("input").eq(t).css({color:this.params.elfe.badcolor})}if(this.eldar._showGood&&100==r){this.eldar.find("input").eq(t);this.eldar.find("input").eq(t).css({color:this.params.elfe.goodcolor})}}},getAnswer:function(){for(var e={},t=this.params.content.zones.length,s=0;s<t;s++){var r=this.params.content.zones[s].id;e[r]=this.eldar._answer[r]}return JSON.stringify(e)},setAnswer:function(e){this.tellEraseAnswer();try{for(var e=JSON.parse(e),t=this.params.content.zones.length,s=0;s<t;s++){var r=this.params.content.zones[s].id;this.setField(r,e[r])}}catch(n){}},isCaseSensitive:function(){var e="";return this.params.content.case_sensible||(e="i"),e},isCorrectAnswer:function(e,t){var r=!1;if("undefined"!=typeof e){t=s.convertFlashToRegexPattern(t);try{e.match(new RegExp(t,this.isCaseSensitive()))&&(r=!0)}catch(n){console.warn("DragAndMatch.setAnswer - error : ",n),this.tracesLog.saveHtmlGrekhilLogs("","GetText",this.tracesLog.ELDAR_LOG,"GetText.isCorrectAnswer - error : "+n,this.tracesLog.STYLE_ERROR_LOGS)}}return r},getScore:function(){for(var e=0,t=0,s=this.params.content.zones.length,r=0;r<s;r++){for(var n=this.params.content.zones[r].id,o=0,a=this.params.content.zones[r].keywords,i=this.params.content.zones[r].keywords.length,h=0;h<i;h++)this.isCorrectAnswer(this.eldar._answer[n],a[h].text)&&(o=Math.max(o,a[h].score));e+=o}return 0!=s&&(t=Math.round(e/s)),t>100&&(t=100),t},correct_response:function(){var e=this.correct_response_text();return e.substring(0,4e3)},student_response:function(){var e=this.student_response_text();return e.substring(0,4e3)},student_response_text:function(){for(var e=new Array,t=this.eldar._answer.length,s=0;s<t;s++)""!=this.eldar._answer[s]&&e.push(this.eldar._answer[s]);return e.join(String.fromCharCode(13))},correct_response_text:function(){for(var e=new Array,t=this.params.content.zones.length,s=0;s<t;s++){for(var r=(this.params.content.zones[s].id,this.params.content.zones[s].keywords),n=this.params.content.zones[s].keywords.length,o=-1,a="",i=0;i<n;i++)o<r[i].score&&(a=r[i].text,o=r[i].score);e.push(a)}return e.join(String.fromCharCode(13))},_create_field:function(e,t){var s=$("<input>").css({position:"absolute",top:t.y+"%",left:t.x+"%",width:t.width+"%",height:t.height+"%",borderWidth:+this.params.elfe.border?"1px":"0px",borderStyle:"solid",borderColor:this.params.elfe.bordercolor,fontFamily:this.params.elfe.font,color:this.params.elfe.fontcolor,fontStyle:+this.params.elfe.italic?"italic":"normal",fontSize:this.params.elfe.fontsize+"px",fontWeight:+this.params.elfe.bold?"bold":"normal",textDecoration:+this.params.elfe.underline?"underline":"none",textAlign:this.params.elfe.align,backgroundColor:+this.params.elfe.transparent?"transparent":this.params.elfe.bgcolor});if(+this.params.elfe.autosize){var r=t.height/100*this.params.height;s.css("fontSize",r-10+"px")}var n=this;return $(s).data("id",e),$(s).bind("keyup change",function(){n.setField($(this).data("id"),$(this).val())}),this.player.container.addInputListeners(s),s.on("keypress",function(e){13!=e.keyCode&&$(s).css({color:this.params.elfe.fontcolor})}.bind(this)),this.params.content.enterkey&&$(s).keydown(function(e){13===e.keyCode&&this.player.runCommand("Execute","validatepage")}.bind(this)),s},setField:function(e,t){this.eldar._answer[e]=t;for(var s=this.eldar.find("input"),r=s.length,n=!1,o=0;o<r&&!n;)n=$(s[o]).data("id")==e,n&&$(s[o]).val(t),o++},_getAnswer:function(){for(var e=this.eldar.find("input"),t=e.length,s=0;s<t;s++)this.eldar._answer[$(e[s]).data("id")]=$(e[s]).val()},_onChange:function(){this._getAnswer()},refresh:function(){this.eldar.show(),this.showContent(),this.setFocus()},setFocus:function(){this.params.content.cursor&&this.eldar.find("input:first").focus()},_refreshAnswer:function(){for(var e=this.eldar.find("input"),t=e.length,s=0;s<t;s++){var r=$(e[s]).data("id");void 0!=_typeof(this.eldar._answer[r])&&this.setField(r,this.eldar._answer[r])}},_generateId:function(){for(var e=this.params.content.zones.length,t=0;t<e;t++){var s=this.params.content.zones[t].length;this.params.content.zones[t].id=t;for(var r=0;r<s;r++)this.params.content.zones[t][r].id=r}},tellCorrectAnswer:function(){this._super();for(var e=this.params.content.zones.length,t=0;t<e;t++){for(var s=this.params.content.zones[t].id,r=0,n=-1,o="",a=this.params.content.zones[t].keywords,i=this.params.content.zones[t].keywords.length,h=0;h<i;h++)n<parseInt(a[h].score)&&(o=a[h].text,n=parseInt(a[h].score)),this.isCorrectAnswer(this.eldar._answer[s],a[h].text)&&(r=Math.max(r,a[h].score));r<100?this.eldar._answer[s]=o:this.eldar._answer[s]=this.eldar._answer[s]}},tellEraseAnswer:function(){this.eldar._answer=[];for(var e=this.params.content.zones.length,t=0;t<e;t++){var s=this.params.content.zones[t].id;this.eldar._answer[s]=""}},tellEraseBadAnswer:function(){for(var e=this.params.content.zones.length,t=0;t<e;t++){for(var s=this.params.content.zones[t].id,r=0,n=this.params.content.zones[t].keywords,o=this.params.content.zones[t].keywords.length,a=0;a<o;a++)this.isCorrectAnswer(this.eldar._answer[s],n[a].text)&&(r=Math.max(r,n[a].score));r<100&&(this.eldar._answer[s]="")}}})});