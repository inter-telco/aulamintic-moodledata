define(["ekhil/view/AEldar","lib/Utils","lib/HTMLHelper"],function(e,t,r){return e.extend({params:{},getParamsFromXML:function(e){var t={content:{zones:[]},elfe:{true_image:{},false_image:{},true_text:{},false_text:{}}},r=e.querySelector("content>zones");if(r){t.content.correct=r.attributes.value.value;for(var s=r.querySelectorAll("zone"),o=s.length,i=e.querySelector("content>links"),n=0;n<o;n++){var a={image:{},texte:{}};if(null!==s[n].querySelector("image")&&void 0!==s[n].querySelector("image").attributes.src){var h=s[n].querySelector("image").attributes.src.value,l=i.querySelector('[id="'+h+'"]').attributes.value.value;a.image.src=this.player.getMediaPath(l)}else a.image.src="";var d=s[n].querySelector("text");null!==d&&(a.texte.text=d.textContent),t.content.zones.push(a)}}else t.content.zones=void 0;var c=e.querySelector("design");if(null!==c&&void 0!==c){var u=this.parseXMLAttributes(c),p=c.querySelector("true_image");t.elfe.true_image=null!==p?this.parseXMLAttributes(p):"";var f=c.querySelector("false_image");t.elfe.false_image=null!==f?this.parseXMLAttributes(f):"";var m=c.querySelector("true_text");t.elfe.true_text=null!==m?this.parseXMLAttributes(m):"";var g=c.querySelector("false_text");t.elfe.false_text=null!==g?this.parseXMLAttributes(g):"",t.width=u.width,t.height=u.height,t.top=u.top,t.left=u.left}return t},init:function(e,s,o){if(this._super.apply(this,arguments),this.screenWidth=s,this.screenHeight=o,this.params=this.getParamsFromXML(e),this.eldar._showGood=!1,this.eldar._showBad=!1,this.eldar._showMissed=!1,this.answer,this.eldar.zones=[],this.eldar.zones_count=0,void 0!=this.params.content.zones){var i=this.params.content.zones.length;this.eldar.zones_count=i;for(var n=0;n<i;n++){var a=this.params.content.zones[n];this.eldar.zones[n]={};var h,l;if(void 0!=a.image&&""!=a.image.src&&void 0!=a.image.src){var d=0==n?this.params.elfe.true_image:this.params.elfe.false_image;l=$("<div />").css({width:d.width/100*this.params.width+"px",height:d.height/100*this.params.height+"px",left:d.left/100*this.params.width+"px",top:d.top/100*this.params.height+"px",position:"absolute"});var c=new r("image",{src:a.image.src,w:d.width/100*this.params.width,h:d.height/100*this.params.height,proportional:d.proportional,streched:d.streched,screenWidth:this.screenWidth,screenHeight:this.screenHeight}).getElement();$(c).load(t.relegate(this,this.loadImage,c)),l.append(c),$(c).data("id",n),$(this.eldar).append(l),this.eldar.zones[n].imageZone=l}if(void 0!=a.texte&&""!=a.texte.text&&void 0!=a.texte.text){var d=0==n?this.params.elfe.true_text:this.params.elfe.false_text;h=$("<div />").css({width:d.width/100*this.screenWidth+"px",left:d.left/100*this.screenWidth+"px",top:d.top/100*this.screenHeight+"px",height:d.height/100*this.screenHeight+"px",display:"block",position:"absolute",borderWidth:+d.border?"1px":"0px",borderStyle:"solid",borderColor:d.bordercolor,backgroundColor:+d.transparent?"":d.bgcolor,cursor:"pointer",overflow:"hidden",fontFamily:d.font,fontSize:d.fontsize+"px",textAlign:d.align,textDecoration:+d.underline?"underline":"none",fontStyle:+d.italic?"italic":"normal",color:d.fontcolor,fontWeight:+d.bold?"bold":"normal"}).html(a.texte.text),$(h).data("id",n),$(h).click(t.relegate(this,this.clickZone,$(h))),$(this.eldar).append(h),this.eldar.zones[n].textZone=h}var u=$("<div />");$(this.eldar).append(u),this.eldar.zones[n].borderZone=u}}$(this.eldar).data("refresh",this.eldar.refresh)},loadImage:function(e,r){$(e).css({cursor:"pointer"}),$(e).click(t.relegate(this,this.clickZone,$(e)))},clickZone:function(e){this.answer=Number(e.data("id")),"function"==typeof goNext&&goNext(),this.player.runCommand("GoNextPage")},showContent:function(){for(var e=this.eldar.zones_count,t=0;t<e;t++){var r=t==this.params.content.correct,s=0==t?this.params.elfe.true_text:this.params.elfe.false_text;if(r?this.eldar._showGood&&this.params.content.correct==this.answer||this.isCorrected?this.showBorderZone(t,s.goodcolor):$(this.eldar.zones[t].borderZone).css({borderWidth:"0px",width:"0px",height:"0px"}):this.eldar._showBad&&this.answer&&this.params.content.correct!=this.answer?this.showBorderZone(t,s.badcolor):$(this.eldar.zones[t].borderZone).css({borderWidth:"0px",width:"0px",height:"0px"}),void 0!=this.eldar.zones[t].textZone){var o=$(this.eldar.zones[t].textZone);r&&(this.eldar._showGood&&this.answer==t||this.isCorrected)?o.css("color",s.goodcolor):!r&&this.eldar._showBad&&this.answer==t?o.css("color",s.badcolor):o.css("color",s.fontcolor)}}},showBorderZone:function(e,r){if(void 0!=this.eldar.zones[e].imageZone){var s=window.getComputedStyle(this.eldar.zones[e].imageZone.get(0)),o=Math.round(t.removeCSSUnit(s.left)),i=Math.round(t.removeCSSUnit(s.top)),n=Math.round(+o+t.removeCSSUnit(s.width)),a=Math.round(+i+t.removeCSSUnit(s.height));if(void 0!=this.eldar.zones[e].textZone){var h=window.getComputedStyle(this.eldar.zones[e].textZone.get(0));o=Math.round(Math.min(o,t.removeCSSUnit(h.left))),i=Math.round(Math.min(i,t.removeCSSUnit(h.top))),n=Math.round(Math.max(n,+t.removeCSSUnit(h.left)+t.removeCSSUnit(h.width))),a=Math.round(Math.max(a,+t.removeCSSUnit(h.top)+t.removeCSSUnit(h.height)))}$(this.eldar.zones[e].borderZone).css({display:"block",left:o+"px",top:i+"px",width:n-o+"px",height:a-i+"px",position:"absolute",borderWidth:"3px",borderStyle:"solid",backgroundColor:"transparent",borderColor:r})}},getAnswer:function(){var e=void 0!=this.answer?this.answer:null,t={TrueFalse:e};return JSON.stringify(t)},setAnswer:function(e){this.tellEraseAnswer();try{e&&(this.answer=JSON.parse(e).TrueFalse||JSON.parse(e).truefalse)}catch(t){console.warn("TrueFalse.setAnswer - error : ",t)}},refresh:function(){$(this.eldar).show(),this.showContent()},getScore:function(){var e=0;return void 0!=this.params.content.zones&&(e=void 0!==this.answer&&this.params.content.correct==this.answer?100:0),e},getInteraction:function(){var e=this._super();return e.type="true-false",e},correct_response:function(){var e="1"==this.params.content.correct?"true":"false";return e},student_response:function(){var e=1==this.answer?"true":"false";return e},student_response_text:function(){var e="--";return void 0!=this.answer&&(e=Number(this.answer)+1),"Choix "+e},correct_response_text:function(){return"Choix "+(Number(this.params.content.correct)+1)},tellCorrectAnswer:function(){this._super(),this.answer=this.params.content.correct},tellEraseAnswer:function(){this.answer=null}})});