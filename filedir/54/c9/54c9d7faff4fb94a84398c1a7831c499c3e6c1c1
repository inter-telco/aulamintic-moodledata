var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};define(["ekhil/view/AEldar"],function(t){return t.extend({init:function(t,e,r){this._super.apply(this,arguments),this.params=this.getParamsFromXML(t),this.eldar._showGood=!1,this.eldar._showBad=!1,this.eldar._showMissed=!1,this.eldar._answer=new Array,this._generateId();for(var s=0,n=this.params.content.zones.length,i=0;i<n;i++){var a=this.params.content.zones[i],o={x:0,y:s,width:100,height:100};void 0!=a.left&&(o.x=a.left),void 0!=a.top&&(o.y=a.top),void 0!=a.width&&(o.width=a.width),void 0!=a.height&&(o.height=a.height),$(this.eldar).append(this._create_field(a.id,o)),void 0!=a.top&&void 0!=a.height||(s+=o.height)}this._getAnswer(),$(this.eldar).data("refresh",this.refresh)},getParamsFromXML:function(t){for(var e=t.querySelector("content"),r=e.querySelector("zones"),s=r.querySelectorAll("zone"),n=s.length,i=[],a=0;a<n;a++){var o=s[a];i.push(this.parseXMLAttributes(o))}var h=void 0!==r.attributes.cursor&&!!+r.attributes.cursor.value,l=void 0!==r.attributes.enterkey&&!!+r.attributes.enterkey.value,d=t.querySelector("design"),c=this.parseXMLAttributes(d);return{content:{cursor:h,enterkey:l,zones:i},elfe:c,left:+c.left,top:+c.top,width:+c.width,height:+c.height}},showContent:function(){this._refreshAnswer(),$(this.eldar).find("input").css({color:this.params.elfe.fontcolor});for(var t=this.params.content.zones.length,e=0;e<t;e++){var r=this.params.content.zones[e].id;if(this.eldar._showBad&&!this._is_correct(this.eldar._answer[r],this.params.content.zones[e])&&!this.isCorrected){$(this.eldar).find("input").eq(e);$(this.eldar).find("input").eq(e).css({color:this.params.elfe.badcolor})}if(this.eldar._showGood&&this._is_correct(this.eldar._answer[r],this.params.content.zones[e])&&!this.isCorrected){$(this.eldar).find("input").eq(e);$(this.eldar).find("input").eq(e).css({color:this.params.elfe.goodcolor})}}},getAnswer:function(){for(var t={},e=this.params.content.zones.length,r=0;r<e;r++){var s=this.params.content.zones[r].id;t[s]=this.eldar._answer[s]}return JSON.stringify(t)},setAnswer:function(t){this.tellEraseAnswer();try{for(var e=JSON.parse(t),r=this.params.content.zones.length,s=0;s<r;s++){var n=this.params.content.zones[s].id;this.setField(n,e[n])}}catch(i){}},_is_correct:function(t,e){return""!=t&&(t=Number(t),void 0!=t&&(t>=Number(e.min)&&t<=Number(e.max)))},getScore:function(){for(var t=0,e=0,r=this.params.content.zones.length,s=0;s<r;s++){var n=this.params.content.zones[s].id;this._is_correct(this.eldar._answer[n],this.params.content.zones[s])&&t++}return 0!=r&&(e=Math.round(t/r*100)),e>100&&(e=100),e},getInteraction:function(){return this._super()},correct_response:function(){var t=this.correct_response_text();return t.substring(0,4e3)},student_response:function(){var t=this.student_response_text();return t.substring(0,4e3)},student_response_text:function(){for(var t=new Array,e=this.eldar._answer.length,r=0;r<e;r++)""!=this.eldar._answer[r]&&t.push(this.eldar._answer[r]);return t.join(String.fromCharCode(13))},correct_response_text:function(){for(var t=new Array,e=this.params.content.zones.length,r=0;r<e;r++)t.push(this.params.content.zones[r].min);return t.join(String.fromCharCode(13))},_create_field:function(t,e){var r=this,s=$("<input >").css({position:"absolute",top:e.y+"%",left:e.x+"%",width:e.width+"%",height:e.height+"%",borderWidth:+this.params.elfe.border?"1px":"0px",borderStyle:"solid",borderColor:this.params.elfe.bordercolor,fontFamily:this.params.elfe.font,color:this.params.elfe.fontcolor,fontStyle:+this.params.elfe.italic?"italic":"normal",fontSize:this.params.elfe.fontsize+"px",fontWeight:+this.params.elfe.bold?"bold":"normal",textDecoration:+this.params.elfe.underline?"underline":"none",textAlign:this.params.elfe.align,backgroundColor:+this.params.elfe.transparent?"transparent":this.params.elfe.bgcolor});if($(s).data("id",t),+this.params.elfe.autosize){var n=e.height/100*this.params.height;s.css("fontSize",n-10+"px")}return this.player.container.addInputListeners(s),this.params.content.enterkey&&$(s).keydown(function(t){13===t.keyCode&&new require("ekhil/EkhilPlayer")().runCommand("Execute","validatepage")}),$(s).on("keyup",function(){r.setField($(this).data("id"),$(this).val())}),s},setField:function(t,e){e=this._clean_field(e),this.eldar._answer[t]=e;for(var r=$(this.eldar).find("input"),s=r.length,n=!1,i=0;i<s&&!n;)n=$(r[i]).data("id")==t,n&&$(r[i]).val(e),i++},_getAnswer:function(){for(var t=$(this.eldar).find("input"),e=t.length,r=0;r<e;r++)this.eldar._answer[$(t[r]).data("id")]=$(t[r]).val()},_onChange:function(){this._getAnswer()},refresh:function(){$(this.eldar).show(),this.showContent(),this.setFocus()},setFocus:function(){this.params.content.cursor&&$(this.eldar).find("input:first").focus()},_refreshAnswer:function(){for(var t=$(this.eldar).find("input"),e=t.length,r=0;r<e;r++){var s=$(t[r]).data("id");void 0!=_typeof(this.eldar._answer[s])&&this.setField(s,this.eldar._answer[s])}},_clean_field:function(t){return t=t.replace(/,/g,"."),t=t.replace(/[^0-9-.]/g,"")},_generateId:function(){for(var t=this.params.content.zones.length,e=0;e<t;e++)this.params.content.zones[e].id=e},tellCorrectAnswer:function(){this._super();for(var t=this.params.content.zones.length,e=0;e<t;e++){var r=this.params.content.zones[e].id;this._is_correct(this.eldar._answer[r],this.params.content.zones[e])||(this.eldar._answer[r]=this.params.content.zones[e].min)}},tellEraseAnswer:function(){this.eldar._answer=[];for(var t=this.params.content.zones.length,e=0;e<t;e++){var r=this.params.content.zones[e].id;this.eldar._answer[r]=""}},tellEraseBadAnswer:function(){for(var t=this.params.content.zones.length,e=0;e<t;e++){var r=this.params.content.zones[e].id;this._is_correct(this.eldar._answer[r],this.params.content.zones[e])||(this.eldar._answer[r]="")}}})});